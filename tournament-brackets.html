<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament Brackets | EArena Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root {
--bg: #0f0f10;
--panel: #1f1f20;
--muted: #9aa0a6;
--copy: #e6e6e6;
--accent: #FFD700;
--accent-2: #e0ac10;
--radius: 12px;
--border-color: rgba(255, 255, 255, 0.1);
--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
margin: 0;
font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
background: var(--bg);
color: var(--copy);
line-height: 1.5;
min-height: 100vh;
}

.site-header {
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 1000;
background: rgba(15, 15, 16, 0.8);
backdrop-filter: blur(20px);
border-bottom: 1px solid var(--border-color);
height: 64px;
display: flex;
align-items: center;
justify-content: space-between;
padding: 0 24px;
}

.header-left {
display: flex;
align-items: center;
gap: 24px;
}

.back-link {
color: var(--muted);
text-decoration: none;
font-weight: 500;
display: flex;
align-items: center;
gap: 8px;
transition: color 0.2s ease;
}

.back-link:hover {
color: var(--accent);
}

.user-menu {
display: flex;
align-items: center;
gap: 1rem;
}

.user-info {
display: flex;
align-items: center;
gap: 0.5rem;
color: var(--copy);
font-weight: 500;
}

.logout-btn {
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
color: var(--copy);
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s ease;
font-weight: 500;
font-size: 14px;
}

.logout-btn:hover {
background: rgba(255, 0, 0, 0.1);
border-color: rgba(255, 0, 0, 0.3);
color: #ff6b6b;
}

.main-content {
margin-top: 64px;
padding: 32px 24px;
max-width: 1600px;
margin-left: auto;
margin-right: auto;
}

.page-header {
margin-bottom: 2rem;
}

.page-title {
font-size: 2rem;
font-weight: 800;
margin-bottom: 0.5rem;
}

.page-subtitle {
color: var(--muted);
font-size: 1.1rem;
}

.tournament-overview {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.overview-card {
background: var(--panel);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 1.5rem;
}

.overview-card h3 {
font-size: 1.1rem;
font-weight: 700;
margin-bottom: 1rem;
color: var(--accent);
}

.stat-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 1rem;
}

.stat-item {
text-align: center;
}

.stat-value {
font-size: 1.5rem;
font-weight: 800;
color: var(--copy);
display: block;
}

.stat-label {
font-size: 0.85rem;
color: var(--muted);
}

.rounds-container {
display: flex;
flex-direction: column;
gap: 2rem;
}

.round-section {
background: var(--panel);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 2rem;
}

.round-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
}

.round-title {
font-size: 1.5rem;
font-weight: 700;
color: var(--copy);
}

.round-status {
padding: 0.5rem 1rem;
border-radius: 20px;
font-size: 0.85rem;
font-weight: 600;
}

.status-pending {
background: rgba(156, 163, 175, 0.2);
color: #9ca3af;
}

.status-active {
background: rgba(16, 185, 129, 0.2);
color: var(--success);
}

.status-completed {
background: rgba(245, 158, 11, 0.2);
color: var(--warning);
}

.round-info {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
margin-bottom: 1.5rem;
}

.info-item {
background: rgba(0, 0, 0, 0.2);
padding: 1rem;
border-radius: 8px;
text-align: center;
}

.info-value {
font-size: 1.2rem;
font-weight: 700;
color: var(--accent);
display: block;
}

.info-label {
font-size: 0.85rem;
color: var(--muted);
margin-top: 0.25rem;
}

.teams-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 1rem;
}

.team-card {
background: rgba(0, 0, 0, 0.2);
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 1rem;
transition: all 0.3s ease;
}

.team-card:hover {
border-color: var(--accent);
transform: translateY(-2px);
}

.team-card.qualified {
border-color: var(--success);
background: rgba(16, 185, 129, 0.1);
}

.team-card.eliminated {
border-color: var(--danger);
background: rgba(239, 68, 68, 0.1);
opacity: 0.7;
}

.team-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.75rem;
}

.team-name {
font-weight: 600;
color: var(--copy);
}

.team-status {
padding: 0.25rem 0.5rem;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 600;
}

.status-registered {
background: rgba(59, 130, 246, 0.2);
color: #3b82f6;
}

.status-paid {
background: rgba(16, 185, 129, 0.2);
color: var(--success);
}

.status-qualified {
background: rgba(245, 158, 11, 0.2);
color: var(--warning);
}

.status-eliminated {
background: rgba(239, 68, 68, 0.2);
color: var(--danger);
}

.team-details {
font-size: 0.85rem;
color: var(--muted);
}

.team-actions {
display: flex;
gap: 0.5rem;
margin-top: 0.75rem;
}

.btn {
padding: 0.5rem 1rem;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
border: none;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
text-align: center;
font-size: 0.85rem;
}

.btn:hover {
transform: translateY(-1px);
}

.btn-primary {
background: linear-gradient(135deg, var(--accent), var(--accent-2));
color: #000;
}

.btn-primary:hover {
background: linear-gradient(135deg, var(--accent-2), var(--accent));
}

.btn-success {
background: var(--success);
color: white;
}

.btn-success:hover {
background: #059669;
}

.btn-danger {
background: var(--danger);
color: white;
}

.btn-danger:hover {
background: #dc2626;
}

.btn-secondary {
background: rgba(255, 255, 255, 0.1);
color: var(--copy);
border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

.round-actions {
display: flex;
gap: 1rem;
flex-wrap: wrap;
}

.payment-info {
background: rgba(245, 158, 11, 0.1);
border: 1px solid rgba(245, 158, 11, 0.3);
border-radius: 8px;
padding: 1rem;
margin-bottom: 1.5rem;
}

.payment-info h4 {
color: var(--warning);
margin-bottom: 0.5rem;
}

.payment-info p {
color: var(--muted);
font-size: 0.9rem;
}

.loading-state {
text-align: center;
padding: 3rem;
color: var(--muted);
}

.empty-state {
text-align: center;
padding: 3rem;
color: var(--muted);
}

/* Modal Styles */
.modal {
display: none;
position: fixed;
z-index: 2000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
backdrop-filter: blur(5px);
}

.modal.active {
display: flex;
align-items: center;
justify-content: center;
}

.modal-content {
background: var(--panel);
border-radius: var(--radius);
padding: 2rem;
max-width: 500px;
width: 90%;
border: 1px solid var(--border-color);
max-height: 90vh;
overflow-y: auto;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
}

.modal-title {
font-size: 1.5rem;
font-weight: 700;
}

.close-modal {
background: none;
border: none;
color: var(--muted);
font-size: 1.5rem;
cursor: pointer;
}

.close-modal:hover {
color: var(--copy);
}

.modal-buttons {
display: flex;
gap: 1rem;
margin-top: 1.5rem;
}

.modal-buttons .btn {
flex: 1;
}

/* Enhanced Team Display Styles */
.round-teams-section {
margin-top: 1.5rem;
}

.teams-summary {
display: flex;
justify-content: space-between;
align-items: center;
padding: 1rem;
background: rgba(0, 0, 0, 0.2);
border-radius: 8px;
margin-bottom: 1rem;
}

.summary-stats {
display: flex;
gap: 2rem;
}

.summary-stats span {
color: var(--muted);
font-size: 0.9rem;
}

.teams-actions {
display: flex;
gap: 0.5rem;
}

.teams-preview h4 {
color: var(--accent);
margin-bottom: 1rem;
}

.teams-list {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.team-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 1rem;
background: rgba(255, 255, 255, 0.05);
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
border: 1px solid transparent;
}

.team-item:hover {
background: rgba(255, 255, 255, 0.1);
border-color: var(--accent);
transform: translateX(4px);
}

.team-info {
flex: 1;
}

.team-name {
font-weight: 600;
color: var(--copy);
display: block;
margin-bottom: 0.5rem;
}

.team-meta {
display: flex;
gap: 0.5rem;
align-items: center;
}

.status-badge {
padding: 0.25rem 0.5rem;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 600;
text-transform: uppercase;
}

.status-badge.status-paid {
background: rgba(16, 185, 129, 0.2);
color: var(--success);
}

.status-badge.status-pending {
background: rgba(245, 158, 11, 0.2);
color: var(--warning);
}

.status-badge.status-qualified {
background: rgba(16, 185, 129, 0.2);
color: var(--success);
}

.status-badge.status-eliminated {
background: rgba(239, 68, 68, 0.2);
color: var(--danger);
}

.status-badge.status-registered {
background: rgba(59, 130, 246, 0.2);
color: #3b82f6;
}

.score {
color: var(--accent);
font-weight: 600;
font-size: 0.85rem;
}

.show-more {
display: flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
padding: 1rem;
background: rgba(255, 215, 0, 0.1);
border: 1px dashed rgba(255, 215, 0, 0.3);
border-radius: 8px;
cursor: pointer;
color: var(--accent);
font-weight: 600;
transition: all 0.3s ease;
}

.show-more:hover {
background: rgba(255, 215, 0, 0.2);
border-color: var(--accent);
}

/* All Teams Modal Styles */
.all-teams-modal .modal-content {
max-width: 1000px;
max-height: 80vh;
}

.teams-grid-modal {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 1rem;
max-height: 60vh;
overflow-y: auto;
padding: 1rem 0;
}

.team-card-modal {
background: rgba(0, 0, 0, 0.2);
border: 1px solid var(--border-color);
border-radius: 8px;
padding: 1rem;
cursor: pointer;
transition: all 0.3s ease;
}

.team-card-modal:hover {
border-color: var(--accent);
transform: translateY(-2px);
}

.team-card-modal.qualified {
border-color: var(--success);
background: rgba(16, 185, 129, 0.1);
}

.team-card-modal.eliminated {
border-color: var(--danger);
background: rgba(239, 68, 68, 0.1);
opacity: 0.7;
}

/* Team Detail Modal Styles */
.team-detail-modal .modal-content {
max-width: 600px;
}

.team-header-modal {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 1px solid var(--border-color);
}

.team-name-modal {
font-size: 1.5rem;
font-weight: 700;
color: var(--copy);
}

.team-status-modal {
display: flex;
gap: 0.5rem;
}

.team-stats {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 1rem;
margin-bottom: 1.5rem;
}

.stat-card {
background: rgba(0, 0, 0, 0.2);
padding: 1rem;
border-radius: 8px;
text-align: center;
}

.stat-value {
font-size: 1.2rem;
font-weight: 700;
color: var(--accent);
display: block;
}

.stat-label {
font-size: 0.8rem;
color: var(--muted);
margin-top: 0.25rem;
}

.players-section {
margin-bottom: 1.5rem;
}

.players-section h4 {
color: var(--accent);
margin-bottom: 1rem;
}

.player-list {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.player-card {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.75rem;
background: rgba(255, 255, 255, 0.05);
border-radius: 6px;
}

.player-info {
flex: 1;
}

.player-name {
font-weight: 600;
color: var(--copy);
}

.player-details {
font-size: 0.85rem;
color: var(--muted);
margin-top: 0.25rem;
}

.captain-badge {
background: var(--accent);
color: #000;
padding: 0.25rem 0.5rem;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 700;
}

/* Export Options */
.export-options {
display: flex;
gap: 1rem;
margin-top: 1rem;
}

.export-btn {
flex: 1;
}

@media (max-width: 768px) {
.teams-grid {
grid-template-columns: 1fr;
}

.round-info {
grid-template-columns: 1fr;
}

.tournament-overview {
grid-template-columns: 1fr;
}

.round-actions {
flex-direction: column;
}

.teams-summary {
flex-direction: column;
gap: 1rem;
}

.summary-stats {
flex-direction: column;
gap: 0.5rem;
text-align: center;
}

.teams-actions {
width: 100%;
}

.teams-grid-modal {
grid-template-columns: 1fr;
}

.team-stats {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<header class="site-header">
<div class="header-left">
<a href="td.html" class="back-link" id="back-to-tournament">
<i class="fas fa-arrow-left"></i>
<span>Back to Tournament</span>
</a>
</div>
<div class="user-menu">
<div class="user-info">
<span id="admin-username">Admin</span>
</div>
<button class="logout-btn" onclick="logout()">
<i class="fas fa-sign-out-alt"></i> Logout
</button>
</div>
</header>

<main class="main-content">
<div class="page-header">
<h1 class="page-title" id="tournament-title">Tournament Brackets</h1>
<p class="page-subtitle" id="tournament-subtitle">Manage rounds, teams, and progression</p>
</div>

<div class="tournament-overview">
<div class="overview-card">
<h3><i class="fas fa-users"></i> Tournament Stats</h3>
<div class="stat-grid">
<div class="stat-item">
<span class="stat-value" id="total-teams">0</span>
<span class="stat-label">Total Teams</span>
</div>
<div class="stat-item">
<span class="stat-value" id="active-teams">0</span>
<span class="stat-label">Active Teams</span>
</div>
</div>
</div>

<div class="overview-card">
<h3><i class="fas fa-trophy"></i> Prize Pool</h3>
<div class="stat-grid">
<div class="stat-item">
<span class="stat-value" id="total-prize">₹0</span>
<span class="stat-label">Total Prize</span>
</div>
<div class="stat-item">
<span class="stat-value" id="collected-fees">₹0</span>
<span class="stat-label">Collected Fees</span>
</div>
</div>
</div>

<div class="overview-card">
<h3><i class="fas fa-calendar"></i> Current Round</h3>
<div class="stat-grid">
<div class="stat-item">
<span class="stat-value" id="current-round">1</span>
<span class="stat-label">Round</span>
</div>
<div class="stat-item">
<span class="stat-value" id="round-status">Pending</span>
<span class="stat-label">Status</span>
</div>
</div>
</div>
</div>

<div class="rounds-container" id="rounds-container">
<div class="loading-state">
<i class="fas fa-spinner fa-spin"></i> Loading tournament brackets...
</div>
</div>
</main>

<!-- Round Management Modal -->
<div id="round-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="round-modal-title">Manage Round</h3>
<button class="close-modal">&times;</button>
</div>
<div id="round-modal-content">
<!-- Content will be populated by JavaScript -->
</div>
</div>
</div>

<!-- Team Management Modal -->
<div id="team-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="team-modal-title">Team Details</h3>
<button class="close-modal">&times;</button>
</div>
<div id="team-modal-content">
<!-- Content will be populated by JavaScript -->
</div>
</div>
</div>

<!-- All Teams Modal -->
<div id="all-teams-modal" class="modal all-teams-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="all-teams-modal-title">All Teams</h3>
<button class="close-modal">&times;</button>
</div>
<div id="all-teams-content">
<!-- Content will be populated by JavaScript -->
</div>
</div>
</div>

<!-- Team Detail Modal -->
<div id="team-detail-modal" class="modal team-detail-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="team-detail-modal-title">Team Details</h3>
<button class="close-modal">&times;</button>
</div>
<div id="team-detail-content">
<!-- Content will be populated by JavaScript -->
</div>
</div>
</div>

<script>
// Auto-detect API URL based on environment
const isLocal = window.location.hostname === 'localhost' || 
               window.location.hostname === '127.0.0.1' || 
               window.location.protocol === 'file:';

const API_BASE_URL = isLocal ? 'http://localhost:8000' : 'https://tournament-hosting-backend.onrender.com';
let currentTournament = null;
let tournamentBrackets = null;

// Round configuration
const ROUND_CONFIG = {
1: { name: 'Round 1', teamsPerGroup: 25, qualifyingTeams: 4, entryFee: 100 },
2: { name: 'Round 2', teamsPerGroup: 25, qualifyingTeams: 4, entryFee: 200 },
3: { name: 'Round 3', teamsPerGroup: 25, qualifyingTeams: 4, entryFee: 300 },
4: { name: 'Round 4', teamsPerGroup: 25, qualifyingTeams: 4, entryFee: 500 },
final: { name: 'Finals', teamsPerGroup: 16, qualifyingTeams: 1, entryFee: 0 }
};

// --- AUTHENTICATION & USER INFO ---
function getSessionData() {
const session = localStorage.getItem('earena_session') || sessionStorage.getItem('earena_session');
try {
return JSON.parse(session);
} catch (error) {
return null;
}
}

function logout() {
localStorage.removeItem('earena_session');
sessionStorage.removeItem('earena_session');
window.location.href = 'auth.html';
}

// --- TOURNAMENT BRACKETS MANAGEMENT ---
async function loadTournamentBrackets() {
const urlParams = new URLSearchParams(window.location.search);
const tournamentId = urlParams.get('id');
const tournamentSlug = urlParams.get('slug');

if (!tournamentId && !tournamentSlug) {
document.getElementById('rounds-container').innerHTML = 
'<div class="empty-state">No tournament specified. Please provide a tournament ID or slug.</div>';
return;
}

const sessionData = getSessionData();
if (!sessionData || !sessionData.token) {
window.location.href = 'auth.html';
return;
}

try {
// Load tournament data
const tournamentEndpoint = tournamentId ? 
`${API_BASE_URL}/api/tournaments/${tournamentId}` : 
`${API_BASE_URL}/api/tournaments/slug/${tournamentSlug}`;

const tournamentResponse = await fetch(tournamentEndpoint, {
headers: { 'Authorization': `Bearer ${sessionData.token}` }
});

if (!tournamentResponse.ok) {
throw new Error('Failed to load tournament data');
}

const tournamentData = await tournamentResponse.json();
currentTournament = tournamentData.data;

// Update page header
document.getElementById('tournament-title').textContent = `${currentTournament.title} - Brackets`;
document.getElementById('tournament-subtitle').textContent = `Manage rounds and team progression for ${currentTournament.game}`;

// Update back link
const backLink = document.getElementById('back-to-tournament');
backLink.href = `td.html?slug=${currentTournament.slug}`;

// Load or initialize brackets
await loadOrInitializeBrackets();

} catch (error) {
console.error('Error loading tournament brackets:', error);
document.getElementById('rounds-container').innerHTML = 
`<div class="empty-state">Error loading tournament: ${error.message}</div>`;
}
}

async function loadOrInitializeBrackets() {
const sessionData = getSessionData();

try {
// Try to load existing brackets
const bracketsResponse = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets`, {
headers: { 'Authorization': `Bearer ${sessionData.token}` }
});

if (bracketsResponse.ok) {
const bracketsData = await bracketsResponse.json();
tournamentBrackets = bracketsData.data;
} else if (bracketsResponse.status === 404) {
// Initialize brackets if they don't exist
await initializeBrackets();
} else {
throw new Error('Failed to load brackets');
}

updateBracketsDisplay();

} catch (error) {
console.error('Error loading brackets:', error);
// Initialize brackets as fallback
await initializeBrackets();
}
}

async function initializeBrackets() {
const sessionData = getSessionData();
const teams = currentTournament.participants || [];

// Create initial bracket structure
const brackets = {
tournamentId: currentTournament._id,
totalTeams: teams.length,
currentRound: 1,
rounds: {
1: { status: 'pending', teams: [], groups: [] },
2: { status: 'pending', teams: [], groups: [] },
3: { status: 'pending', teams: [], groups: [] },
4: { status: 'pending', teams: [], groups: [] },
final: { status: 'pending', teams: [], groups: [] }
},
payments: {},
results: {}
};

// Assign teams to Round 1
brackets.rounds[1].teams = teams.map(team => ({
teamId: team._id,
teamName: team.name,
status: 'registered',
paymentStatus: 'pending',
score: 0,
position: null
}));

// Create groups for Round 1 (4 groups of 25 teams each)
const shuffledTeams = [...brackets.rounds[1].teams].sort(() => Math.random() - 0.5);
for (let i = 0; i < 4; i++) {
const groupTeams = shuffledTeams.slice(i * 25, (i + 1) * 25);
brackets.rounds[1].groups.push({
groupId: i + 1,
teams: groupTeams,
status: 'pending'
});
}

try {
// Save brackets to server
const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
},
body: JSON.stringify(brackets)
});

if (!response.ok) {
throw new Error('Failed to initialize brackets');
}

const savedBrackets = await response.json();
tournamentBrackets = savedBrackets.data;

} catch (error) {
console.error('Error initializing brackets:', error);
// Use local brackets as fallback
tournamentBrackets = brackets;
}
}

function updateBracketsDisplay() {
// Update overview stats
document.getElementById('total-teams').textContent = tournamentBrackets.totalTeams;
document.getElementById('current-round').textContent = tournamentBrackets.currentRound;
document.getElementById('round-status').textContent = getCurrentRoundStatus();

// Calculate active teams and fees
const activeTeams = calculateActiveTeams();
const collectedFees = calculateCollectedFees();

document.getElementById('active-teams').textContent = activeTeams;
document.getElementById('total-prize').textContent = `₹${(currentTournament.prizePool || 0).toLocaleString()}`;
document.getElementById('collected-fees').textContent = `₹${collectedFees.toLocaleString()}`;

// Render rounds
renderRounds();
}

function getCurrentRoundStatus() {
const currentRound = tournamentBrackets.currentRound;
if (currentRound === 'final') {
return tournamentBrackets.rounds.final.status.charAt(0).toUpperCase() + 
tournamentBrackets.rounds.final.status.slice(1);
}
return tournamentBrackets.rounds[currentRound].status.charAt(0).toUpperCase() + 
tournamentBrackets.rounds[currentRound].status.slice(1);
}

function calculateActiveTeams() {
const currentRound = tournamentBrackets.currentRound;
if (currentRound === 'final') {
return tournamentBrackets.rounds.final.teams.length;
}
return tournamentBrackets.rounds[currentRound].teams.filter(team => 
team.status !== 'eliminated'
).length;
}

function calculateCollectedFees() {
let total = 0;
Object.keys(tournamentBrackets.rounds).forEach(roundKey => {
const round = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];
if (config && round.teams) {
const paidTeams = round.teams.filter(team => team.paymentStatus === 'paid');
total += paidTeams.length * config.entryFee;
}
});
return total;
}

function renderRounds() {
const container = document.getElementById('rounds-container');
const rounds = Object.keys(ROUND_CONFIG);

container.innerHTML = rounds.map(roundKey => {
const config = ROUND_CONFIG[roundKey];
const roundData = tournamentBrackets.rounds[roundKey];
const isActive = tournamentBrackets.currentRound === roundKey;

return `
<div class="round-section">
<div class="round-header">
<h2 class="round-title">${config.name}</h2>
<span class="round-status status-${roundData.status}">
${roundData.status.charAt(0).toUpperCase() + roundData.status.slice(1)}
</span>
</div>

${roundKey !== 'final' ? `
<div class="payment-info">
<h4><i class="fas fa-credit-card"></i> Entry Fee: ₹${config.entryFee}</h4>
<p>Teams must pay ₹${config.entryFee} to participate in this round. Top ${config.qualifyingTeams} teams from each group advance.</p>
</div>
` : ''}

<div class="round-info">
<div class="info-item">
<span class="info-value">${roundData.teams.length}</span>
<span class="info-label">Teams</span>
</div>
<div class="info-item">
<span class="info-value">${roundData.groups ? roundData.groups.length : 1}</span>
<span class="info-label">Groups</span>
</div>
<div class="info-item">
<span class="info-value">${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</span>
<span class="info-label">Paid</span>
</div>
<div class="info-item">
<span class="info-value">${roundData.teams.filter(t => t.status === 'qualified').length}</span>
<span class="info-label">Qualified</span>
</div>
</div>

<div class="round-actions">
${isActive ? `
<button class="btn btn-primary" onclick="startRound('${roundKey}')">
<i class="fas fa-play"></i> Start Round
</button>
` : ''}
${roundData.status === 'active' ? `
<button class="btn btn-success" onclick="completeRound('${roundKey}')">
<i class="fas fa-check"></i> Complete Round
</button>
` : ''}
<button class="btn btn-secondary" onclick="viewRoundDetails('${roundKey}')">
<i class="fas fa-eye"></i> View Details
</button>
<button class="btn btn-secondary" onclick="managePayments('${roundKey}')">
<i class="fas fa-credit-card"></i> Manage Payments
</button>
</div>

${renderRoundTeams(roundKey, roundData)}
</div>
`;
}).join('');
}

function renderRoundTeams(roundKey, roundData) {
if (!roundData.teams || roundData.teams.length === 0) {
return '<div class="empty-state">No teams in this round yet.</div>';
}

return `
<div class="round-teams-section">
<div class="teams-summary">
<div class="summary-stats">
<span><strong>${roundData.teams.length}</strong> teams registered</span>
<span><strong>${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</strong> paid</span>
<span><strong>${roundData.teams.filter(t => t.status === 'qualified').length}</strong> qualified</span>
</div>
<div class="teams-actions">
<button class="btn btn-secondary" onclick="showAllTeams('${roundKey}')">
<i class="fas fa-users"></i> View All Teams
</button>
<button class="btn btn-primary" onclick="exportRoundData('${roundKey}')">
<i class="fas fa-download"></i> Export
</button>
</div>
</div>

<div class="teams-preview">
<h4 style="margin-bottom: 1rem; color: var(--accent);">Teams in ${ROUND_CONFIG[roundKey].name}</h4>
<div class="teams-list">
${roundData.teams.slice(0, 8).map(team => `
<div class="team-item" onclick="showTeamModal('${team.teamId}', '${roundKey}')">
<div class="team-info">
<span class="team-name">${team.teamName}</span>
<div class="team-meta">
<span class="status-badge status-${team.paymentStatus}">${team.paymentStatus}</span>
<span class="status-badge status-${team.status}">${team.status}</span>
${team.score ? `<span class="score">Score: ${team.score}</span>` : ''}
</div>
</div>
<i class="fas fa-chevron-right"></i>
</div>
`).join('')}
${roundData.teams.length > 8 ? `
<div class="show-more" onclick="showAllTeams('${roundKey}')">
<i class="fas fa-plus"></i> Show ${roundData.teams.length - 8} more teams
</div>
` : ''}
</div>
</div>
</div>
`;
}

// --- ROUND MANAGEMENT FUNCTIONS ---
async function startRound(roundKey) {
if (!confirm(`Are you sure you want to start ${ROUND_CONFIG[roundKey].name}?`)) return;

const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets/round/${roundKey}/start`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
}
});

if (!response.ok) throw new Error('Failed to start round');

// Update local data
tournamentBrackets.rounds[roundKey].status = 'active';
updateBracketsDisplay();

alert(`${ROUND_CONFIG[roundKey].name} has been started!`);

} catch (error) {
console.error('Error starting round:', error);
alert(`Failed to start round: ${error.message}`);
}
}

async function completeRound(roundKey) {
if (!confirm(`Are you sure you want to complete ${ROUND_CONFIG[roundKey].name}? This will advance qualifying teams to the next round.`)) return;

const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets/round/${roundKey}/complete`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
}
});

if (!response.ok) throw new Error('Failed to complete round');

const result = await response.json();
tournamentBrackets = result.data;

updateBracketsDisplay();
alert(`${ROUND_CONFIG[roundKey].name} has been completed! Qualifying teams have been advanced.`);

} catch (error) {
console.error('Error completing round:', error);
alert(`Failed to complete round: ${error.message}`);
}
}

async function markPaid(teamId, roundKey) {
const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets/payment`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
},
body: JSON.stringify({
teamId: teamId,
roundKey: roundKey,
amount: ROUND_CONFIG[roundKey].entryFee,
status: 'paid'
})
});

if (!response.ok) throw new Error('Failed to mark payment');

// Update local data
const team = tournamentBrackets.rounds[roundKey].teams.find(t => t.teamId === teamId);
if (team) {
team.paymentStatus = 'paid';
}

updateBracketsDisplay();
alert('Payment marked as completed!');

} catch (error) {
console.error('Error marking payment:', error);
alert(`Failed to mark payment: ${error.message}`);
}
}

function viewRoundDetails(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];

document.getElementById('round-modal-title').textContent = `${config.name} Details`;
document.getElementById('round-modal-content').innerHTML = `
<div style="margin-bottom: 1.5rem;">
<h4>Round Information</h4>
<p><strong>Status:</strong> ${roundData.status}</p>
<p><strong>Total Teams:</strong> ${roundData.teams.length}</p>
<p><strong>Entry Fee:</strong> ₹${config.entryFee}</p>
<p><strong>Qualifying Teams:</strong> ${config.qualifyingTeams} per group</p>
</div>

<div style="margin-bottom: 1.5rem;">
<h4>Payment Status</h4>
<p><strong>Paid:</strong> ${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</p>
<p><strong>Pending:</strong> ${roundData.teams.filter(t => t.paymentStatus === 'pending').length}</p>
<p><strong>Total Collected:</strong> ₹${(roundData.teams.filter(t => t.paymentStatus === 'paid').length * config.entryFee).toLocaleString()}</p>
</div>

<div class="teams-grid" style="max-height: 400px; overflow-y: auto;">
${roundData.teams.map(team => `
<div class="team-card ${team.status}" style="margin-bottom: 0.5rem;">
<div class="team-header">
<span class="team-name">${team.teamName}</span>
<span class="team-status status-${team.paymentStatus}">${team.paymentStatus}</span>
</div>
<div class="team-details">
Status: ${team.status} | Score: ${team.score || 0}
${team.position ? `| Position: ${team.position}` : ''}
</div>
</div>
`).join('')}
</div>

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
</div>
`;

document.getElementById('round-modal').classList.add('active');
}

function managePayments(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];
const pendingPayments = roundData.teams.filter(t => t.paymentStatus === 'pending');

document.getElementById('round-modal-title').textContent = `Manage Payments - ${config.name}`;
document.getElementById('round-modal-content').innerHTML = `
<div style="margin-bottom: 1.5rem;">
<h4>Payment Overview</h4>
<p><strong>Entry Fee:</strong> ₹${config.entryFee} per team</p>
<p><strong>Pending Payments:</strong> ${pendingPayments.length} teams</p>
<p><strong>Potential Revenue:</strong> ₹${(pendingPayments.length * config.entryFee).toLocaleString()}</p>
</div>

${pendingPayments.length > 0 ? `
<div style="margin-bottom: 1.5rem;">
<h4>Pending Payments</h4>
<div style="max-height: 300px; overflow-y: auto;">
${pendingPayments.map(team => `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
<div>
<strong>${team.teamName}</strong><br>
<small style="color: var(--muted);">Amount: ₹${config.entryFee}</small>
</div>
<button class="btn btn-success" onclick="markPaid('${team.teamId}', '${roundKey}'); document.getElementById('round-modal').classList.remove('active');">
<i class="fas fa-check"></i> Mark Paid
</button>
</div>
`).join('')}
</div>

<div style="margin-top: 1rem;">
<button class="btn btn-primary" onclick="markAllPaid('${roundKey}')">
<i class="fas fa-check-double"></i> Mark All as Paid
</button>
</div>
</div>
` : '<p style="text-align: center; color: var(--muted);">All payments completed!</p>'}

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
</div>
`;

document.getElementById('round-modal').classList.add('active');
}

async function markAllPaid(roundKey) {
if (!confirm('Are you sure you want to mark all pending payments as paid?')) return;

const sessionData = getSessionData();
const roundData = tournamentBrackets.rounds[roundKey];
const pendingTeams = roundData.teams.filter(t => t.paymentStatus === 'pending');

try {
for (const team of pendingTeams) {
await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/brackets/payment`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
},
body: JSON.stringify({
teamId: team.teamId,
roundKey: roundKey,
amount: ROUND_CONFIG[roundKey].entryFee,
status: 'paid'
})
});

team.paymentStatus = 'paid';
}

updateBracketsDisplay();
document.getElementById('round-modal').classList.remove('active');
alert('All payments marked as completed!');

} catch (error) {
console.error('Error marking all payments:', error);
alert(`Failed to mark all payments: ${error.message}`);
}
}

function viewTeamDetails(teamId, roundKey) {
const team = tournamentBrackets.rounds[roundKey].teams.find(t => t.teamId === teamId);
if (!team) return;

document.getElementById('team-modal-title').textContent = team.teamName;
document.getElementById('team-modal-content').innerHTML = `
<div style="margin-bottom: 1.5rem;">
<h4>Team Information</h4>
<p><strong>Status:</strong> ${team.status}</p>
<p><strong>Payment Status:</strong> ${team.paymentStatus}</p>
<p><strong>Current Score:</strong> ${team.score || 0}</p>
${team.position ? `<p><strong>Position:</strong> ${team.position}</p>` : ''}
</div>

<div style="margin-bottom: 1.5rem;">
<h4>Round History</h4>
${Object.keys(tournamentBrackets.rounds).map(rKey => {
const rTeam = tournamentBrackets.rounds[rKey].teams.find(t => t.teamId === teamId);
return rTeam ? `
<div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0.5rem;">
<strong>${ROUND_CONFIG[rKey].name}:</strong> ${rTeam.status} 
${rTeam.paymentStatus === 'paid' ? '✅' : '❌'} 
${rTeam.score ? `(Score: ${rTeam.score})` : ''}
</div>
` : '';
}).join('')}
</div>

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
${team.paymentStatus === 'pending' ? `
<button class="btn btn-success" onclick="markPaid('${teamId}', '${roundKey}'); document.getElementById('team-modal').classList.remove('active');">
<i class="fas fa-check"></i> Mark Paid
</button>
` : ''}
</div>
`;

document.getElementById('team-modal').classList.add('active');
}

// --- TEAM DISPLAY FUNCTIONS ---
function showAllTeams(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];

document.getElementById('all-teams-modal-title').textContent = `All Teams - ${config.name}`;
document.getElementById('all-teams-content').innerHTML = `
<div style="margin-bottom: 1.5rem;">
<div class="teams-summary">
<div class="summary-stats">
<span><strong>${roundData.teams.length}</strong> total teams</span>
<span><strong>${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</strong> paid</span>
<span><strong>${roundData.teams.filter(t => t.status === 'qualified').length}</strong> qualified</span>
<span><strong>${roundData.teams.filter(t => t.status === 'eliminated').length}</strong> eliminated</span>
</div>
<div class="teams-actions">
<button class="btn btn-primary" onclick="exportRoundData('${roundKey}')">
<i class="fas fa-download"></i> Export Data
</button>
</div>
</div>
</div>

<div class="teams-grid-modal">
${roundData.teams.map(team => `
<div class="team-card-modal ${team.status}" onclick="showTeamModal('${team.teamId}', '${roundKey}')">
<div class="team-header">
<span class="team-name">${team.teamName}</span>
<div class="team-status-modal">
<span class="status-badge status-${team.paymentStatus}">${team.paymentStatus}</span>
<span class="status-badge status-${team.status}">${team.status}</span>
</div>
</div>
<div class="team-details">
<div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
<span>Score: ${team.score || 0}</span>
${team.position ? `<span>Position: #${team.position}</span>` : ''}
</div>
${team.groupId ? `<div style="margin-top: 0.25rem; color: var(--muted); font-size: 0.85rem;">Group ${team.groupId}</div>` : ''}
</div>
</div>
`).join('')}
</div>

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
</div>
`;

document.getElementById('all-teams-modal').classList.add('active');
}

async function showTeamModal(teamId, roundKey) {
const team = tournamentBrackets.rounds[roundKey].teams.find(t => t.teamId === teamId);
if (!team) return;

// Load full team details from API
const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/teams/${teamId}`, {
headers: { 'Authorization': `Bearer ${sessionData.token}` }
});

let fullTeamData = null;
if (response.ok) {
const data = await response.json();
fullTeamData = data.data;
}

document.getElementById('team-detail-modal-title').textContent = team.teamName;
document.getElementById('team-detail-content').innerHTML = `
<div class="team-header-modal">
<div class="team-name-modal">${team.teamName}</div>
<div class="team-status-modal">
<span class="status-badge status-${team.paymentStatus}">${team.paymentStatus}</span>
<span class="status-badge status-${team.status}">${team.status}</span>
</div>
</div>

<div class="team-stats">
<div class="stat-card">
<span class="stat-value">${team.score || 0}</span>
<span class="stat-label">Score</span>
</div>
<div class="stat-card">
<span class="stat-value">${team.position || '--'}</span>
<span class="stat-label">Position</span>
</div>
<div class="stat-card">
<span class="stat-value">₹${ROUND_CONFIG[roundKey].entryFee}</span>
<span class="stat-label">Entry Fee</span>
</div>
</div>

${fullTeamData && fullTeamData.players ? `
<div class="players-section">
<h4><i class="fas fa-users"></i> Team Members</h4>
<div class="player-list">
${fullTeamData.players.map(player => `
<div class="player-card">
<div class="player-info">
<div class="player-name">${player.name}</div>
<div class="player-details">
In-Game ID: ${player.inGameId || 'N/A'} | Email: ${player.email || 'N/A'}
</div>
</div>
${player.isCaptain ? '<span class="captain-badge">Captain</span>' : ''}
</div>
`).join('')}
</div>
</div>
` : `
<div class="players-section">
<h4><i class="fas fa-users"></i> Team Members</h4>
<p style="color: var(--muted); text-align: center; padding: 1rem;">
Player details not available. Team ID: ${teamId}
</p>
</div>
`}

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
${team.paymentStatus === 'pending' ? `
<button class="btn btn-success" onclick="markPaid('${teamId}', '${roundKey}'); document.getElementById('team-detail-modal').classList.remove('active');">
<i class="fas fa-check"></i> Mark Paid
</button>
` : ''}
</div>
`;

document.getElementById('team-detail-modal').classList.add('active');

} catch (error) {
console.error('Error loading team details:', error);
// Show basic team info even if API call fails
document.getElementById('team-detail-modal-title').textContent = team.teamName;
document.getElementById('team-detail-content').innerHTML = `
<div class="team-header-modal">
<div class="team-name-modal">${team.teamName}</div>
<div class="team-status-modal">
<span class="status-badge status-${team.paymentStatus}">${team.paymentStatus}</span>
<span class="status-badge status-${team.status}">${team.status}</span>
</div>
</div>

<div class="team-stats">
<div class="stat-card">
<span class="stat-value">${team.score || 0}</span>
<span class="stat-label">Score</span>
</div>
<div class="stat-card">
<span class="stat-value">${team.position || '--'}</span>
<span class="stat-label">Position</span>
</div>
<div class="stat-card">
<span class="stat-value">₹${ROUND_CONFIG[roundKey].entryFee}</span>
<span class="stat-label">Entry Fee</span>
</div>
</div>

<div class="players-section">
<h4><i class="fas fa-users"></i> Team Members</h4>
<p style="color: var(--muted); text-align: center; padding: 1rem;">
Unable to load player details. Team ID: ${teamId}
</p>
</div>

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
${team.paymentStatus === 'pending' ? `
<button class="btn btn-success" onclick="markPaid('${teamId}', '${roundKey}'); document.getElementById('team-detail-modal').classList.remove('active');">
<i class="fas fa-check"></i> Mark Paid
</button>
` : ''}
</div>
`;

document.getElementById('team-detail-modal').classList.add('active');
}
}

// --- EXPORT FUNCTIONS ---
async function exportRoundData(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];

// Show export options modal
document.getElementById('round-modal-title').textContent = `Export ${config.name} Data`;
document.getElementById('round-modal-content').innerHTML = `
<div style="margin-bottom: 1.5rem;">
<h4>Export Options</h4>
<p>Choose the format to export team and player data for ${config.name}.</p>
</div>

<div class="export-options">
<button class="btn btn-primary export-btn" onclick="exportToExcel('${roundKey}')">
<i class="fas fa-file-excel"></i> Export to Excel
</button>
<button class="btn btn-secondary export-btn" onclick="exportToPDF('${roundKey}')">
<i class="fas fa-file-pdf"></i> Export to PDF
</button>
</div>

<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
<h4>Export Preview</h4>
<p><strong>Teams:</strong> ${roundData.teams.length}</p>
<p><strong>Paid Teams:</strong> ${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</p>
<p><strong>Qualified Teams:</strong> ${roundData.teams.filter(t => t.status === 'qualified').length}</p>
<p><strong>Total Revenue:</strong> ₹${(roundData.teams.filter(t => t.paymentStatus === 'paid').length * config.entryFee).toLocaleString()}</p>
</div>

<div class="modal-buttons">
<button class="btn btn-secondary close-modal">Close</button>
</div>
`;

document.getElementById('round-modal').classList.add('active');
}

async function exportToExcel(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];

try {
// Prepare data for export
const exportData = [];

for (const team of roundData.teams) {
// Load full team details
const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/teams/${team.teamId}`, {
headers: { 'Authorization': `Bearer ${sessionData.token}` }
});

if (response.ok) {
const fullTeamData = await response.json();
const teamData = fullTeamData.data;

if (teamData.players && teamData.players.length > 0) {
teamData.players.forEach((player, index) => {
exportData.push({
'Team Name': team.teamName,
'Team ID': team.teamId,
'Team Status': team.status,
'Payment Status': team.paymentStatus,
'Score': team.score || 0,
'Position': team.position || '',
'Entry Fee': config.entryFee,
'Player Name': player.name,
'Player Email': player.email || '',
'In-Game ID': player.inGameId || '',
'Is Captain': player.isCaptain ? 'Yes' : 'No',
'Round': config.name
});
});
} else {
exportData.push({
'Team Name': team.teamName,
'Team ID': team.teamId,
'Team Status': team.status,
'Payment Status': team.paymentStatus,
'Score': team.score || 0,
'Position': team.position || '',
'Entry Fee': config.entryFee,
'Player Name': 'No players data',
'Player Email': '',
'In-Game ID': '',
'Is Captain': '',
'Round': config.name
});
}
} else {
exportData.push({
'Team Name': team.teamName,
'Team ID': team.teamId,
'Team Status': team.status,
'Payment Status': team.paymentStatus,
'Score': team.score || 0,
'Position': team.position || '',
'Entry Fee': config.entryFee,
'Player Name': 'Data not available',
'Player Email': '',
'In-Game ID': '',
'Is Captain': '',
'Round': config.name
});
}
} catch (error) {
console.error('Error loading team details for export:', error);
exportData.push({
'Team Name': team.teamName,
'Team ID': team.teamId,
'Team Status': team.status,
'Payment Status': team.paymentStatus,
'Score': team.score || 0,
'Position': team.position || '',
'Entry Fee': config.entryFee,
'Player Name': 'Error loading data',
'Player Email': '',
'In-Game ID': '',
'Is Captain': '',
'Round': config.name
});
}
}

// Convert to CSV format
const csvContent = convertToCSV(exportData);
downloadFile(csvContent, `${currentTournament.title}_${config.name}_Teams.csv`, 'text/csv');

document.getElementById('round-modal').classList.remove('active');
alert('Excel file downloaded successfully!');

} catch (error) {
console.error('Export error:', error);
alert('Failed to export data. Please try again.');
}
}

async function exportToPDF(roundKey) {
const roundData = tournamentBrackets.rounds[roundKey];
const config = ROUND_CONFIG[roundKey];

try {
// Create HTML content for PDF
let htmlContent = `
<html>
<head>
<title>${currentTournament.title} - ${config.name}</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.header { text-align: center; margin-bottom: 30px; }
.tournament-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
.round-title { font-size: 18px; color: #666; }
.summary { background: #f5f5f5; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
.team-section { margin-bottom: 30px; page-break-inside: avoid; }
.team-header { background: #333; color: white; padding: 10px; font-weight: bold; }
.team-info { padding: 10px; border: 1px solid #ddd; }
.players-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.players-table th, .players-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.players-table th { background: #f5f5f5; }
.status-paid { color: green; font-weight: bold; }
.status-pending { color: orange; font-weight: bold; }
.status-qualified { color: blue; font-weight: bold; }
</style>
</head>
<body>
<div class="header">
<div class="tournament-title">${currentTournament.title}</div>
<div class="round-title">${config.name} - Teams Report</div>
<div style="font-size: 14px; color: #666; margin-top: 10px;">
Generated on ${new Date().toLocaleDateString('en-IN')}
</div>
</div>

<div class="summary">
<h3>Summary</h3>
<p><strong>Total Teams:</strong> ${roundData.teams.length}</p>
<p><strong>Paid Teams:</strong> ${roundData.teams.filter(t => t.paymentStatus === 'paid').length}</p>
<p><strong>Qualified Teams:</strong> ${roundData.teams.filter(t => t.status === 'qualified').length}</p>
<p><strong>Entry Fee:</strong> ₹${config.entryFee} per team</p>
<p><strong>Total Revenue:</strong> ₹${(roundData.teams.filter(t => t.paymentStatus === 'paid').length * config.entryFee).toLocaleString()}</p>
</div>
`;

// Add team details
for (const team of roundData.teams) {
htmlContent += `
<div class="team-section">
<div class="team-header">${team.teamName}</div>
<div class="team-info">
<p><strong>Status:</strong> <span class="status-${team.status}">${team.status}</span></p>
<p><strong>Payment:</strong> <span class="status-${team.paymentStatus}">${team.paymentStatus}</span></p>
<p><strong>Score:</strong> ${team.score || 0}</p>
${team.position ? `<p><strong>Position:</strong> #${team.position}</p>` : ''}
<p><strong>Team ID:</strong> ${team.teamId}</p>
`;

// Try to load player details
const sessionData = getSessionData();
try {
const response = await fetch(`${API_BASE_URL}/api/teams/${team.teamId}`, {
headers: { 'Authorization': `Bearer ${sessionData.token}` }
});

if (response.ok) {
const fullTeamData = await response.json();
const teamData = fullTeamData.data;

if (teamData.players && teamData.players.length > 0) {
htmlContent += `
<table class="players-table">
<thead>
<tr>
<th>Player Name</th>
<th>In-Game ID</th>
<th>Email</th>
<th>Role</th>
</tr>
</thead>
<tbody>
`;
teamData.players.forEach(player => {
htmlContent += `
<tr>
<td>${player.name}</td>
<td>${player.inGameId || 'N/A'}</td>
<td>${player.email || 'N/A'}</td>
<td>${player.isCaptain ? 'Captain' : 'Player'}</td>
</tr>
`;
});
htmlContent += `</tbody></table>`;
} else {
htmlContent += `<p><em>No player data available</em></p>`;
}
} else {
htmlContent += `<p><em>Unable to load player data</em></p>`;
}
} catch (error) {
htmlContent += `<p><em>Error loading player data</em></p>`;
}

htmlContent += `</div></div>`;
}

htmlContent += `</body></html>`;

// Create and download PDF (using browser's print functionality)
const printWindow = window.open('', '_blank');
printWindow.document.write(htmlContent);
printWindow.document.close();
printWindow.focus();
printWindow.print();

document.getElementById('round-modal').classList.remove('active');
alert('PDF export initiated. Please use your browser\'s print dialog to save as PDF.');

} catch (error) {
console.error('PDF export error:', error);
alert('Failed to export PDF. Please try again.');
}
}

// Utility functions for export
function convertToCSV(data) {
if (data.length === 0) return '';

const headers = Object.keys(data[0]);
const csvRows = [];

// Add headers
csvRows.push(headers.join(','));

// Add data rows
for (const row of data) {
const values = headers.map(header => {
const value = row[header];
// Escape commas and quotes in CSV
return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
? `"${value.replace(/"/g, '""')}"` 
: value;
});
csvRows.push(values.join(','));
}

return csvRows.join('\n');
}

function downloadFile(content, filename, contentType) {
const blob = new Blob([content], { type: contentType });
const url = window.URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = filename;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
window.URL.revokeObjectURL(url);
}

// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
const sessionData = getSessionData();
if (!sessionData || !sessionData.token) {
window.location.href = 'auth.html';
return;
}

if (sessionData.user) {
document.getElementById('admin-username').textContent = sessionData.user.username;
}

loadTournamentBrackets();

// Modal close listeners
document.querySelectorAll('.close-modal, .modal').forEach(el => {
el.addEventListener('click', (e) => {
if (e.target === el) {
el.closest('.modal')?.classList.remove('active');
}
});
});
});
</script>
</body>
</html>