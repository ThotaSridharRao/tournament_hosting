<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Registration | EArena</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="navbar.css">
<style>
:root {
--bg: #0f0f10;
--panel: #1f1f20;
--muted: #9aa0a6;
--copy: #e6e6e6;
--accent: #ff5e00;
--accent-2: #ca4405;
--radius: 12px;
--border-color: rgba(255, 255, 255, 0.1);
--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
margin: 0;
font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
background: var(--bg);
color: var(--copy);
line-height: 1.5;
min-height: 100vh;
}

.site-header {
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 1000;
background: rgba(15, 15, 16, 0.8);
backdrop-filter: blur(20px);
border-bottom: 1px solid var(--border-color);
height: 64px;
display: flex;
align-items: center;
justify-content: space-between;
padding: 0 24px;
}


.brand {
display: flex;
align-items: center;
gap: 0.5rem;
font-weight: 700;
letter-spacing: -0.5px;
color: var(--copy);
font-size: 1.2rem;
text-decoration: none;
}

.brand .accent {
color: var(--accent);
}

.user-menu {
display: flex;
align-items: center;
gap: 1rem;
}

.user-info {
display: flex;
align-items: center;
gap: 0.5rem;
color: var(--copy);
font-weight: 500;
}

.main-content {
margin-top: 64px;
padding: 32px 24px;
max-width: 1200px;
margin-left: auto;
margin-right: auto;
}

.registration-container {
display: grid;
grid-template-columns: 1fr 400px;
gap: 2rem;
align-items: start;
}

.registration-form {
background: var(--panel);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 2rem;
}

.form-header {
margin-bottom: 2rem;
}

.form-title {
font-size: 1.8rem;
font-weight: 800;
margin-bottom: 0.5rem;
}

.form-subtitle {
color: var(--muted);
font-size: 1rem;
}

.tournament-info {
background: var(--panel);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 2rem;
position: sticky;
top: 88px;
}

.tournament-poster {
width: 100%;
height: 200px;
border-radius: var(--radius);
overflow: hidden;
margin-bottom: 1.5rem;
background: rgba(255, 255, 255, 0.05);
display: flex;
align-items: center;
justify-content: center;
}

.tournament-poster img {
width: 100%;
height: 100%;
object-fit: cover;
}

.poster-placeholder {
color: var(--muted);
text-align: center;
}

.tournament-details h3 {
font-size: 1.2rem;
font-weight: 700;
margin-bottom: 1rem;
color: var(--accent);
}

.detail-item {
display: flex;
justify-content: space-between;
padding: 0.75rem 0;
border-bottom: 1px solid var(--border-color);
}

.detail-item:last-child {
border-bottom: none;
}

.detail-label {
color: var(--muted);
font-weight: 500;
}

.detail-value {
font-weight: 600;
color: var(--copy);
}

.payment-structure {
margin-top: 2rem;
padding-top: 2rem;
border-top: 1px solid var(--border-color);
}

.payment-structure h4 {
color: var(--accent);
margin-bottom: 1rem;
}

.round-payment {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.75rem;
margin-bottom: 0.5rem;
background: rgba(0, 0, 0, 0.2);
border-radius: 6px;
}

.round-name {
font-weight: 600;
}

.round-fee {
color: var(--accent);
font-weight: 700;
}

/* KP Structure Styles */
.kp-structure {
margin-top: 1.5rem;
}

.kp-flow {
display: flex;
align-items: center;
justify-content: center;
gap: 1rem;
flex-wrap: wrap;
margin: 1rem 0;
}

.kp-step {
display: flex;
flex-direction: column;
align-items: center;
text-align: center;
padding: 1rem;
background: rgba(255, 215, 0, 0.1);
border-radius: 8px;
border: 1px solid rgba(255, 215, 0, 0.3);
min-width: 120px;
}

.kp-step i {
font-size: 1.5rem;
color: var(--accent);
margin-bottom: 0.5rem;
}

.kp-step span {
font-weight: 600;
color: var(--copy);
margin-bottom: 0.25rem;
}

.kp-step small {
color: var(--muted);
font-size: 0.8rem;
}

.kp-arrow {
color: var(--accent);
font-size: 1.5rem;
font-weight: bold;
}

@media (max-width: 768px) {
.kp-flow {
flex-direction: column;
}

.kp-arrow {
transform: rotate(90deg);
}
}

.form-section {
margin-bottom: 2rem;
}

.section-title {
font-size: 1.2rem;
font-weight: 700;
margin-bottom: 1rem;
color: var(--copy);
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
margin-bottom: 1rem;
}

.form-group {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.form-group.full-width {
grid-column: span 2;
}

.form-group label {
font-weight: 600;
color: var(--copy);
font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 6px;
padding: 0.75rem;
color: var(--copy);
font-family: inherit;
transition: border-color 0.2s ease, background-color 0.2s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
outline: none;
border-color: var(--accent);
background: rgba(255, 255, 255, 0.15);
}

.players-section {
background: rgba(0, 0, 0, 0.2);
border-radius: var(--radius);
padding: 1.5rem;
}

.player-form {
display: grid;
grid-template-columns: 1fr 1fr 1fr auto;
gap: 1rem;
align-items: end;
margin-bottom: 1rem;
padding: 1rem;
background: rgba(255, 255, 255, 0.05);
border-radius: 6px;
}

.player-form:last-child {
margin-bottom: 0;
}

.captain-badge {
background: var(--accent);
color: #000;
padding: 0.25rem 0.5rem;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 700;
}

.btn {
padding: 0.75rem 1.5rem;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
border: none;
text-decoration: none;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
text-align: center;
}

.btn:hover {
transform: translateY(-1px);
}

.btn-primary {
background: linear-gradient(135deg, var(--accent), var(--accent-2));
color: #000;
}

.btn-primary:hover {
background: linear-gradient(135deg, var(--accent-2), var(--accent));
}

.btn-secondary {
background: rgba(255, 255, 255, 0.1);
color: var(--copy);
border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
}

.btn-danger {
background: var(--danger);
color: white;
}

.btn-danger:hover {
background: #dc2626;
}

.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

.add-player-btn {
width: 100%;
margin-top: 1rem;
}

.registration-summary {
background: rgba(245, 158, 11, 0.1);
border: 1px solid rgba(245, 158, 11, 0.3);
border-radius: var(--radius);
padding: 1.5rem;
margin-bottom: 2rem;
}

.registration-summary h4 {
color: var(--warning);
margin-bottom: 1rem;
}

.summary-item {
display: flex;
justify-content: space-between;
margin-bottom: 0.5rem;
}

.summary-total {
border-top: 1px solid rgba(245, 158, 11, 0.3);
padding-top: 1rem;
margin-top: 1rem;
font-weight: 700;
font-size: 1.1rem;
}

.terms-section {
background: rgba(0, 0, 0, 0.2);
border-radius: var(--radius);
padding: 1.5rem;
margin-bottom: 2rem;
}

.terms-section h4 {
color: var(--accent);
margin-bottom: 1rem;
}

.terms-list {
list-style: none;
padding: 0;
}

.terms-list li {
padding: 0.5rem 0;
border-bottom: 1px solid var(--border-color);
}

.terms-list li:last-child {
border-bottom: none;
}

.checkbox-group {
display: flex;
align-items: center;
gap: 0.5rem;
margin-top: 1rem;
}

.checkbox-group input[type="checkbox"] {
width: 18px;
height: 18px;
}

.loading-state {
text-align: center;
padding: 3rem;
color: var(--muted);
}

.success-message {
background: rgba(16, 185, 129, 0.1);
border: 1px solid rgba(16, 185, 129, 0.3);
border-radius: var(--radius);
padding: 1.5rem;
text-align: center;
color: var(--success);
}

.error-message {
background: rgba(239, 68, 68, 0.1);
border: 1px solid rgba(239, 68, 68, 0.3);
border-radius: var(--radius);
padding: 1rem;
margin-bottom: 1rem;
color: var(--danger);
}

@media (max-width: 768px) {
.registration-container {
grid-template-columns: 1fr;
}

.tournament-info {
position: static;
}

.form-row {
grid-template-columns: 1fr;
}

.form-group.full-width {
grid-column: span 1;
}

.player-form {
grid-template-columns: 1fr;
}
}



#user-menu {
display: flex;
align-items: center;
}

.already-registered {
text-align: center;
padding: 3rem 2rem;
background: var(--panel);
border-radius: var(--radius);
border: 1px solid var(--border-color);
}

.success-icon {
font-size: 4rem;
color: #10b981;
margin-bottom: 1rem;
}

.already-registered h2 {
color: var(--copy);
margin-bottom: 1rem;
}

.already-registered p {
color: var(--muted);
margin-bottom: 1rem;
}

.registration-actions {
display: flex;
gap: 1rem;
justify-content: center;
margin-top: 2rem;
}

.registration-actions .btn {
padding: 0.75rem 1.5rem;
text-decoration: none;
border-radius: var(--radius);
font-weight: 600;
display: inline-flex;
align-items: center;
gap: 0.5rem;
}

.btn-primary {
background: var(--accent);
color: #000;
}

.btn-secondary {
background: var(--surface);
color: var(--copy);
border: 1px solid var(--border-color);
}
</style>
</head>
<body>
    <header class="site-header">
    <a href="index.html" class="brand">
        <span><span class="accent">E</span>Arena</span>
    </a>

    <div class="header-right">
        <div class="nav-actions">
            <div id="guest-menu">
                <button class="header-cta" onclick="redirectToAuth('register')">Join Us</button>
            </div>

            <div id="user-menu" style="display: none;">
                <div class="profile-dropdown">
                    <div class="profile-icon" id="profile-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="profile-modal" id="profile-modal">
                        <div class="profile-header">
                            <div class="profile-photo"><i class="fas fa-user"></i></div>
                            <div class="profile-info">
                                <div class="profile-username" id="modal-username">User</div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <a href="user-dashboard.html" class="profile-action" id="modal-dashboard-link">
                                <i class="fas fa-user-cog"></i><span>My Account</span>
                            </a>
                            <button class="profile-action logout-action" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i><span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="hamburger" aria-label="Toggle menu" aria-expanded="false">
            <i class="fas fa-bars"></i>
        </button>
    </div>
</header>
    <div id="mobile-nav" class="mobile-nav">
    </div>

<main class="main-content">

<div class="registration-container">
<div class="registration-form">
<div class="form-header">
<h1 class="form-title">Team Registration</h1>
<p class="form-subtitle" id="tournament-name">Register your team for this tournament</p>
</div>

<div id="error-container"></div>

<form id="registration-form">
<div class="form-section">
<h3 class="section-title">Team Information</h3>
<div class="form-row">
<div class="form-group">
<label for="team-name">Team Name *</label>
<input type="text" id="team-name" name="teamName" required>
</div>
<div class="form-group">
<label for="team-tag">Team Tag</label>
<input type="text" id="team-tag" name="teamTag" placeholder="e.g., TL, TSM">
</div>
</div>
<div class="form-group full-width">
<label for="team-description">Team Description</label>
<textarea id="team-description" name="teamDescription" rows="3" placeholder="Tell us about your team..."></textarea>
</div>
</div>

<div class="form-section">
<div class="players-section">
<h3 class="section-title">Team Members</h3>
<div id="players-container">
<!-- Players will be added dynamically -->
</div>
<button type="button" class="btn btn-secondary add-player-btn" id="add-player-btn">
<i class="fas fa-plus"></i> Add Player
</button>
</div>
</div>

<div class="registration-summary">
<!-- Registration summary will be loaded dynamically -->
</div>

<div class="terms-section" id="terms-section">
<!-- Tournament rules will be loaded dynamically -->
</div>

<button type="submit" class="btn btn-primary" style="width: 100%;" id="register-btn">
<i class="fas fa-user-plus"></i> Register Team
</button>
</form>
</div>

<div class="tournament-info">
<div class="tournament-poster" id="tournament-poster">
<div class="poster-placeholder">
<i class="fas fa-image"></i><br>
Tournament Poster
</div>
</div>

<div class="tournament-details">
<h3 id="tournament-title">Loading Tournament...</h3>
<div class="detail-item">
<span class="detail-label">Game</span>
<span class="detail-value" id="game-name">--</span>
</div>
<div class="detail-item">
<span class="detail-label">Format</span>
<span class="detail-value" id="tournament-format">--</span>
</div>
<div class="detail-item">
<span class="detail-label">Max Teams</span>
<span class="detail-value" id="max-teams">--</span>
</div>
<div class="detail-item">
<span class="detail-label">Prize Pool</span>
<span class="detail-value" id="prize-pool">--</span>
</div>
<div class="detail-item">
<span class="detail-label">Registration Ends</span>
<span class="detail-value" id="reg-end-date">--</span>
</div>
</div>

<div class="payment-structure" id="payment-structure">
<!-- Payment structure will be loaded dynamically -->
</div>
</div>
</div>
</main>

<script>
// Helper function to redirect to auth with return URL


// Auto-detect API URL based on environment
const API_BASE_URL = (() => {
  // Check if we're running locally
  const isLocal = window.location.hostname === 'localhost' || 
                  window.location.hostname === '127.0.0.1' || 
                  window.location.protocol === 'file:';
  
  // Use production backend when deployed, local when developing
  const apiUrl = isLocal ? 'http://localhost:8000' : 'https://t2-237c.onrender.com';
  
  console.log('üîß Environment Detection:', {
    hostname: window.location.hostname,
    protocol: window.location.protocol,
    isLocal: isLocal,
    apiUrl: apiUrl
  });
  
  return apiUrl;
})();
let currentTournament = null;
let playerCount = 0;

// Test API connection on page load
async function testApiConnection() {
  try {
    console.log('üîç Testing API connection to:', API_BASE_URL);
    const response = await fetch(`${API_BASE_URL}/api/tournaments`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      console.log('‚úÖ API connection successful');
      return true;
    } else {
      console.warn('‚ö†Ô∏è API responded with status:', response.status);
      return false;
    }
  } catch (error) {
    console.error('‚ùå API connection failed:', error.message);
    
    // Show user-friendly error message
    const errorContainer = document.getElementById('error-container');
    if (errorContainer) {
      errorContainer.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-triangle"></i> 
          Backend connection failed. Please make sure the backend server is running on port 8000.
          <br><small>Error: ${error.message}</small>
        </div>
      `;
    }
    return false;
  }
}

// Function to get proper image URL with CORS support
function getImageUrl(imagePath) {
if (!imagePath) return null;
if (imagePath.startsWith('http')) return imagePath;
const filename = imagePath.split('/').pop();
return `${API_BASE_URL}/api/static/images/${filename}`;
}

// --- TOURNAMENT LOADING ---
async function loadTournamentData() {
const urlParams = new URLSearchParams(window.location.search);
const tournamentSlug = urlParams.get('slug') || urlParams.get('id');

if (!tournamentSlug) {
showError('No tournament specified. Please provide a valid tournament slug.');
return;
}

try {
const response = await fetch(`${API_BASE_URL}/api/tournaments/slug/${tournamentSlug}`);

if (!response.ok) {
throw new Error(response.status === 404 ? 'Tournament not found' : 'Failed to fetch tournament data');
}

const data = await response.json();
currentTournament = data.data;

updateTournamentDisplay();


} catch (error) {
console.error('Error loading tournament:', error);
showError(`Error loading tournament: ${error.message}`);
}
}

function updateTournamentDisplay() {
if (!currentTournament) {
console.error('Tournament data not loaded');
return;
}

// Update tournament info
document.getElementById('tournament-name').textContent = `Register for ${currentTournament.title}`;
document.getElementById('tournament-title').textContent = currentTournament.title;
document.getElementById('game-name').textContent = currentTournament.game || 'TBD';
// Display format with KP details if applicable
let formatText = currentTournament.format || currentTournament.tournamentFormat || 'TBD';
if (currentTournament.format === 'kp' && currentTournament.kpSettings) {
    const kp = currentTournament.kpSettings;
    formatText = `KP Format (${kp.numberOfGroups} groups of ${kp.groupSize} teams, top ${kp.qualifiersPerGroup} qualify)`;
}
document.getElementById('tournament-format').textContent = formatText;
document.getElementById('max-teams').textContent = currentTournament.maxTeams || 'Unlimited';

// Show max players per team for KP tournaments
if (currentTournament.format === 'kp' && currentTournament.kpSettings) {
    const maxPlayersNote = document.createElement('div');
    maxPlayersNote.className = 'detail-item';
    maxPlayersNote.innerHTML = `
        <span class="detail-label">Max Players per Team</span>
        <span class="detail-value">${currentTournament.kpSettings.maxPlayersPerTeam}</span>
    `;
    document.querySelector('.tournament-details').appendChild(maxPlayersNote);
}
document.getElementById('prize-pool').textContent = currentTournament.prizePool ? `‚Çπ${currentTournament.prizePool.toLocaleString()}` : 'TBD';

// üéØ NEW: Generate exact number of player rows based on tournament
generatePlayerRows();

// Update registration end date
const regEndDate = currentTournament.registrationEnd ? 
new Date(currentTournament.registrationEnd).toLocaleDateString('en-IN', { 
day: 'numeric', 
month: 'short', 
year: 'numeric' 
}) : 'TBD';
document.getElementById('reg-end-date').textContent = regEndDate;

// Load payment structure based on tournament format
loadPaymentStructure(currentTournament);

// Load registration summary
loadRegistrationSummary(currentTournament);

// Load tournament rules
loadTournamentRules(currentTournament);

// Update tournament poster
const posterPath = currentTournament.posterImage || currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl;
if (posterPath) {
const imageUrl = getImageUrl(posterPath);
const posterElement = document.getElementById('tournament-poster');
posterElement.innerHTML = `<img src="${imageUrl}" alt="Tournament Poster" onerror="this.innerHTML='<div class=\\'poster-placeholder\\'><i class=\\'fas fa-image\\'></i><br>Tournament Poster</div>'">`;
}

// Check if registration is still open
checkRegistrationStatus();
}


function checkRegistrationStatus() {
if (!currentTournament) return;

// Check if registration is open based on status and dates
const now = new Date();
const regStart = new Date(currentTournament.registrationStart);
const regEnd = new Date(currentTournament.registrationEnd);
const isWithinRegistrationPeriod = now >= regStart && now <= regEnd;

const validStatuses = ['upcoming', 'registration', 'registration-open'];
const restrictedStatuses = ['cancelled', 'completed'];

console.log('Registration validation:', {
    status: currentTournament.status,
    now: now.toISOString(),
    regStart: regStart.toISOString(),
    regEnd: regEnd.toISOString(),
    isWithinRegistrationPeriod,
    validStatus: validStatuses.includes(currentTournament.status)
});

// Check various conditions
if (restrictedStatuses.includes(currentTournament.status)) {
    showError('Registration is not currently open for this tournament.');
    document.getElementById('register-btn').disabled = true;
    document.getElementById('register-btn').textContent = 'Registration Closed';
} else if (now > regEnd) {
    showError('Registration for this tournament has ended.');
    document.getElementById('register-btn').disabled = true;
    document.getElementById('register-btn').textContent = 'Registration Closed';
} else if (now < regStart) {
    showError(`Registration opens on ${regStart.toLocaleDateString()}`);
    document.getElementById('register-btn').disabled = true;
    document.getElementById('register-btn').textContent = 'Registration Not Open';
} else {
    // Registration is open
    console.log('Registration is open!');
    document.getElementById('register-btn').disabled = false;
    document.getElementById('register-btn').innerHTML = '<i class="fas fa-user-plus"></i> Register Team';
    
    // Clear any error messages
    const errorContainer = document.getElementById('error-container');
    if (errorContainer) {
        errorContainer.innerHTML = '';
    }
}
}

// --- PLAYER MANAGEMENT ---
function generatePlayerRows() {
if (!currentTournament) return;

// Get max players from tournament settings
const maxPlayers = currentTournament.format === 'kp' && currentTournament.kpSettings 
    ? currentTournament.kpSettings.maxPlayersPerTeam 
    : 4; // Default to 4 players

console.log(`üéØ Generating ${maxPlayers} player rows for tournament`);

// Clear existing players
const playersContainer = document.getElementById('players-container');
playersContainer.innerHTML = '';
playerCount = 0;

// Generate exact number of player rows
for (let i = 1; i <= maxPlayers; i++) {
    addPlayerRow(i, maxPlayers);
}

// Hide the add player button since we have exact number
const addBtn = document.getElementById('add-player-btn');
if (addBtn) addBtn.style.display = 'none';

// Update form instructions
const instructionEl = document.querySelector('.form-instructions');
if (instructionEl) {
    instructionEl.textContent = `Please fill in details for all ${maxPlayers} team members. The first player will be the team captain.`;
}
}

function addPlayerRow(playerNumber, totalPlayers) {
playerCount = playerNumber;

const playersContainer = document.getElementById('players-container');

const playerForm = document.createElement('div');
playerForm.className = 'player-form';
playerForm.innerHTML = `
<div class="player-header">
    <h4>Player ${playerNumber} ${playerNumber === 1 ? '(Captain)' : ''}</h4>
    ${playerNumber === 1 ? '<span class="captain-badge">Team Captain</span>' : ''}
</div>
<div class="form-group">
    <label for="player-name-${playerNumber}">Player Name *</label>
    <input type="text" id="player-name-${playerNumber}" name="players[${playerNumber}][name]" required>
</div>
<div class="form-group">
    <label for="player-email-${playerNumber}">Email *</label>
    <input type="email" id="player-email-${playerNumber}" name="players[${playerNumber}][email]" required>
</div>
<div class="form-group">
    <label for="player-phone-${playerNumber}">Phone Number</label>
    <input type="tel" id="player-phone-${playerNumber}" name="players[${playerNumber}][phoneNumber]" placeholder="+91 9876543210">
</div>
<div class="form-group">
    <label for="player-ingame-${playerNumber}">In-Game ID *</label>
    <input type="text" id="player-ingame-${playerNumber}" name="players[${playerNumber}][inGameId]" required>
</div>
`;

playersContainer.appendChild(playerForm);
}

// Legacy functions (kept for compatibility)
function addPlayer() {
// This function is now replaced by generatePlayerRows()
console.log('addPlayer() called - using new generatePlayerRows() instead');
}

function removePlayer(button) {
// Players can't be removed in new system - fixed number based on tournament
console.log('removePlayer() called - not allowed in new system');
}

// REPLACE your old submitRegistration function with this one
async function submitRegistrationAndInitiatePayment(formData) {
    const sessionData = getSessionData();
    if (!sessionData || !sessionData.token) {
        showError('Please login to register for tournaments.');
        return;
    }

    const btn = document.getElementById('register-btn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    btn.disabled = true;

    try {
        // --- 1. Collect Team Data (Your existing logic is great) ---
        const teamData = {
            teamName: formData.get('teamName'),
            phone: formData.get('players[1][phoneNumber]'), // Captain's phone
            players: []
        };

        const maxPlayers = currentTournament.format === 'kp' && currentTournament.kpSettings
            ? currentTournament.kpSettings.maxPlayersPerTeam
            : 4;

        for (let i = 1; i <= maxPlayers; i++) {
            const name = formData.get(`players[${i}][name]`);
            const email = formData.get(`players[${i}][email]`);
            const inGameId = formData.get(`players[${i}][inGameId]`);

            if (!name || !email || !inGameId) {
                throw new Error(`Please fill in all required fields for Player ${i}`);
            }
            teamData.players.push({ name, email, inGameId, role: i === 1 ? 'Captain' : 'Player' });
        }

        // --- 2. Check if Payment is Required ---
        const entryFee = currentTournament.entryFee || 0;
        if (entryFee <= 0) {
            // If free entry, just register the team directly (This part is new)
            await registerFreeTeam(teamData, sessionData.token);
            return; // Stop here for free tournaments
        }

        // --- 3. Initiate Payment via Your Backend ---
        const paymentPayload = {
            tournamentSlug: currentTournament.slug,
            teamData: teamData,
            amount: entryFee
        };

        const response = await fetch(`${API_BASE_URL}/api/payments/initiate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${sessionData.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentPayload)
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
            throw new Error(result.detail || result.message || 'Failed to initiate payment.');
        }

        // --- 4. Redirect to PayU ---
        redirectToPayU(result.payuData, result.payuUrl);

    } catch (error) {
        console.error('Registration/Payment error:', error);
        showError(error.message);
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Register Team';
        btn.disabled = false;
    }
}
// ADD these two new functions to your script tag

/**
 * Dynamically creates and submits a form to redirect the user to the PayU payment page.
 */
function redirectToPayU(payuData, payuUrl) {
    // Create a new form element
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = payuUrl; // The PayU URL from your backend

    // Add all the required PayU fields as hidden inputs
    for (const key in payuData) {
        if (payuData.hasOwnProperty(key)) {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = key;
            hiddenField.value = payuData[key];
            form.appendChild(hiddenField);
        }
    }

    // Append the form to the body and submit it
    document.body.appendChild(form);
    form.submit();
}

/**
 * Handles registration for free tournaments by calling the original registration endpoint.
 */
async function registerFreeTeam(teamData, token) {
    const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament.slug}/register`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(teamData)
    });

    const result = await response.json();
    if (!response.ok || !result.success) {
        throw new Error(result.detail || result.message || 'Free registration failed.');
    }

    console.log('Team registered successfully for free:', result.data);
    showRegistrationSuccess(result.data);
}
// Load registration summary based on tournament
function loadRegistrationSummary(tournament) {
    const container = document.querySelector('.registration-summary');
    if (!container) return;
    const entryFee = tournament.entryFee || 0;
    
    container.innerHTML = `
        <h4><i class="fas fa-receipt"></i> Registration Summary</h4>
        <div class="summary-item">
            <span>Tournament Entry Fee</span>
            <span>‚Çπ${entryFee.toLocaleString()}</span>
        </div>
        <div class="summary-total">
            <div class="summary-item">
                <span>Total Due Now</span>
                <span style="color: var(--copy); font-weight: bold;">‚Çπ${entryFee.toLocaleString()}</span>
            </div>
        </div>
    `;
}
// Load tournament rules based on format
function loadTournamentRules(tournament) {
    const container = document.getElementById('terms-section');
    
    let rules = [];
    
    if (tournament.format === 'kp') {
        // KP Tournament specific rules
        const kp = tournament.kpSettings || {};
        rules = [
            `One-time entry fee of ‚Çπ${tournament.entryFee || 200} per team`,
            `Teams will be divided into ${kp.numberOfGroups || 4} groups of ${kp.groupSize || 25} teams each`,
            `Top ${kp.qualifiersPerGroup || 4} teams from each group qualify for the final`,
            `Maximum ${kp.maxPlayersPerTeam || 4} players per team`,
            'No additional fees for qualifying rounds',
            'No refunds for eliminated teams',
            'Teams must follow all tournament rules and guidelines',
            'Organizers reserve the right to disqualify teams for misconduct'
        ];
    } else {
        // Default tournament rules
        rules = [
            `Entry fee: ‚Çπ${tournament.entryFee || 0} per team`,
            'Teams must follow all tournament rules and guidelines',
            'No refunds for eliminated teams',
            'Organizers reserve the right to disqualify teams for misconduct',
            'Payment must be completed before tournament starts'
        ];
    }
    
    container.innerHTML = `
        <h4><i class="fas fa-file-contract"></i> Tournament Rules & Terms</h4>
        <ul class="terms-list">
            ${rules.map(rule => `<li>${rule}</li>`).join('')}
        </ul>
        <div class="checkbox-group">
            <input type="checkbox" id="accept-terms" name="acceptTerms" required>
            <label for="accept-terms">I accept the tournament rules and terms</label>
        </div>
    `;
}

// REPLACE the old function with this one
function loadPaymentStructure(tournament) {
    const container = document.getElementById('payment-structure');
    const entryFee = tournament.entryFee || 0;
    
    let structureHTML = `<h4><i class="fas fa-coins"></i> Payment Structure</h4>
        <div class="round-payment">
            <span class="round-name">Entry Fee</span>
            <span class="round-fee">‚Çπ${entryFee.toLocaleString()}</span>
        </div>`;

    if (tournament.format === 'kp') {
        structureHTML += `
            <div class="kp-structure">
                <h5 style="color: var(--accent); margin: 1rem 0 0.5rem 0;">Tournament Structure:</h5>
                <div class="kp-flow">
                    <div class="kp-step">
                        <i class="fas fa-users"></i>
                        <span>${tournament.kpSettings?.numberOfGroups || 4} Groups</span>
                        <small>${tournament.kpSettings?.groupSize || 25} teams each</small>
                    </div>
                    <div class="kp-arrow">‚Üí</div>
                    <div class="kp-step">
                        <i class="fas fa-trophy"></i>
                        <span>Qualifiers</span>
                        <small>Top ${tournament.kpSettings?.qualifiersPerGroup || 4} from each group</small>
                    </div>
                    <div class="kp-arrow">‚Üí</div>
                    <div class="kp-step">
                        <i class="fas fa-crown"></i>
                        <span>Final</span>
                        <small>${(tournament.kpSettings?.numberOfGroups || 4) * (tournament.kpSettings?.qualifiersPerGroup || 4)} teams compete</small>
                    </div>
                </div>
            </div>`;
    }
    container.innerHTML = structureHTML;
}

function showError(message) {
const errorContainer = document.getElementById('error-container');
errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
}

function showSuccess(message) {
const errorContainer = document.getElementById('error-container');
errorContainer.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> ${message}</div>`;
}

function showRegistrationSuccess(teamData) {
// Hide the registration form and show success screen
const mainContent = document.querySelector('.main-content');
mainContent.innerHTML = `
    <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 3rem 2rem;">
        <!-- Success Icon -->
        <div style="font-size: 5rem; color: #10b981; margin-bottom: 2rem;">
            <i class="fas fa-check-circle"></i>
        </div>
        
        <!-- Success Message -->
        <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; color: var(--copy);">
            Registration Successful! üéâ
        </h1>
        
        <p style="font-size: 1.2rem; color: var(--muted); margin-bottom: 2rem; line-height: 1.6;">
            Your team <strong style="color: var(--accent);">"${teamData.teamName}"</strong> has been successfully registered for 
            <strong style="color: var(--copy);">${currentTournament.title}</strong>
        </p>
        
        <!-- Registration Details Card -->
        <div style="background: var(--panel); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 2rem; margin: 2rem 0; text-align: left;">
            <h3 style="color: var(--accent); margin-bottom: 1.5rem; text-align: center;">
                <i class="fas fa-info-circle"></i> Registration Details
            </h3>
            
            <div style="display: grid; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--muted);">Team Name:</span>
                    <span style="font-weight: 600; color: var(--copy);">${teamData.teamName}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--muted);">Tournament:</span>
                    <span style="font-weight: 600; color: var(--copy);">${currentTournament.title}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--muted);">Registration Date:</span>
                    <span style="font-weight: 600; color: var(--copy);">${new Date().toLocaleDateString('en-IN')}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--muted);">Team Captain:</span>
                    <span style="font-weight: 600; color: var(--copy);">${teamData.captainName || teamData.players?.[0]?.name || 'N/A'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0;">
                    <span style="color: var(--muted);">Players:</span>
                    <span style="font-weight: 600; color: var(--copy);">${teamData.players?.length || 0} members</span>
                </div>
            </div>
        </div>
        
        <!-- Next Steps -->
        <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: var(--radius); padding: 1.5rem; margin: 2rem 0;">
            <h4 style="color: var(--accent); margin-bottom: 1rem;">
                <i class="fas fa-lightbulb"></i> What's Next?
            </h4>
            <ul style="text-align: left; color: var(--copy); line-height: 1.8; list-style: none; padding: 0;">
                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #10b981; margin-right: 0.5rem;"></i> Check your email for confirmation details</li>
                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #10b981; margin-right: 0.5rem;"></i> Join our Discord server for updates</li>
                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #10b981; margin-right: 0.5rem;"></i> Review tournament rules and schedule</li>
                <li><i class="fas fa-check" style="color: #10b981; margin-right: 0.5rem;"></i> Prepare for the tournament matches</li>
            </ul>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
            <a href="tournament-details.html?slug=${currentTournament.slug}" 
               style="background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #000; padding: 0.75rem 2rem; border-radius: var(--radius); font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                <i class="fas fa-trophy"></i> View Tournament Details
            </a>
            
            <a href="tournaments.html" 
               style="background: rgba(255, 255, 255, 0.1); color: var(--copy); padding: 0.75rem 2rem; border-radius: var(--radius); font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease;">
                <i class="fas fa-list"></i> Browse More Tournaments
            </a>
            
            <a href="index.html" 
               style="background: rgba(255, 255, 255, 0.05); color: var(--muted); padding: 0.75rem 2rem; border-radius: var(--radius); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div>
    </div>
`;
}

// --- EVENT LISTENERS ---
// Profile dropdown functionality

document.addEventListener('DOMContentLoaded', async () => {

// Test API connection first
await testApiConnection();

// Load tournament data
loadTournamentData();

// Check registration status
checkRegistrationStatus();

// Player rows will be generated when tournament data loads
// generatePlayerRows() is called from updateTournamentDisplay()

// Form submission
// CHANGE this line in your submit event listener
document.getElementById('registration-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    // This is the only line that changes
    submitRegistrationAndInitiatePayment(formData);
});

// Add player button
document.getElementById('add-player-btn').addEventListener('click', addPlayer);

// Check user authentication
// User info is handled by the profile dropdown in the header
const sessionData = getSessionData();
if (sessionData && sessionData.user) {
    console.log('User logged in:', sessionData.user.username || sessionData.user.email);
}
});

// Check if user is already registered
async function checkRegistrationStatus() {
const sessionData = getSessionData();
if (!sessionData || !sessionData.token) {
return; // Not logged in, can't check status
}

const tournamentSlug = new URLSearchParams(window.location.search).get('slug');
if (!tournamentSlug) {
return; // No tournament specified
}

try {
const response = await fetch(`${API_BASE_URL}/api/tournaments/${tournamentSlug}/registration-status`, {
headers: {
'Authorization': `Bearer ${sessionData.token}`,
'Content-Type': 'application/json'
}
});

if (response.ok) {
const result = await response.json();
if (result.success && result.data.isRegistered) {
// User is already registered
showAlreadyRegistered(result.data);
}
}
} catch (error) {
console.error('Error checking registration status:', error);
// Don't block the page if status check fails
}
}

function showAlreadyRegistered(registrationData) {
const formContainer = document.querySelector('.registration-form');
formContainer.innerHTML = `
<div class="already-registered">
<div class="success-icon">
<i class="fas fa-check-circle"></i>
</div>
<h2>Already Registered!</h2>
<p>You are already registered for this tournament with team <strong>"${registrationData.teamName}"</strong>.</p>
<p>Registration Date: ${new Date(registrationData.registrationDate).toLocaleDateString()}</p>
<div class="registration-actions">
<a href="tournament-details.html?slug=${new URLSearchParams(window.location.search).get('slug')}" class="btn btn-primary">
<i class="fas fa-arrow-left"></i> Back to Tournament
</a>
<a href="team-dashboard.html?tournament=${new URLSearchParams(window.location.search).get('slug')}" class="btn btn-secondary">
<i class="fas fa-users"></i> View Team Dashboard
</a>
</div>
</div>
`;
}


</script>
<script src="navbar.js"></script>
</body>
</html>