<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | GamingNexus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="navbar.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* =========================
           Theme variables (Cyberpunk)
           ========================= */
        :root {
            --primary-color: #0f85d3;
            /* Electric Cyan */
            --bg-dark: #0D0A1A;
            /* Dark Matter Black */
            --accent-secondary: #5D3FD3;
            /* Deep Indigo */
            --panel: #161329;
            /* Dark Indigo Panel */
            --text-primary: #F0F0F0;
            /* Starlight White */
            --text-secondary: rgba(240, 240, 240, 0.7);
            --border-color: rgba(10, 250, 217, 0.2);
            --ease: 0.3s ease;
            --radius: 12px;
            --container: 1200px;
            --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);

            /* Legacy variables for compatibility */
            --copy: var(--text-primary);
            --muted: var(--text-secondary);
            --accent: var(--accent-secondary);
            --accent-2: var(--primary-color);
        }

        /* Loader */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- INLINED NAVBAR.CSS --- */
        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--copy);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .profile-icon:hover {
            color: var(--accent);
            background: rgba(255, 69, 0, 0.1);
            transform: scale(1.1);
        }

        .profile-modal {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            margin-top: 10px;
        }

        .profile-dropdown:hover .profile-modal {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-photo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .profile-info .profile-username {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .profile-actions {
            padding: 0.5rem;
        }

        .profile-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--muted);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            width: 100%;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        .profile-action:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
            transform: translateX(4px);
        }

        .logout-action:hover {
            background: rgba(255, 0, 0, 0.1);
            color: #ff6b6b;
        }

        .primary {
            display: flex;
            align-items: center;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-links a {
            font-weight: 600;
            font-size: 1rem;
            color: var(--muted);
            transition: color 0.3s ease;
            position: relative;
            padding-bottom: 4px;
            text-decoration: none;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .nav-links a:hover {
            color: var(--copy);
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .nav-links a.active {
            color: var(--copy);
        }

        /* --- END OF INLINED NAVBAR.CSS --- */

        /* Base Resets */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: "Inter", system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main Content Area */
        .main-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2.5rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .brand {
            font-weight: 800;
            font-size: 1.5rem;
            text-decoration: none;
            color: var(--text-primary);
        }

        .brand .accent {
            color: var(--primary-color);
        }

        .nav-separator {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
        }

        .content-body {
            padding: 2.5rem;
        }

        /* Dashboard Sections */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .dashboard-section {
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Tab System Styles */
        .operation-tabs {
            display: flex;
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 2.5rem;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: var(--text-primary);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.2);
        }

        #operation-content {
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .operation-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Tournament List */
        .admin-tournament-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .admin-tournament-item {
            display: grid;
            grid-template-columns: 2fr auto auto auto;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .admin-tournament-item:hover {
            background: rgba(255, 69, 0, 0.05);
            border-color: var(--border-color);
        }

        .admin-tournament-info .name {
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        .admin-tournament-info .name:hover {
            color: var(--primary-color);
        }

        .admin-tournament-info .game {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tournament-participants,
        .tournament-prize {
            text-align: right;
            color: var(--text-secondary);
        }

        .tournament-prize {
            font-weight: 700;
            color: var(--primary-color);
        }

        .tournament-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .btn-icon:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-icon.delete:hover {
            color: #ff8b8b;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2);
        }

        .submit-btn {
            width: 100%;
            padding: 0.85rem;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
        }

        .submit-btn:hover {
            background: #ff6347;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background-color: #333;
            border: 1px solid #555;
        }

        .btn-secondary:hover {
            background-color: #444;
        }

        .btn-info {
            background-color: #17a2b8;
            border: 1px solid #17a2b8;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-warning {
            background-color: #ffc107;
            border: 1px solid #ffc107;
            color: #1a1a1a;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .operation-title-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .operation-title-header .operation-title {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: 600;
            cursor: pointer;
            line-height: 1;
            padding: 0 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Drag and Drop Styles */
        .schedule-event {
            cursor: grab;
            user-select: none;
        }

        .schedule-event.dragging {
            opacity: 0.5;
            background: rgba(255, 69, 0, 0.1);
        }

        /* Enhanced Responsive Design */
        @media (min-width: 1200px) {
            .content-body {
                padding: 2.5rem 3rem;
                max-width: 1400px;
                margin: 0 auto;
            }

            .dashboard-grid {
                grid-template-columns: 2.5fr 1fr;
                gap: 2rem;
            }

            .admin-tournament-item {
                grid-template-columns: 3fr auto auto auto;
                gap: 2rem;
                padding: 1.25rem;
            }
        }

        @media (min-width: 1440px) {
            .content-body {
                padding: 3rem 4rem;
                max-width: 1600px;
            }

            .operation-tabs {
                max-width: 1200px;
                margin: 2.5rem auto 0;
            }

            #operation-content {
                max-width: 1200px;
                margin: 1.5rem auto 0;
                padding: 2.5rem;
            }
        }

        @media (min-width: 1920px) {
            .content-body {
                padding: 3rem 6rem;
                max-width: 1800px;
            }

            .dashboard-grid {
                gap: 2.5rem;
            }

            .admin-header {
                padding: 0 6rem;
            }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .admin-header {
                padding: 0 1.5rem;
            }

            .nav-links {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .content-body {
                padding: 1.5rem;
            }

            .admin-tournament-item {
                grid-template-columns: 1fr;
                gap: 1rem;
                text-align: center;
            }

            .tournament-actions {
                justify-content: center;
            }
        }

        /* Enhanced Form Layouts for Large Screens */
        @media (min-width: 1200px) {
            .form-group {
                margin-bottom: 1.25rem;
            }

            .form-input,
            .form-textarea,
            .form-select {
                padding: 0.875rem 1.25rem;
                font-size: 1rem;
            }

            #create-tournament-form,
            #update-tournament-form {
                max-width: 1000px;
                margin: 0 auto;
            }

            .form-actions {
                max-width: 400px;
                margin: 2rem auto 0;
            }
        }

        @media (min-width: 1440px) {

            .form-input,
            .form-textarea,
            .form-select {
                padding: 1rem 1.5rem;
            }
        }

        /* Enhanced Dashboard Layout */
        @media (min-width: 1200px) {
            .dashboard-section {
                padding: 2rem;
            }

            .section-header {
                margin-bottom: 2rem;
            }

            .section-title {
                font-size: 1.35rem;
            }
        }

        @media (min-width: 1440px) {
            .dashboard-section {
                padding: 2.5rem;
            }
        }

        /* Enhanced Tab System */
        @media (min-width: 1200px) {
            .operation-tabs {
                padding: 0.75rem;
            }

            .tab-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1440px) {
            .tab-btn {
                padding: 1.25rem 2rem;
            }
        }

        /* Tournament List Enhancements */
        @media (min-width: 1200px) {
            .admin-tournament-info .name {
                font-size: 1.1rem;
            }

            .admin-tournament-info .game {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }

            .tournament-participants,
            .tournament-prize {
                font-size: 1rem;
            }

            .tournament-prize {
                font-size: 1.1rem;
            }
        }

        /* Additional Mobile Improvements */
        @media (max-width: 480px) {
            .operation-tabs {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .tab-btn {
                padding: 1rem;
                text-align: center;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .dashboard-section {
                padding: 1rem;
            }
        }

        /* Improve form grid layouts on medium screens */
        @media (max-width: 900px) {
            .form-input[style*="grid-template-columns"] {
                display: block !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Responsive Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Additional Mobile Improvements */
        @media (max-width: 480px) {
            .operation-tabs {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .tab-btn {
                padding: 1rem;
                text-align: center;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .dashboard-section {
                padding: 1rem;
            }
        }

        /* Custom Scrollbar Design */
        .scrollbar {
            margin-left: 30px;
            float: left;
            height: 300px;
            width: 65px;
            background: #F5F5F5;
            overflow-y: scroll;
            margin-bottom: 25px;
        }

        .force-overflow {
            min-height: 450px;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar-track {
            border: 1px solid var(--border-color);
            background-color: var(--bg-dark);
        }

        ::-webkit-scrollbar {
            width: 10px;
            background-color: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--panel);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-secondary);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--panel) var(--bg-dark);
        }
    </style>
</head>

<body>
    <div id="loader-wrapper">
        <dotlottie-wc src="https://lottie.host/f3668d34-e871-48f2-89e1-a802d02b8429/2gMMYTNzAd.lottie"
            style="width: 300px;height: 300px" autoplay loop></dotlottie-wc>
    </div>

    <div class="main-content-wrapper">
        <header class="admin-header">
            <div class="header-left">
                <a href="index.html" class="brand">GamingNexus</a>
            </div>
            <div class="header-right">
                <nav class="primary">
                    <div class="nav-links">
                        <a href="#" class="active">Dashboard</a>
                        <a href="#manage-tournaments-section">Manage Tournaments</a>
                        <a href="tournaments.html">Browse Tournaments</a>
                        <a href="admin-dispute-management.html">Disputes & Support</a>
                    </div>
                </nav>
                <div class="nav-separator"></div>
                <div id="user-menu" style="display: none;">
                    <div class="profile-dropdown">
                        <div class="profile-icon" id="profile-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="profile-modal" id="profile-modal">
                            <div class="profile-header">
                                <div class="profile-photo"><i class="fas fa-user-shield"></i></div>
                                <div class="profile-info">
                                    <div class="profile-username" id="modal-username">Admin</div>
                                    <div class="profile-userid" id="modal-userid">ID: Loading...</div>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <a href="#" class="profile-action">
                                    <i class="fas fa-user-cog"></i>
                                    <span>My Account</span>
                                </a>
                                <button class="profile-action logout-action" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="content-body">
            <div class="dashboard-grid">
                <div class="dashboard-section" id="manage-tournaments-section">
                    <div class="section-header">
                        <h3 class="section-title">Manage Tournaments</h3>
                    </div>
                    <div class="admin-tournament-list" id="admin-tournament-list">
                        <!-- Tournament list will be injected here -->
                    </div>
                </div>
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Activity</h3>
                    </div>
                    <div class="activity-list" id="activity-list">
                        <!-- Activity items will be injected here -->
                    </div>
                </div>
            </div>

            <div class="operation-tabs">
                <button class="tab-btn active" data-operation="create">Create Tournament</button>
                <button class="tab-btn" data-operation="update">Update Tournament</button>
                <button class="tab-btn" data-operation="delete">Delete Tournament</button>
                <button class="tab-btn" data-operation="download">Download Data</button>
                <button class="tab-btn" data-operation="finalists">Update Finalists</button>
            </div>

            <div id="operation-content">
                <!-- Content is dynamically rendered here -->
            </div>
        </main>
    </div>

    <script>
        // --- INLINED NAVBAR.JS ---
        function redirectToAuth(tab = 'register') { const returnUrl = encodeURIComponent(window.location.href); window.location.href = `auth.html?tab=${tab}&returnUrl=${returnUrl}`; }
        function getSessionData() { const session = localStorage.getItem('nexus_session') || sessionStorage.getItem('nexus_session'); try { return session ? JSON.parse(session) : null; } catch (error) { return null; } }
        function logout() { localStorage.removeItem('nexus_session'); sessionStorage.removeItem('nexus_session'); window.location.reload(); }
        function checkUserAuthentication() {
            const sessionData = getSessionData();
            const userMenu = document.getElementById('user-menu');
            const user = sessionData?.data?.user || sessionData?.user;
            if (user) {
                document.getElementById('modal-username').textContent = user.username || user.email;
                const useridElement = document.getElementById('modal-userid');
                if (useridElement && user.id) {
                    useridElement.textContent = `ID: ${user.id}`;
                }
                if (userMenu) userMenu.style.display = 'flex';
            } else {
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        // --- DASHBOARD JAVASCRIPT ---
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const API_BASE_URL = isLocal ? 'http://localhost:8000' : 'https://t2-237c.onrender.com';

        const mockTournament = {
            _id: "mock123", title: "Dev Test Championship", game: "Valorant", slug: "dev-test-championship", description: "This is a mock tournament for development and testing purposes.",
            registrationStart: "2025-09-20T10:00:00", registrationEnd: "2025-09-30T23:59:00", tournamentStart: "2025-10-05T12:00:00", tournamentEnd: "2025-10-07T22:00:00",
            prizePool: 50000, maxTeams: 64, participant_count: 27, format: "single-elimination", posterImage: "https://placehold.co/600x400/1a1a1a/ff4500?text=Dev+Tournament", status: "registration_open",
            participants: [
                { teamName: "Mock Team A", players: [{ name: "Player 1", email: "p1@mock.com", inGameId: "MockP1", isCaptain: true }, { name: "Player 2", email: "p2@mock.com", inGameId: "MockP2" }] },
                { teamName: "Mock Team B", players: [{ name: "Player 3", email: "p3@mock.com", inGameId: "MockP3", isCaptain: true }] }
            ], entryFee: 100, maxPlayersPerTeam: 5,
            scheduleEvents: [
                { title: "Check-in Opens", description: "Teams must check in", date: "2025-10-05", time: "11:00:00" },
                { title: "Round 1 Begins", description: "First set of matches", date: "2025-10-05", time: "12:00:00" }
            ]
        };
        let adminTournaments = [mockTournament];

        const operationTemplates = {
            create: () => `...`, // This will be handled by a dedicated function for clarity
            update: () => `
                <h3 class="operation-title">Update Tournament</h3>
                <p>Select a tournament from the list below to edit its details.</p>
                <div id="update-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
            `,
            delete: () => `...`,
            download: () => `...`
        };

        function checkAdminAuth() {
            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) { console.warn("Auth check: No session data found."); return false; }
            const user = sessionData?.data?.user || sessionData?.user;
            if (!user || user.role !== 'admin') { console.warn("Auth check: User is not an admin."); return false; }
            return true;
        }

        async function loadRecentActivity() {
            const activityList = document.getElementById('activity-list');
            if (activityList) activityList.innerHTML = '<p>Recent activity will be shown here.</p>';
        }

        async function loadAdminTournaments() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments`, { headers: { 'Authorization': `Bearer ${getSessionData()?.token}` } });
                const result = await response.json();
                if (response.ok && result.success && Array.isArray(result.data) && result.data.length > 0) {
                    const realTournaments = result.data.filter(t => t.slug !== 'dev-test-championship');


                    // Log schedule events for each real tournament
                    realTournaments.forEach(t => {
                    });

                    adminTournaments = [mockTournament, ...realTournaments];
                } else {
                    adminTournaments = [mockTournament];
                }
            } catch (error) {
                console.error('Error loading real tournaments:', error);
                adminTournaments = [mockTournament];
                console.warn('Displaying mock data only due to network or server error.');
            }
            renderTournamentList('admin-tournament-list', adminTournaments, 'manage');
            const activeTabOperation = document.querySelector('.tab-btn.active')?.dataset.operation;
            if (activeTabOperation) renderOperation(activeTabOperation);
        }

        async function deleteTournament(event, slug) {
            event.stopPropagation();
            if (slug === 'dev-test-championship') {
                alert("This is a mock tournament and cannot be deleted via API.");
                return;
            }
            // The confirm dialog is removed as this function is now only called from the 'Delete' tab, which is an explicit user action.
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${getSessionData()?.token}` }
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Tournament deleted successfully!');
                    loadAdminTournaments();
                } else {
                    throw new Error(result.detail || 'Failed to delete tournament.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function updateStatus(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                alert('Tournament not found!');
                return;
            }
            renderOperation('statusUpdate', tournament);
        }

        function updateSchedule(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);

            if (!tournament) {
                alert('Tournament not found!');
                return;
            }


            renderOperation('scheduleUpdate', tournament);
        }

        function editTournament(slug) {
            if (slug === 'dev-test-championship') {
            }
            const tournamentToEdit = adminTournaments.find(t => t.slug === slug);
            if (!tournamentToEdit) {
                alert('Tournament not found!');
                return;
            }
            renderOperation('edit', tournamentToEdit);
        }

        function viewTournamentBrackets(slug) {
            // Find the tournament to get its details
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                alert('Tournament not found!');
                return;
            }

            // Check if tournament has participants
            const participantCount = tournament.participants ? tournament.participants.length : 0;
            if (participantCount === 0) {
                alert('This tournament has no registered teams yet. Brackets will be available once teams register.');
                return;
            }

            // Open brackets view in same tab
            const bracketsUrl = `tournament-brackets.html?slug=${slug}`;
            window.location.href = bracketsUrl;
            
            // Alternative: Show brackets in a modal (uncomment if you prefer modal view)
            // showBracketsModal(tournament);
        }

        // Optional: Function to show brackets in a modal instead of new page
        function showBracketsModal(tournament) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; overflow: auto;">
                    <div class="modal-header">
                        <h3>Tournament Brackets - ${tournament.title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="brackets-container">
                            <p>Loading brackets...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load brackets data here
            loadTournamentBrackets(tournament.slug, 'brackets-container');
        }

        function renderTournamentList(containerId, tournaments, actionType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!tournaments || tournaments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 1.5rem 0;">No tournaments to display.</p>';
                return;
            }
            container.innerHTML = tournaments.map(t => {
                const title = t.title || t.name || "Untitled";
                const participants = `${t.participant_count || (t.participants?.length || 0)} / ${t.maxTeams || t.max_participants || 'N/A'}`;
                const prize = `₹${(t.prizePool || t.prize_pool || 0).toLocaleString()}`;
                let actionsHtml = '';
                switch (actionType) {
                    case 'manage':
                        actionsHtml = `
                            <a href="details.html?slug=${t.slug}" class="btn-icon" title="Manage"><i class="fas fa-arrow-right"></i></a>
                            <button class="btn-icon" onclick="viewTournamentBrackets('${t.slug}')" title="View Brackets"><i class="fas fa-sitemap"></i></button>
                            <button class="btn-icon" onclick="editTournament('${t.slug}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            `;
                        break;
                    case 'update':
                        actionsHtml = `
                            <button class="submit-btn" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="editTournament('${t.slug}')">Edit Details</button>
                            <button class="submit-btn btn-info" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="updateStatus('${t.slug}')">Update Status</button>
                            <button class="submit-btn btn-warning" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="updateSchedule('${t.slug}')">Update Schedule</button>
                            <button class="submit-btn btn-success" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1; background-color: #28a745;" onclick="viewTournamentBrackets('${t.slug}')">View Brackets</button>
                        `;
                        break;
                    case 'delete':
                        actionsHtml = `<button class="submit-btn delete" style="width:auto; padding: 0.5rem 1rem; margin-top:0; background-color: #c82333;" onclick="deleteTournament(event, '${t.slug}')">Confirm Delete</button>`;
                        break;
                    case 'download':
                        actionsHtml = `
                            <button class="btn-icon" onclick="downloadData('${t.slug}', 'excel')" title="Download Excel"><i class="fas fa-file-excel" style="font-size: 1.2rem; color: #28a745;"></i></button>
                            <button class="btn-icon" onclick="downloadData('${t.slug}', 'pdf')" title="Download PDF"><i class="fas fa-file-pdf" style="font-size: 1.2rem; color: #dc3545;"></i></button>`;
                        break;
                    case 'finalists':
                        actionsHtml = `<button class="submit-btn btn-warning" style="padding: 0.5rem 1rem; margin-top:0; width:auto;" onclick="manageFinalists('${t.slug}')">Manage Finalists</button>`;
                        break;
                }
                return `
                    <div class="admin-tournament-item">
                        <div class="admin-tournament-info">
                            <a href="details.html?slug=${t.slug}" class="name">${title}</a><div class="game">${t.game}</div>
                        </div>
                        <div class="tournament-participants">${participants}</div><div class="tournament-prize">${prize}</div><div class="tournament-actions">${actionsHtml}</div>
                    </div>`;
            }).join('');
        }
        function manageFinalists(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                alert('Tournament not found!');
                return;
            }
            renderOperation('finalistsEditor', tournament);
        }

        function downloadData(slug, format) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                alert("Tournament not found!");
                return;
            }

            const participants = tournament.participants || [];
            if (participants.length === 0) {
                alert("This tournament has no registered participants to export.");
                return;
            }

            if (format === 'excel') {
                const headers = ["Team Name", "Player Name", "In-Game ID", "Email", "Captain?"];
                const rows = [];

                participants.forEach(team => {
                    (team.players || []).forEach(player => {
                        rows.push([
                            team.teamName || "N/A",
                            player.name || "N/A",
                            player.inGameId || "N/A",
                            player.email || "N/A",
                            player.isCaptain ? "Yes" : "No"
                        ]);
                    });
                });

                let csvContent = "data:text/csv;charset=utf-8,"
                    + headers.join(",") + "\n"
                    + rows.map(e => e.join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${slug}_participants.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text(`Participants for ${tournament.title}`, 14, 16);

                const headers = ["S.No", "Team Name", "Team Members", "In-Game ID", "Email"];
                const rows = [];
                let serialNo = 1;

                participants.forEach(team => {
                    const players = team.players || [];
                    const teamName = team.teamName || "N/A";

                    players.forEach((player, index) => {
                        rows.push([
                            index === 0 ? serialNo.toString() : "", // S.No only on first player of team
                            index === 0 ? teamName : "", // Team name only on first player of team
                            player.name || "N/A",
                            player.inGameId || "N/A",
                            player.email || "N/A"
                        ]);
                    });
                    serialNo++;
                });

                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 25
                });
                doc.save(`${slug}_participants.pdf`);
            }
        }

        function removeScheduleEvent(button) {
            const eventDiv = button.closest('.schedule-event');
            eventDiv.remove();

            // Check if no events left, show placeholder
            const container = document.getElementById('schedule-events-container');
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--muted); margin: 1rem 0;">No schedule events yet. Click "Add Event" to create one.</p>';
            }
        }

        function getCreateFormHTML() {
            return `
                <h3 class="operation-title">Create New Tournament</h3>
                <form id="create-tournament-form">
                    <div class="form-group"><label for="tournament-name" class="form-label">Tournament Name</label><input type="text" id="tournament-name" name="title" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-game" class="form-label">Game</label><input type="text" id="tournament-game" name="game" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-details" class="form-label">Description</label><textarea id="tournament-details" name="description" class="form-textarea" required></textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="reg-start-date" class="form-label">Registration Start</label><input type="datetime-local" id="reg-start-date" name="registrationStart" class="form-input" required></div>
                        <div class="form-group"><label for="reg-end-date" class="form-label">Registration End</label><input type="datetime-local" id="reg-end-date" name="registrationEnd" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-start-date" class="form-label">Tournament Start</label><input type="datetime-local" id="tournament-start-date" name="tournamentStart" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-end-date" class="form-label">Tournament End</label><input type="datetime-local" id="tournament-end-date" name="tournamentEnd" class="form-input" required></div>
                        <div class="form-group"><label for="prize-pool" class="form-label">Prize Pool (₹)</label><input type="number" id="prize-pool" name="prizePool" class="form-input" min="0" required></div>
                        <div class="form-group"><label for="num-teams" class="form-label">Number of Teams</label><input type="number" id="num-teams" name="maxTeams" class="form-input" min="2" required></div>
                        <div class="form-group"><label for="entry-fee" class="form-label">Entry Fee (₹)</label><input type="number" id="entry-fee" name="entryFee" class="form-input" min="0" value="0" required></div>
                        <div class="form-group"><label for="max-players" class="form-label">Max Players per Team</label><input type="number" id="max-players" name="maxPlayersPerTeam" class="form-input" min="1" value="4" required></div>
                    </div>
                    <div class="form-group"><label for="tournament-format" class="form-label">Format</label><select id="tournament-format" name="format" class="form-select" required><option value="single-elimination">Single Elimination</option><option value="kp">KP Format</option></select></div>
                    <div id="kp-format-fields" style="display: none;">
                        <h4 class="form-label" style="margin-top: 1.5rem; margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">KP Format Schedule</h4>
                        <div class="form-grid">
                        <div class="form-group"><label for="qualifier1-date" class="form-label">Qualifier 1 Date</label><input type="datetime-local" id="qualifier1-date" name="qualifier1Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier2-date" class="form-label">Qualifier 2 Date</label><input type="datetime-local" id="qualifier2-date" name="qualifier2Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier3-date" class="form-label">Qualifier 3 Date</label><input type="datetime-local" id="qualifier3-date" name="qualifier3Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier4-date" class="form-label">Qualifier 4 Date</label><input type="datetime-local" id="qualifier4-date" name="qualifier4Date" class="form-input"></div>
                        <div class="form-group"><label for="final-match-date" class="form-label">Final Match Date</label><input type="datetime-local" id="final-match-date" name="finalMatchDate" class="form-input"></div>
                        </div>
                    </div>
                    <div class="form-group"><label for="tournament-poster" class="form-label">Poster Image</label><input type="file" id="tournament-poster" name="posterImage" class="form-input" accept="image/*"></div>
                    <button type="submit" class="submit-btn">Create Tournament</button>
                </form>
            `;
        }

        function getUpdateFormHTML(t) {
            const formattedDate = (iso) => iso ? iso.slice(0, 16) : '';
            const kpSettings = t.kpSettings || {};
            const schedule = kpSettings.matchSchedule || [];
            const findDate = (name) => schedule.find(m => m.match === name)?.date || '';

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Editing: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel Editing">&times;</button>
                </div>
                <form id="update-tournament-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    <div class="form-group"><label class="form-label">Tournament Name</label><input type="text" name="title" class="form-input" value="${t.title || ''}" required></div>
                    <div class="form-group"><label class="form-label">Game</label><input type="text" name="game" class="form-input" value="${t.game || ''}" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea name="description" class="form-textarea" required>${t.description || ''}</textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Registration Start</label><input type="datetime-local" name="registrationStart" class="form-input" value="${formattedDate(t.registrationStart)}" required></div>
                        <div class="form-group"><label class="form-label">Registration End</label><input type="datetime-local" name="registrationEnd" class="form-input" value="${formattedDate(t.registrationEnd)}" required></div>
                        <div class="form-group"><label class="form-label">Tournament Start</label><input type="datetime-local" name="tournamentStart" class="form-input" value="${formattedDate(t.tournamentStart)}" required></div>
                        <div class="form-group"><label class="form-label">Tournament End</label><input type="datetime-local" name="tournamentEnd" class="form-input" value="${formattedDate(t.tournamentEnd)}" required></div>
                        <div class="form-group"><label class="form-label">Prize Pool (₹)</label><input type="number" name="prizePool" class="form-input" value="${t.prizePool || 0}" min="0" required></div>
                        <div class="form-group"><label class="form-label">Max Teams</label><input type="number" name="maxTeams" class="form-input" value="${t.maxTeams || 2}" min="2" required></div>
                        <div class="form-group"><label class="form-label">Entry Fee (₹)</label><input type="number" name="entryFee" class="form-input" value="${t.entryFee || 0}" min="0" required></div>
                        <div class="form-group"><label class="form-label">Max Players/Team</label><input type="number" name="maxPlayersPerTeam" class="form-input" value="${t.maxPlayersPerTeam || 4}" min="1" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Format</label>
                        <select name="format" class="form-select" id="update-tournament-format" required>
                            <option value="single-elimination" ${t.format === 'single-elimination' ? 'selected' : ''}>Single Elimination</option>
                            <option value="kp" ${t.format === 'kp' ? 'selected' : ''}>KP Format</option>
                        </select>
                    </div>
                    <div id="update-kp-format-fields" style="display: ${t.format === 'kp' ? 'block' : 'none'};">
                        <h4 class="form-label" style="margin-top: 1.5rem; margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">KP Format Schedule</h4>
                        <div class="form-grid">
                        <div class="form-group"><label class="form-label">Qualifier 1</label><input type="datetime-local" name="qualifier1Date" class="form-input" value="${formattedDate(findDate('Qualifier 1'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 2</label><input type="datetime-local" name="qualifier2Date" class="form-input" value="${formattedDate(findDate('Qualifier 2'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 3</label><input type="datetime-local" name="qualifier3Date" class="form-input" value="${formattedDate(findDate('Qualifier 3'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 4</label><input type="datetime-local" name="qualifier4Date" class="form-input" value="${formattedDate(findDate('Qualifier 4'))}"></div>
                        <div class="form-group"><label class="form-label">Final Match</label><input type="datetime-local" name="finalMatchDate" class="form-input" value="${formattedDate(findDate('Final Match'))}"></div>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">New Poster Image (Optional)</label><input type="file" name="posterImage" class="form-input" accept="image/*"></div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Save Changes</button>
                    </div>
                </form>
            `;
        }


        function getUpdateStatusHTML(t) {
            const statuses = ['upcoming', 'registration_open', 'registration_closed', 'ongoing', 'ended'];
            const options = statuses.map(s =>
                `<option value="${s}" ${t.status === s ? 'selected' : ''}>
                    ${s.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </option>`
            ).join('');
            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Update Status: ${t.title || t.name}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel">&times;</button>
                </div>
                <form id="update-status-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    <div class="form-group">
                        <label class="form-label">New Status</label>
                        <select name="status" class="form-select">${options}</select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Save Status</button>
                    </div>
                </form>
            `;
        }

        function getUpdateScheduleHTML(t) {

            const scheduleEvents = t.scheduleEvents || [];
            const eventsHtml = scheduleEvents.map((event, index) => {
                let eventDateTime = '';

                if (event.datetime) {
                    // Handle ISO datetime format
                    eventDateTime = event.datetime.slice(0, 16);
                } else if (event.date && event.time) {
                    // Handle separate date and time fields (like your mock data)
                    const timeStr = event.time.slice(0, 5); // "11:00:00" becomes "11:00"
                    eventDateTime = `${event.date}T${timeStr}`; // "2025-10-05T11:00"
                }

                return `
                    <div class="schedule-event" draggable="true" data-index="${index}" style="border:1px solid var(--border-color); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <div class="form-group">
                            <label class="form-label">Event Title</label>
                            <input type="text" name="events[${index}][title]" class="form-input" value="${event.title || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description (1 line)</label>
                            <input type="text" name="events[${index}][description]" class="form-input" value="${event.description || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date & Time</label>
                            <input type="datetime-local" name="events[${index}][datetime]" class="form-input" value="${eventDateTime}" required>
                        </div>
                        <button type="button" class="btn-icon delete" onclick="removeScheduleEvent(this)" style="float: right; color: #ff6b6b;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Update Schedule: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel">&times;</button>
                </div>
                <form id="update-schedule-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    
                    <div id="schedule-events-container">
                        ${eventsHtml || '<p style="text-align:center; color: var(--muted); margin: 1rem 0;">No schedule events yet. Click "Add Event" to create one.</p>'}
                    </div>
                    
                    <button type="button" class="submit-btn btn-info" onclick="addScheduleEvent()">+ Add Event</button>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Confirm Schedule</button>
                    </div>
                </form>
            `;
        }

        function renderOperation(operationName, data = null) {
            const container = document.getElementById('operation-content');
            if (!container) return;

            let contentHtml = '';
            switch (operationName) {
                case 'create':
                    contentHtml = getCreateFormHTML();
                    break;
                case 'update':
                    contentHtml = `
                        <h3 class="operation-title">Update Tournament</h3>
                        <p>Select a tournament from the list below to edit its details.</p>
                        <div id="update-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'delete':
                    contentHtml = `
                        <h3 class="operation-title">Delete Tournament</h3>
                        <p>Click the trash icon on a tournament in the list above to delete it. This action is permanent.</p>
                        <div id="delete-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'download':
                    contentHtml = `
                        <h3 class="operation-title">Download Tournament Data</h3>
                        <p>Select a tournament and choose a format to download participant data.</p>
                        <div id="download-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'finalists':
                    contentHtml = `
                        <h3 class="operation-title">Update Finalists Leaderboard</h3>
                        <p>Select a tournament to manage its finalists leaderboard (Top 16 teams).</p>
                        <div id="finalists-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'edit':
                    if (data) contentHtml = getUpdateFormHTML(data);
                    break;
                case 'statusUpdate':
                    if (data) contentHtml = getUpdateStatusHTML(data);
                    break;
                case 'scheduleUpdate':
                    if (data) contentHtml = getUpdateScheduleHTML(data);
                    break;
                case 'finalistsEditor':
                    if (data) contentHtml = getFinalistsEditorHTML(data);
                    break;
                default:
                    contentHtml = '<p>Select an operation.</p>';
            }
            container.innerHTML = contentHtml;

            // Post-render logic
            if (operationName === 'create') {
                const form = document.getElementById('create-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleCreateFormSubmit);
                    const formatSelector = form.querySelector('#tournament-format');
                    const kpFields = form.querySelector('#kp-format-fields');
                    formatSelector.addEventListener('change', () => { kpFields.style.display = (formatSelector.value === 'kp') ? 'block' : 'none'; });
                }
            } else if (operationName === 'edit') {
                const form = document.getElementById('update-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleUpdateFormSubmit);
                    const formatSelector = form.querySelector('#update-tournament-format');
                    const kpFields = form.querySelector('#update-kp-format-fields');
                    if (formatSelector && kpFields) {
                        formatSelector.addEventListener('change', () => {
                            kpFields.style.display = (formatSelector.value === 'kp') ? 'block' : 'none';
                        });
                    }
                }
            } else if (operationName === 'statusUpdate') {
                const form = document.getElementById('update-status-form');
                if (form) form.addEventListener('submit', handleStatusUpdateSubmit);
            } else if (operationName === 'scheduleUpdate') {
                const form = document.getElementById('update-schedule-form');
                if (form) {
                    form.addEventListener('submit', handleScheduleUpdateSubmit);
                    initDragAndDrop(); // Initialize drag and drop for the schedule editor
                }
            } else if (['update', 'delete', 'download'].includes(operationName)) {
                renderTournamentList(`${operationName}-tournament-list`, adminTournaments, operationName);
            } else if (operationName === 'finalistsEditor') {
                const form = document.getElementById('update-finalists-form');
                if (form) form.addEventListener('submit', handleFinalistsUpdateSubmit);
            } else if (['update', 'delete', 'download', 'finalists'].includes(operationName)) {
                renderTournamentList(`${operationName}-tournament-list`, adminTournaments, operationName);
            }
        }

        async function handleCreateFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Creating...'; btn.disabled = true;
            try {
                const formData = new FormData();

                // Add all form fields, including file only if selected
                const formElements = form.elements;
                for (let element of formElements) {
                    if (element.type === 'file') {
                        // Only include file if user selected one
                        if (element.files && element.files.length > 0 && element.files[0].size > 0) {
                            formData.append(element.name, element.files[0]);
                        }
                    } else if (element.name && element.value !== undefined) {
                        formData.append(element.name, element.value);
                    }
                }

                const response = await fetch(`${API_BASE_URL}/api/tournaments`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${getSessionData()?.token}` }, body: formData
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Tournament created successfully!');
                    form.reset();
                    loadAdminTournaments();
                } else {
                    throw new Error(result.detail || 'Failed to create tournament.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = 'Create Tournament'; btn.disabled = false;
            }
        }

        async function handleUpdateFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                alert("This is a mock tournament and cannot be updated via API.");
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const formData = new FormData();

                // Add all form fields except file inputs
                const formElements = form.elements;
                for (let element of formElements) {
                    if (element.type === 'file') {
                        // Only include file if user selected one
                        if (element.files && element.files.length > 0 && element.files[0].size > 0) {
                            formData.append(element.name, element.files[0]);
                        }
                    } else if (element.name && element.value !== undefined) {
                        formData.append(element.name, element.value);
                    }
                }

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`
                    },
                    body: formData
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Tournament updated successfully!');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update tournament.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = 'Save Changes';
                btn.disabled = false;
            }
        }


        async function handleScheduleUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                alert("This is a mock tournament. Schedule cannot be updated.");
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('button[type="submit"]');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const events = [];
                const container = document.getElementById('schedule-events-container');
                const eventBlocks = container.querySelectorAll('.schedule-event');

                eventBlocks.forEach(block => {
                    const datetimeValue = block.querySelector('input[name*="[datetime]"]').value;
                    const [date, time] = datetimeValue ? datetimeValue.split('T') : [null, null];

                    events.push({
                        title: block.querySelector('input[name*="[title]"]').value,
                        description: block.querySelector('input[name*="[description]"]').value,
                        datetime: datetimeValue,
                        date: date,
                        time: time ? time + ":00" : null
                    });
                });

                // Use the correct endpoint that now exists
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/schedule`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: events })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Schedule updated successfully!');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update schedule.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = 'Confirm Schedule';
                btn.disabled = false;
            }
        }

        function addScheduleEvent() {
            const container = document.getElementById('schedule-events-container');
            if (!container) return;

            // Remove placeholder if it exists
            const placeholder = container.querySelector('p');
            if (placeholder) placeholder.remove();

            const index = container.children.length;
            const eventHtml = `
                <div class="schedule-event" draggable="true" data-index="${index}" style="border:1px solid var(--border-color); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="events[${index}][title]" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description (1 line)</label>
                        <input type="text" name="events[${index}][description]" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date & Time</label>
                        <input type="datetime-local" name="events[${index}][datetime]" class="form-input" required>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', eventHtml);
        }

        function getFinalistsEditorHTML(t) {
            // Get existing finalists or create empty array for 16 teams
            const finalists = t.finalists || Array.from({ length: 16 }, (_, i) => ({
                position: i + 1,
                teamName: '',
                totalPoints: 0
            }));

            // Ensure we have exactly 16 slots
            while (finalists.length < 16) {
                finalists.push({
                    position: finalists.length + 1,
                    teamName: '',
                    totalPoints: 0
                });
            }
            finalists.splice(16); // Keep only first 16

            const finalistsHtml = finalists.map((finalist, index) => `
                <div class="finalist-entry" style="display: grid; grid-template-columns: 60px 1fr 120px auto; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; background: rgba(0,0,0,0.2);">
                    <div style="font-weight: 700; text-align: center; color: var(--primary-color);">#${index + 1}</div>
                    <div class="form-group" style="margin: 0;">
                        <input type="text" name="finalists[${index}][teamName]" class="form-input" value="${finalist.teamName || ''}" placeholder="Enter team name" style="margin: 0; padding: 0.5rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <input type="number" name="finalists[${index}][totalPoints]" class="form-input" value="${finalist.totalPoints || 0}" placeholder="Points" min="0" style="margin: 0; padding: 0.5rem;">
                    </div>
                    <button type="button" class="btn-icon" onclick="clearFinalistEntry(${index})" title="Clear Entry" style="color: var(--text-secondary);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Finalists Leaderboard: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('finalists')" title="Cancel">&times;</button>
                </div>
                <form id="update-finalists-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 69, 0, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                            Enter the top 16 teams in order of their final ranking. Leave entries blank if fewer than 16 teams made it to finals.
                        </p>
                    </div>
                    
                    <div class="finalists-container">
                        ${finalistsHtml}
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="submit-btn btn-secondary" onclick="autoFillFromParticipants('${t.slug}')">Auto-fill from Participants</button>
                        <button type="submit" class="submit-btn">Save Finalists</button>
                    </div>
                </form>
            `;
        }

        function clearFinalistEntry(index) {
            const container = document.querySelector('.finalists-container');
            const entry = container.children[index];
            if (entry) {
                entry.querySelector('input[name*="[teamName]"]').value = '';
                entry.querySelector('input[name*="[totalPoints]"]').value = '0';
            }
        }

        function autoFillFromParticipants(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament || !tournament.participants) {
                alert('No participants found for this tournament.');
                return;
            }

            const participants = tournament.participants.slice(0, 16); // Get first 16 teams
            const container = document.querySelector('.finalists-container');

            participants.forEach((participant, index) => {
                const entry = container.children[index];
                if (entry) {
                    entry.querySelector('input[name*="[teamName]"]').value = participant.teamName || '';
                }
            });

            alert(`Auto-filled ${participants.length} teams from participants list.`);
        }

        async function handleFinalistsUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                alert("This is a mock tournament. Finalists cannot be updated.");
                renderOperation('finalists');
                return;
            }

            const btn = form.querySelector('button[type="submit"]');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const finalists = [];
                const container = document.querySelector('.finalists-container');
                const entries = container.querySelectorAll('.finalist-entry');

                entries.forEach((entry, index) => {
                    const teamName = entry.querySelector('input[name*="[teamName]"]').value.trim();
                    const totalPoints = parseInt(entry.querySelector('input[name*="[totalPoints]"]').value) || 0;

                    if (teamName) { // Only add non-empty team names
                        finalists.push({
                            position: index + 1,
                            teamName: teamName,
                            totalPoints: totalPoints
                        });
                    }
                });

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/finalists`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ finalists: finalists })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    alert(`Finalists updated successfully! ${finalists.length} teams saved.`);
                    await loadAdminTournaments();
                    renderOperation('finalists');
                } else {
                    throw new Error(result.detail || 'Failed to update finalists.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = 'Save Finalists';
                btn.disabled = false;
            }
        }

        async function handleStatusUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;
            const newStatus = form.querySelector('select[name="status"]').value;

            if (slug === 'dev-test-championship') {
                alert("This is a mock tournament. Status cannot be saved.");
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Tournament status updated successfully!');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update status.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = 'Save Status';
                btn.disabled = false;
            }
        }


        function initDragAndDrop() {
            const container = document.getElementById('schedule-events-container');
            if (!container) return;

            let draggingElement = null;

            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('schedule-event')) {
                    draggingElement = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('schedule-event')) {
                    e.target.classList.remove('dragging');
                    draggingElement = null;
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggingElement) return;

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggingElement);
                } else {
                    container.insertBefore(draggingElement, afterElement);
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.schedule-event:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Hide loader
            setTimeout(() => {
                document.getElementById('loader-wrapper').classList.add('hidden');
            }, 1000);

            checkUserAuthentication();
            renderOperation('create'); // Start with the create form
            loadAdminTournaments(); // Load tournaments in the background
            loadRecentActivity();

            const isAdmin = checkAdminAuth();
            if (!isAdmin) {
                const form = document.getElementById('create-tournament-form');
                if (form) {
                    form.querySelectorAll('input, textarea, select, button').forEach(el => el.disabled = true);
                    const submitBtn = form.querySelector('.submit-btn');
                    if (submitBtn) submitBtn.textContent = 'Admin Privileges Required';
                }
            }

            const tabsContainer = document.querySelector('.operation-tabs');
            tabsContainer.addEventListener('click', (event) => {
                if (event.target.matches('.tab-btn')) {
                    tabsContainer.querySelector('.active')?.classList.remove('active');
                    event.target.classList.add('active');
                    const operation = event.target.dataset.operation;
                    renderOperation(operation);
                }
            });
        });
    </script>
</body>

</html>