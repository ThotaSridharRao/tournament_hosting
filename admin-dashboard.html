<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Uni Games</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" type="image/png" href="ug.png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>


    <style>
        /* =========================
           Theme variables (Cyberpunk)
           ========================= */
        :root {
            --primary-color: #0f85d3;
            /* Electric Cyan */
            --bg-dark: #0D0A1A;
            /* Dark Matter Black */
            --accent-secondary: #5D3FD3;
            /* Deep Indigo */
            --panel: #161329;
            /* Dark Indigo Panel */
            --text-primary: #F0F0F0;
            /* Starlight White */
            --text-secondary: rgba(240, 240, 240, 0.7);
            --border-color: rgba(10, 250, 217, 0.2);
            --ease: 0.3s ease;
            --radius: 12px;
            --container: 1200px;
            --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);

            /* Legacy variables for compatibility */
            --copy: var(--text-primary);
            --muted: var(--text-secondary);
            --accent: var(--accent-secondary);
            --accent-2: var(--primary-color);
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
        }

        /* Loader */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* =========================
        MODERN NAVBAR STYLES
        ========================= */
        .nav-normal {
            background: rgba(13, 10, 26, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.5rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            transform: translateY(0);
        }

        .nav-normal.nav-hidden {
            transform: translateY(-100%);
        }

        .nav-normal.nav-scrolled {
            background: rgba(13, 10, 26, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 80px;
            width: auto;
            margin: 0;
            padding: 0;
            display: block;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 2.5rem;
        }

        .nav-links {
            display: flex;
            gap: 0;
            list-style: none;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            padding: 0.6rem 1.2rem;
            display: block;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: white;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        #user-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
        }

        .menu-icon {
            width: 24px;
            height: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .menu-icon span {
            width: 100%;
            height: 2px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .menu-toggle.active .menu-icon span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .menu-toggle.active .menu-icon span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active .menu-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Mobile Styles */
        @media (max-width: 968px) {
            .menu-toggle {
                display: block;
            }

            .nav-center {
                position: fixed;
                top: 0;
                right: -100%;
                height: 100vh;
                width: 85%;
                max-width: 350px;
                flex-direction: column;
                background: rgba(15, 15, 15, 0.98);
                backdrop-filter: blur(20px);
                padding: 6rem 2rem 2rem;
                gap: 0;
                transition: right 0.3s ease;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                align-items: flex-start;
                overflow-y: auto;
            }

            .nav-center.active {
                right: 0;
            }

            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 0;
            }

            .nav-links li {
                width: 100%;
            }

            .nav-links a {
                padding: 1rem 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .auth-buttons {
                flex-direction: column;
                width: 100%;
                gap: 1rem;
                margin-top: 2rem;
                padding-top: 2rem;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .user-info {
                width: 100%;
                justify-content: center;
            }

            #user-menu {
                display: flex;
                flex-direction: column;
                width: 100%;
                gap: 1rem;
            }
        }

        /* Base Resets */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: "Inter", system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main Content Area */
        .main-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding-top: 90px;
            /* Account for fixed navbar */
        }

        /* Dashboard Sections */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .dashboard-section {
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .section-action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .section-action-btn:hover {
            background: #ff6347;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 133, 211, 0.3);
        }

        .section-action-btn:active {
            transform: translateY(0);
        }

        .section-action-btn.delete-btn {
            background: #dc3545;
        }

        .section-action-btn.delete-btn:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .section-action-btn.brackets-btn {
            background: #6f42c1;
        }

        .section-action-btn.brackets-btn:hover {
            background: #5a32a3;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }



        /* Tab System Styles */
        .operation-tabs {
            display: flex;
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 2.5rem;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: var(--text-primary);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.2);
        }

        #operation-content {
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .operation-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Tournament Cards Layout - Horizontal Single Row */
        .admin-tournament-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .admin-tournament-item {
            display: grid;
            grid-template-columns: 2fr auto auto;
            align-items: center;
            gap: 2rem;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            min-height: 80px;
        }

        .admin-tournament-item:hover {
            background: rgba(255, 69, 0, 0.05);
            border-color: var(--border-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .admin-tournament-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .admin-tournament-info .name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            text-decoration: none;
            line-height: 1.3;
        }

        .admin-tournament-info .name:hover {
            color: var(--primary-color);
        }

        .admin-tournament-info .game {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .tournament-participants {
            color: var(--text-secondary);
            font-size: 0.95rem;
            text-align: right;
            font-weight: 500;
        }

        .tournament-participants::before {
            content: "👥 ";
            margin-right: 0.25rem;
        }

        .tournament-prize {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            text-align: right;
        }

        /* Delete Mode Styles */
        .admin-tournament-list.delete-mode .admin-tournament-item {
            grid-template-columns: 2fr auto auto auto;
        }

        .tournament-delete-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            background: #dc3545;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
            animation: fadeInScale 0.3s ease forwards;
        }

        .tournament-delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        @keyframes fadeInScale {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .schedule-event-item {
            transition: all 0.3s ease;
        }

        .remove-event-btn:hover {
            background: #c82333 !important;
            transform: scale(1.1);
        }

        /* Hide delete buttons by default */
        .admin-tournament-item .tournament-delete-btn {
            display: none;
        }

        /* Show delete buttons in delete mode */
        .admin-tournament-list.delete-mode .tournament-delete-btn {
            display: flex;
        }

        /* Brackets Mode Styles */
        .admin-tournament-list.brackets-mode .admin-tournament-item {
            grid-template-columns: 2fr auto auto auto;
        }

        .tournament-brackets-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            background: #6f42c1;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
            animation: fadeInScale 0.3s ease forwards;
        }

        .tournament-brackets-btn:hover {
            background: #5a32a3;
            transform: scale(1.05);
        }

        /* Hide brackets buttons by default */
        .admin-tournament-item .tournament-brackets-btn {
            display: none;
        }

        /* Show brackets buttons in brackets mode */
        .admin-tournament-list.brackets-mode .tournament-brackets-btn {
            display: flex;
        }

        /* Edit Mode Styles */
        .admin-tournament-list.edit-mode .admin-tournament-item {
            grid-template-columns: 2fr auto auto auto auto;
        }

        .tournament-edit-actions {
            display: none;
            gap: 0.5rem;
            align-items: center;
        }

        .admin-tournament-list.edit-mode .tournament-edit-actions {
            display: flex;
            animation: fadeInScale 0.3s ease forwards;
        }

        .tournament-edit-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tournament-edit-btn.details {
            background: var(--primary-color);
        }

        .tournament-edit-btn.details:hover {
            background: #ff6347;
            transform: scale(1.05);
        }

        .tournament-edit-btn.schedule {
            background: #28a745;
        }

        .tournament-edit-btn.schedule:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .tournament-edit-btn.status {
            background: #ffc107;
            color: #212529;
        }

        .tournament-edit-btn.status:hover {
            background: #e0a800;
            transform: scale(1.05);
        }

        .tournament-edit-btn.finalists {
            background: #6f42c1;
        }

        .tournament-edit-btn.finalists:hover {
            background: #5a32a3;
            transform: scale(1.05);
        }



        .tournament-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .btn-icon:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-icon.delete:hover {
            color: #ff8b8b;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2);
        }

        .submit-btn {
            width: 100%;
            padding: 0.85rem;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
        }

        .submit-btn:hover {
            background: #ff6347;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background-color: #333;
            border: 1px solid #555;
        }

        .btn-secondary:hover {
            background-color: #444;
        }

        .btn-info {
            background-color: #17a2b8;
            border: 1px solid #17a2b8;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-warning {
            background-color: #ffc107;
            border: 1px solid #ffc107;
            color: #1a1a1a;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn {
            padding: 0.65rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .operation-title-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .operation-title-header .operation-title {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: 600;
            cursor: pointer;
            line-height: 1;
            padding: 0 0.75rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Drag and Drop Styles */
        .schedule-event {
            cursor: grab;
            user-select: none;
        }

        .schedule-event.dragging {
            opacity: 0.5;
            background: rgba(255, 69, 0, 0.1);
        }

        /* Payout Management Styles */
        .payout-status-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .payout-status-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .payout-status-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .payout-status-tab[data-status="pending"].active {
            border-bottom-color: var(--color-warning);
            color: var(--color-warning);
        }

        .payout-status-tab[data-status="completed"].active {
            border-bottom-color: var(--color-success);
            color: var(--color-success);
        }

        .payout-status-tab[data-status="failed"].active {
            border-bottom-color: var(--color-danger);
            color: var(--color-danger);
        }

        .payout-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .payout-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 5px solid var(--color-warning);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1.5fr auto;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.3s ease;
        }

        .payout-item.completed {
            border-left-color: var(--color-success);
        }

        .payout-item.failed {
            border-left-color: var(--color-danger);
        }

        .payout-info .title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .payout-info .subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .payout-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-warning);
        }

        .payout-item.completed .payout-amount {
            color: var(--color-success);
        }

        .payout-item.failed .payout-amount {
            color: var(--color-danger);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .payout-host-info {
            font-size: 0.9rem;
        }

        .payout-host-info .email {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .payout-actions {
            display: flex;
            gap: 0.5rem;
        }

        .payout-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .payout-action-btn.approve {
            background: var(--color-success);
            color: var(--text-primary);
        }

        .payout-action-btn.approve:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .payout-action-btn.fail {
            background: var(--color-danger);
            color: var(--text-primary);
        }

        .payout-action-btn.fail:hover {
            background: #c82333;
            transform: translateY(-1px);
        }


        /* Enhanced Responsive Design */
        @media (min-width: 1200px) {
            .content-body {
                padding: 2.5rem 3rem;
                max-width: 1400px;
                margin: 0 auto;
            }

            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }

            .payout-item {
                grid-template-columns: 1.5fr 1fr 1.5fr 1fr;
            }


        }

        @media (min-width: 1440px) {
            .content-body {
                padding: 3rem 4rem;
                max-width: 1600px;
            }

            .operation-tabs {
                max-width: 1200px;
                margin: 2.5rem auto 0;
            }

            #operation-content {
                max-width: 1200px;
                margin: 1.5rem auto 0;
                padding: 2.5rem;
            }
        }

        @media (min-width: 1920px) {
            .content-body {
                padding: 3rem 6rem;
                max-width: 1800px;
            }

            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
                gap: 2.5rem;
            }

            .admin-header {
                padding: 0 6rem;
            }
        }


        @media (max-width: 768px) {
            .content-body {
                padding: 1.5rem;
            }

            .admin-tournament-item {
                grid-template-columns: 1fr;
                gap: 1rem;
                text-align: center;
                padding: 1.25rem;
                min-height: auto;
            }

            /* Payout Mobile Layout */
            .payout-item {
                grid-template-columns: 1fr;
                gap: 1rem;
                text-align: center;
                padding: 1.25rem;
            }

            .payout-amount {
                font-size: 1.5rem;
            }

            .payout-actions {
                justify-content: center;
            }


            .admin-tournament-list.delete-mode .admin-tournament-item {
                grid-template-columns: 1fr;
            }

            .admin-tournament-list.delete-mode .tournament-delete-btn {
                margin: 0.5rem auto 0;
                width: 40px;
                height: 40px;
            }

            .admin-tournament-list.brackets-mode .admin-tournament-item {
                grid-template-columns: 1fr;
            }

            .admin-tournament-list.brackets-mode .tournament-brackets-btn {
                margin: 0.5rem auto 0;
                width: 40px;
                height: 40px;
            }

            .admin-tournament-list.edit-mode .admin-tournament-item {
                grid-template-columns: 1fr;
            }

            .admin-tournament-list.edit-mode .tournament-edit-actions {
                margin: 0.5rem auto 0;
                justify-content: center;
            }

            .admin-tournament-list.edit-mode .tournament-edit-btn {
                width: 40px;
                height: 40px;
            }

            .admin-tournament-info {
                text-align: center;
            }

            .admin-tournament-info .name {
                font-size: 1.1rem;
            }

            .tournament-participants,
            .tournament-prize {
                text-align: center;
                font-size: 0.95rem;
            }

            .tournament-prize {
                font-size: 1.1rem;
            }
        }

        /* Enhanced Form Layouts for Large Screens */
        @media (min-width: 1200px) {
            .form-group {
                margin-bottom: 1.25rem;
            }

            .form-input,
            .form-textarea,
            .form-select {
                padding: 0.875rem 1.25rem;
                font-size: 1rem;
            }

            #create-tournament-form,
            #update-tournament-form {
                max-width: 1000px;
                margin: 0 auto;
            }

            .form-actions {
                max-width: 400px;
                margin: 2rem auto 0;
            }
        }

        @media (min-width: 1440px) {

            .form-input,
            .form-textarea,
            .form-select {
                padding: 1rem 1.5rem;
            }
        }

        /* Enhanced Dashboard Layout */
        @media (min-width: 1200px) {
            .dashboard-section {
                padding: 2rem;
            }

            .section-header {
                margin-bottom: 2rem;
            }

            .section-title {
                font-size: 1.35rem;
            }

            .admin-tournament-item {
                grid-template-columns: 3fr auto auto;
                gap: 2.5rem;
                padding: 1.5rem 2rem;
            }

            .admin-tournament-list.delete-mode .admin-tournament-item {
                grid-template-columns: 3fr auto auto auto;
            }

            .admin-tournament-list.brackets-mode .admin-tournament-item {
                grid-template-columns: 3fr auto auto auto;
            }

            .admin-tournament-list.edit-mode .admin-tournament-item {
                grid-template-columns: 3fr auto auto auto auto;
            }

            .admin-tournament-info .name {
                font-size: 1.2rem;
            }

            .admin-tournament-info .game {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }

            .tournament-participants,
            .tournament-prize {
                font-size: 1rem;
            }

            .tournament-prize {
                font-size: 1.2rem;
            }
        }

        @media (min-width: 1440px) {
            .dashboard-section {
                padding: 2.5rem;
            }

            .admin-tournament-item {
                gap: 3rem;
                padding: 1.75rem 2.5rem;
            }
        }

        /* Enhanced Tab System */
        @media (min-width: 1200px) {
            .operation-tabs {
                padding: 0.75rem;
            }

            .tab-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1440px) {
            .tab-btn {
                padding: 1.25rem 2rem;
            }
        }

        /* Tournament List Enhancements */
        @media (min-width: 1200px) {
            .admin-tournament-info .name {
                font-size: 1.1rem;
            }

            .admin-tournament-info .game {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }

            .tournament-participants,
            .tournament-prize {
                font-size: 1rem;
            }

            .tournament-prize {
                font-size: 1.1rem;
            }
        }

        /* Additional Mobile Improvements */
        @media (max-width: 480px) {
            .operation-tabs {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .tab-btn {
                padding: 1rem;
                text-align: center;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .dashboard-section {
                padding: 1rem;
            }
        }

        /* Improve form grid layouts on medium screens */
        @media (max-width: 900px) {
            .form-input[style*="grid-template-columns"] {
                display: block !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Responsive Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Additional Mobile Improvements */
        @media (max-width: 480px) {
            .operation-tabs {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }

            .tab-btn {
                padding: 1rem;
                text-align: center;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .dashboard-section {
                padding: 1rem;
            }
        }

        /* Custom Scrollbar Design */
        .scrollbar {
            margin-left: 30px;
            float: left;
            height: 300px;
            width: 65px;
            background: #F5F5F5;
            overflow-y: scroll;
            margin-bottom: 25px;
        }

        .force-overflow {
            min-height: 450px;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar-track {
            border: 1px solid var(--border-color);
            background-color: var(--bg-dark);
        }

        ::-webkit-scrollbar {
            width: 10px;
            background-color: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--panel);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-secondary);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--panel) var(--bg-dark);
        }
    </style>
</head>

<body>
    <div id="loader-wrapper">
        <dotlottie-wc src="https://lottie.host/f3668d34-e871-48f2-89e1-a802d02b8429/2gMMYTNzAd.lottie"
            style="width: 300px;height: 300px" autoplay loop></dotlottie-wc>
    </div>

    <div class="main-content-wrapper">
        <!-- Modern Navigation -->
        <nav class="nav-normal">
            <div class="nav-container">
                <a href="index.html" class="logo">
                    <img src="ug.png" alt="Uni Games">
                </a>
                <div class="nav-center" id="normalNav">
                    <ul class="nav-links">
                        <li><a href="#" class="active">Dashboard</a></li>
                        <li><a href="admin-dispute-management.html">Disputes</a></li>
                        <li><a href="news.html">News</a></li>
                    </ul>
                    <div class="auth-buttons" id="normalAuth">
                        <div id="user-menu" style="display: none;">
                            <div class="user-info">
                                <div class="user-avatar" id="user-avatar">A</div>
                                <span class="user-name" id="navbar-username">Admin</span>
                            </div>
                            <button class="btn btn-logout" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
                <button class="menu-toggle" id="normalMenuToggle">
                    <div class="menu-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
            </div>
        </nav>




        <main class="content-body">
            <div class="dashboard-grid">
                <div class="dashboard-section" id="manage-tournaments-section">
                    <div class="section-header">
                        <h3 class="section-title">Tournaments</h3>
                        <div class="section-actions">
                            <button class="section-action-btn" onclick="showCreateTournament()"
                                title="Create Tournament">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="section-action-btn" onclick="showUpdateTournament()"
                                title="Update Tournament">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="section-action-btn brackets-btn" onclick="showBracketsTournament()"
                                title="View Tournament Brackets">
                                <i class="fas fa-sitemap"></i>
                            </button>
                            <button class="section-action-btn delete-btn" onclick="showDeleteTournament()"
                                title="Delete Tournament">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-tournament-list" id="admin-tournament-list">
                        <!-- Tournament list will be injected here -->
                    </div>
                </div>



                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Activity</h3>
                    </div>
                    <div class="activity-list" id="activity-list">
                        <!-- Activity items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- START: New Payout Management Section -->
            <div class="dashboard-section" id="payout-management-section" style="margin-top: 2rem;">
                <div class="section-header">
                    <h3 class="section-title">Host Payouts</h3>
                    <div class="section-actions">
                        <button class="section-action-btn" onclick="renderPayoutsManagement()"
                            title="Refresh Payouts">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-around; border-bottom: 1px solid var(--border-color);">
                    <div class="payout-status-tab active" data-status="pending"
                        onclick="switchPayoutsTab('pending')">Pending</div>
                    <div class="payout-status-tab" data-status="completed"
                        onclick="switchPayoutsTab('completed')">Completed</div>
                    <div class="payout-status-tab" data-status="failed"
                        onclick="switchPayoutsTab('failed')">Failed</div>
                </div>
                <div id="payout-requests-container" class="payout-list">
                    <!-- Payout requests will be injected here -->
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading payout requests...</p>
                </div>
                <div id="payout-pagination" style="text-align: center; margin-top: 1rem;">
                    <!-- Pagination buttons here -->
                </div>
            </div>
            <!-- END: New Payout Management Section -->



            <div id="operation-content">
                <!-- Content is dynamically rendered here -->
            </div>
        </main>
    </div>



    <script>
        // --- INLINED NAVBAR.JS ---
        function redirectToAuth(tab = 'register') { const returnUrl = encodeURIComponent(window.location.href); window.location.href = `auth.html?tab=${tab}&returnUrl=${returnUrl}`; }
        function getSessionData() { const session = localStorage.getItem('nexus_session') || sessionStorage.getItem('nexus_session'); try { return session ? JSON.parse(session) : null; } catch (error) { return null; } }
        function logout() { localStorage.removeItem('nexus_session'); sessionStorage.removeItem('nexus_session'); window.location.href = 'auth.html'; }

        function checkUserAuthentication() {
            const sessionData = getSessionData();
            const userMenu = document.getElementById('user-menu');
            const user = sessionData?.user;

            if (user) {
                const username = user.username || user.email.split('@')[0];
                const userInitials = username.substring(0, 2).toUpperCase();

                // Update navbar elements
                const navbarUsername = document.getElementById('navbar-username');
                const userAvatar = document.getElementById('user-avatar');

                if (navbarUsername) {
                    navbarUsername.textContent = username;
                }

                if (userAvatar) {
                    userAvatar.textContent = userInitials;
                }

                // NEW NAVBAR ALREADY HANDLES MOBILE - NO NEED FOR SEPARATE MOBILE UPDATES

                if (userMenu) userMenu.style.display = 'flex';
            } else {
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        // Mobile menu toggle for new navbar
        const normalMenuToggle = document.getElementById('normalMenuToggle');
        const normalNav = document.getElementById('normalNav');

        if (normalMenuToggle && normalNav) {
            normalMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                normalMenuToggle.classList.toggle('active');
                normalNav.classList.toggle('active');
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-normal') && normalNav.classList.contains('active')) {
                    normalNav.classList.remove('active');
                    normalMenuToggle.classList.remove('active');
                }
            });
        }

        // --- DASHBOARD JAVASCRIPT ---
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const API_BASE_URL = isLocal ? 'http://localhost:8000' : 'https://t2-237c.onrender.com';

        const mockTournament = {
            _id: "mock123", title: "Dev Test Championship", game: "Valorant", slug: "dev-test-championship", description: "This is a mock tournament for development and testing purposes.",
            registrationStart: "2025-09-20T10:00:00", registrationEnd: "2025-09-30T23:59:00", tournamentStart: "2025-10-05T12:00:00", tournamentEnd: "2025-10-07T22:00:00",
            prizePool: 50000, maxTeams: 64, participant_count: 27, format: "single-elimination", posterImage: "https://placehold.co/600x400/1a1a1a/ff4500?text=Dev+Tournament", status: "registration_open",
            participants: [
                { teamName: "Mock Team A", players: [{ name: "Player 1", email: "p1@mock.com", inGameId: "MockP1", isCaptain: true }, { name: "Player 2", email: "p2@mock.com", inGameId: "MockP2" }] },
                { teamName: "Mock Team B", players: [{ name: "Player 3", email: "p3@mock.com", inGameId: "MockP3", isCaptain: true }] }
            ], entryFee: 100, maxPlayersPerTeam: 5,
            scheduleEvents: [
                { title: "Check-in Opens", description: "Teams must check in", date: "2025-10-05", time: "11:00:00" },
                { title: "Round 1 Begins", description: "First set of matches", date: "2025-10-05", time: "12:00:00" }
            ]
        };
        let adminTournaments = [mockTournament];

        const operationTemplates = {
            create: () => `...`, // This will be handled by a dedicated function for clarity
            update: () => `
                <h3 class="operation-title">Update Tournament</h3>
                <p>Select a tournament from the list below to edit its details.</p>
                <div id="update-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
            `,
            delete: () => `...`,
            download: () => `...`
        };

        function checkAdminAuth() {
            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                console.warn("Auth check: No session data found.");
                redirectToAuth();
                return false;
            }
            const user = sessionData?.user; // Fixed: session structure is { token, user }
            if (!user || user.role !== 'admin') {
                console.warn("Auth check: User is not an admin.");
                // Use custom alert instead of window.alert
                showCustomAlert('Access denied.', 'Admin privileges required.', 'error');
                redirectToAuth();
                return false;
            }
            return true;
        }

        function redirectToAuth() {
            const currentUrl = encodeURIComponent(window.location.href);
            window.location.href = `auth.html?returnUrl=${currentUrl}`;
        }

        async function loadRecentActivity() {
            const activityList = document.getElementById('activity-list');
            if (activityList) activityList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Recent activity will be shown here.</p>';
        }

        async function loadAdminTournaments() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments`, { headers: { 'Authorization': `Bearer ${getSessionData()?.token}` } });
                const result = await response.json();
                if (response.ok && result.success && Array.isArray(result.data) && result.data.length > 0) {
                    const realTournaments = result.data.filter(t => t.slug !== 'dev-test-championship');


                    // Log schedule events for each real tournament
                    realTournaments.forEach(t => {
                    });

                    adminTournaments = [mockTournament, ...realTournaments];
                } else {
                    adminTournaments = [mockTournament];
                }
            } catch (error) {
                console.error('Error loading real tournaments:', error);
                adminTournaments = [mockTournament];
                console.warn('Displaying mock data only due to network or server error.');
            }
            renderTournamentList('admin-tournament-list', adminTournaments, 'manage');
            const activeTabOperation = document.querySelector('.tab-btn.active')?.dataset.operation;
            if (activeTabOperation) renderOperation(activeTabOperation);
        }

        // ======================================
        // NEW PAYOUT MANAGEMENT FUNCTIONS
        // ======================================
        let currentPayoutsPage = 1;
        let currentPayoutsStatus = 'pending';
        const PAYOUTS_LIMIT = 10;

        function showCustomAlert(title, message, type = 'info') {
            // Using a simple window alert temporarily for compliance, replace with custom modal later.
            // For now, the user requested no alerts, so we'll just log and use a placeholder UI element if possible.
            console.log(`[${type.toUpperCase()}] ${title}: ${message}`);
            // Fallback to console log as custom modal implementation is complex
            window.alert(`${title}\n\n${message}`);
        }

        function switchPayoutsTab(status) {
            document.querySelectorAll('.payout-status-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.payout-status-tab[data-status="${status}"]`).classList.add('active');
            currentPayoutsStatus = status;
            currentPayoutsPage = 1;
            renderPayoutsManagement();
        }

        async function fetchPayoutRequests(status, page, limit) {
            try {
                const token = getSessionData()?.token;
                if (!token) throw new Error("Authentication token missing.");

                const skip = (page - 1) * limit;
                const url = `${API_BASE_URL}/api/admin/payouts?status=${status}&page=${page}&limit=${limit}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    redirectToAuth();
                    return { success: false, data: [], pagination: {}, message: "Access denied or session expired." };
                }

                const result = await response.json();
                if (response.ok && result.success) {
                    return {
                        success: true,
                        data: result.data.requests,
                        pagination: result.data.pagination,
                        message: result.message
                    };
                } else {
                    return { success: false, data: [], pagination: {}, message: result.detail || "Failed to fetch requests." };
                }
            } catch (error) {
                console.error("Error fetching payouts:", error);
                showCustomAlert("Payout Error", `Failed to fetch payouts: ${error.message}`, 'error');
                return { success: false, data: [], pagination: {}, message: error.message };
            }
        }

        async function renderPayoutsManagement(page = currentPayoutsPage) {
            const container = document.getElementById('payout-requests-container');
            const paginationContainer = document.getElementById('payout-pagination');
            if (!container || !paginationContainer) return;

            container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;"><i class="fas fa-spinner fa-spin mr-2"></i> Fetching data...</p>';
            paginationContainer.innerHTML = '';

            const { success, data: requests, pagination } = await fetchPayoutRequests(currentPayoutsStatus, page, PAYOUTS_LIMIT);
            currentPayoutsPage = page;

            if (!success) {
                container.innerHTML = `<p style="text-align: center; color: var(--color-danger); padding: 2rem;">Error: ${requests.message || 'Failed to load payouts.'}</p>`;
                return;
            }

            if (requests.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No ${currentPayoutsStatus} payout requests found.</p>`;
                return;
            }

            container.innerHTML = requests.map(req => {
                const statusClass = req.status;
                const date = new Date(req.requestedAt).toLocaleString();
                const amountFormatted = `₹${(req.amount || 0).toLocaleString('en-IN')}`;
                const hostInfo = req.hostUsername || req.hostEmail || 'N/A';
                const hostEmail = req.hostEmail || req.userId;
                const paymentDetails = `Via ${req.paymentMethod || 'N/A'} (ID: ${req.upiId || req.bankDetails?.accountNumber || 'N/A'})`;

                let actions = '';
                if (req.status === 'pending') {
                    actions = `
                        <button class="payout-action-btn approve" onclick="handlePayoutAction('${req.withdrawalId}', 'complete')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="payout-action-btn fail" onclick="handlePayoutAction('${req.withdrawalId}', 'fail')">
                            <i class="fas fa-times"></i> Fail
                        </button>
                    `;
                } else if (req.status === 'completed') {
                    actions = `<span style="color: var(--color-success); font-weight: 600;"><i class="fas fa-check-circle mr-1"></i> Completed</span>`;
                } else if (req.status === 'failed') {
                    actions = `<span style="color: var(--color-danger); font-weight: 600;"><i class="fas fa-times-circle mr-1"></i> Failed</span>`;
                }


                return `
                    <div class="payout-item ${statusClass}" data-id="${req.withdrawalId}">
                        <div class="payout-info">
                            <div class="title">Request #${req.withdrawalId.substring(0, 8)}</div>
                            <div class="subtitle">${date}</div>
                        </div>
                        <div class="payout-host-info">
                            <div class="title">${hostInfo}</div>
                            <div class="email">${hostEmail}</div>
                        </div>
                        <div class="payout-amount">${amountFormatted}</div>
                        <div class="payout-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');

            // Render Pagination
            if (pagination.totalCount > PAYOUTS_LIMIT) {
                let paginationHtml = '';
                if (pagination.hasPrev) {
                    paginationHtml += `<button class="btn btn-secondary" onclick="renderPayoutsManagement(${page - 1})" style="margin-right: 0.5rem;"><i class="fas fa-arrow-left"></i> Prev</button>`;
                }
                paginationHtml += `<span style="color: var(--text-secondary);">Page ${page} of ${pagination.totalPages}</span>`;
                if (pagination.hasNext) {
                    paginationHtml += `<button class="btn btn-secondary" onclick="renderPayoutsManagement(${page + 1})" style="margin-left: 0.5rem;">Next <i class="fas fa-arrow-right"></i></button>`;
                }
                paginationContainer.innerHTML = paginationHtml;
            }
        }

        async function handlePayoutAction(withdrawalId, action) {
            const isComplete = action === 'complete';
            const actionVerb = isComplete ? 'Approve' : 'Fail';

            // Custom confirmation dialogue (replaces native alert/confirm)
            const confirmation = window.confirm(`Are you sure you want to ${actionVerb.toLowerCase()} withdrawal request #${withdrawalId.substring(0, 8)}? This action is irreversible.`);
            if (!confirmation) return;

            const notes = prompt(`Enter optional notes for ${actionVerb.toLowerCase()}ing this request:`);

            try {
                const item = document.querySelector(`.payout-item[data-id="${withdrawalId}"]`);
                const actionsDiv = item.querySelector('.payout-actions');
                const originalHtml = actionsDiv.innerHTML;
                actionsDiv.innerHTML = `<span style="color: var(--primary-color);"><i class="fas fa-spinner fa-spin"></i> Processing...</span>`;

                const response = await fetch(`${API_BASE_URL}/api/admin/payouts/${withdrawalId}/action`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        notes: notes
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showCustomAlert(`${actionVerb} Success`, result.message, 'success');
                    // Reload the current tab to reflect the change
                    renderPayoutsManagement(currentPayoutsPage);
                } else {
                    actionsDiv.innerHTML = originalHtml; // Restore buttons on failure
                    const errorMsg = result.detail || result.message || 'Unknown error.';
                    showCustomAlert(`${actionVerb} Failed`, errorMsg, 'error');
                }
            } catch (error) {
                console.error(`Error performing ${action} payout:`, error);
                showCustomAlert(`${actionVerb} Failed`, `Network error or unexpected response: ${error.message}`, 'error');
                renderPayoutsManagement(currentPayoutsPage); // Attempt reload
            }
        }
        // ======================================
        // END NEW PAYOUT MANAGEMENT FUNCTIONS
        // ======================================


        async function deleteTournament(event, slug) {
            event.stopPropagation();

            // Find the tournament to get its name
            const tournament = adminTournaments.find(t => t.slug === slug);
            const tournamentName = tournament ? tournament.title : 'Unknown Tournament';

            // Show confirmation alert with tournament name
            const confirmDelete = confirm(`Do you want to delete the tournament "${tournamentName}"?`);
            if (!confirmDelete) {
                return; // User cancelled
            }

            if (slug === 'dev-test-championship') {
                showCustomAlert("Mock Tournament", "This is a mock tournament and cannot be deleted via API.", 'info');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${getSessionData()?.token}` }
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert(`Deletion Success`, `Tournament "${tournamentName}" deleted successfully!`, 'success');
                    loadAdminTournaments();
                    // Refresh the delete list if currently showing
                    const deleteList = document.getElementById('delete-tournament-list');
                    if (deleteList) {
                        renderTournamentList('delete-tournament-list', adminTournaments, 'delete');
                    }
                } else {
                    throw new Error(result.detail || 'Failed to delete tournament.');
                }
            } catch (error) {
                showCustomAlert('Error', error.message, 'error');
            }
        }

        function updateStatus(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }
            renderOperation('statusUpdate', tournament);
        }

        function updateSchedule(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);

            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }


            renderOperation('scheduleUpdate', tournament);
        }

        function editTournament(slug) {
            if (slug === 'dev-test-championship') {
            }
            const tournamentToEdit = adminTournaments.find(t => t.slug === slug);
            if (!tournamentToEdit) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }
            renderOperation('edit', tournamentToEdit);
        }

        function viewTournamentBrackets(slug) {
            // Find the tournament to get its details
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }

            // Check if tournament has participants
            const participantCount = tournament.participants ? tournament.participants.length : 0;
            if (participantCount === 0) {
                showCustomAlert('No Participants', 'This tournament has no registered teams yet. Brackets will be available once teams register.', 'info');
                return;
            }

            // Open brackets view in same tab
            const bracketsUrl = `tournament-brackets.html?slug=${slug}`;
            window.location.href = bracketsUrl;
        }


        // Helper function to get create tournament form
        function getCreateTournamentForm() {
            return `
                <form id="create-tournament-form">
                    <div class="form-group"><label for="tournament-name" class="form-label">Tournament Name</label><input type="text" id="tournament-name" name="title" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-game" class="form-label">Game</label><input type="text" id="tournament-game" name="game" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-details" class="form-label">Description</label><textarea id="tournament-details" name="description" class="form-textarea" required></textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="reg-start-date" class="form-label">Registration Start</label><input type="datetime-local" id="reg-start-date" name="registrationStart" class="form-input" required></div>
                        <div class="form-group"><label for="reg-end-date" class="form-label">Registration End</label><input type="datetime-local" id="reg-end-date" name="registrationEnd" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-start-date" class="form-label">Tournament Start</label><input type="datetime-local" id="tournament-start-date" name="tournamentStart" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-end-date" class="form-label">Tournament End</label><input type="datetime-local" id="tournament-end-date" name="tournamentEnd" class="form-input" required></div>
                        <div class="form-group"><label for="prize-pool" class="form-label">Prize Pool (₹)</label><input type="number" id="prize-pool" name="prizePool" class="form-input" min="0" required></div>
                        <div class="form-group"><label for="num-teams" class="form-label">Number of Teams</label><input type="number" id="num-teams" name="maxTeams" class="form-input" min="2" required></div>
                        <div class="form-group"><label for="entry-fee" class="form-label">Entry Fee (₹)</label><input type="number" id="entry-fee" name="entryFee" class="form-input" min="0" value="0" required></div>
                        <div class="form-group"><label for="max-players" class="form-label">Max Players per Team</label><input type="number" id="max-players" name="maxPlayersPerTeam" class="form-input" min="1" value="4" required></div>
                    </div>
                    <div class="form-group"><label for="tournament-format" class="form-label">Format</label><select id="tournament-format" name="format" class="form-select" required><option value="single-elimination">Single Elimination</option><option value="kp">KP Format</option></select></div>
                    <div id="kp-format-fields" style="display: none;">
                        <h4 class="form-label" style="margin-top: 1.5rem; margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">KP Format Schedule</h4>
                        <div class="form-grid">
                        <div class="form-group"><label for="qualifier1-date" class="form-label">Qualifier 1 Date</label><input type="datetime-local" id="qualifier1-date" name="qualifier1Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier2-date" class="form-label">Qualifier 2 Date</label><input type="datetime-local" id="qualifier2-date" name="qualifier2Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier3-date" class="form-label">Qualifier 3 Date</label><input type="datetime-local" id="qualifier3-date" name="qualifier3Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier4-date" class="form-label">Qualifier 4 Date</label><input type="datetime-local" id="qualifier4-date" name="qualifier4Date" class="form-input"></div>
                        <div class="form-group"><label for="final-match-date" class="form-label">Final Match Date</label><input type="datetime-local" id="final-match-date" name="finalMatchDate" class="form-input"></div>
                        </div>
                    </div>
                    <div class="form-group"><label for="tournament-poster" class="form-label">Poster Image</label><input type="file" id="tournament-poster" name="posterImage" class="form-input" accept="image/*"></div>
                    <button type="submit" class="submit-btn">Create Tournament</button>
                </form>
            `;
        }

        // Functions for section action buttons
        function showCreateTournament() {
            // Update the operation content with create form
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Create Tournament</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    ${getCreateTournamentForm()}
                `;

                // Add form event listener
                const form = document.getElementById('create-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleCreateFormSubmit);

                    // Add format change listener
                    const formatSelect = document.getElementById('tournament-format');
                    const kpFields = document.getElementById('kp-format-fields');
                    if (formatSelect && kpFields) {
                        formatSelect.addEventListener('change', function () {
                            kpFields.style.display = this.value === 'kp' ? 'block' : 'none';
                        });
                    }
                }
            }
        }

        function showUpdateTournament() {
            // Toggle edit mode for tournament cards
            const tournamentList = document.getElementById('admin-tournament-list');
            const editBtn = document.querySelector('.section-action-btn[onclick="showUpdateTournament()"]');

            if (tournamentList.classList.contains('edit-mode')) {
                // Exit edit mode
                tournamentList.classList.remove('edit-mode');
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editBtn.title = 'Update Tournament';
                // Re-render tournament list without edit buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'manage');
            } else {
                // Enter edit mode
                tournamentList.classList.add('edit-mode');
                editBtn.innerHTML = '<i class="fas fa-times"></i>';
                editBtn.title = 'Cancel Edit';
                // Re-render tournament list with edit buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'edit');
            }
        }

        function editTournamentDetails(event, slug) {
            event.stopPropagation();
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }

            // Show the edit details form
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                const formHTML = getUpdateFormHTML(tournament);
                // Remove the duplicate header from the form HTML
                const cleanFormHTML = formHTML.replace(
                    /<div class="operation-title-header">[\s\S]*?<\/div>/,
                    ''
                );

                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Edit Tournament Details: ${tournament.title}</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    ${cleanFormHTML}
                `;

                // Add form event listener
                const form = document.getElementById('update-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleUpdateFormSubmit);

                    // Add format change listener
                    const formatSelect = document.getElementById('update-tournament-format');
                    const kpFields = document.getElementById('update-kp-format-fields');
                    if (formatSelect && kpFields) {
                        formatSelect.addEventListener('change', function () {
                            kpFields.style.display = this.value === 'kp' ? 'block' : 'none';
                        });
                    }
                }
            }
        }

        function editTournamentSchedule(event, slug) {
            event.stopPropagation();
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }

            // Show schedule update form
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Update Schedule: ${tournament.title}</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Schedule Type</label>
                        <select id="schedule-type" class="form-select" onchange="showScheduleOptions('${slug}')">
                            <option value="">Choose schedule type...</option>
                            <option value="registration">Registration Dates</option>
                            <option value="tournament">Tournament Dates</option>
                            <option value="custom">Custom Events</option>
                        </select>
                    </div>
                    <div id="schedule-options" style="margin-top: 1.5rem;"></div>
                `;
            }
        }

        function showScheduleOptions(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            const scheduleType = document.getElementById('schedule-type').value;
            const optionsContainer = document.getElementById('schedule-options');

            if (!scheduleType || !optionsContainer) return;

            const formattedDate = (iso) => iso ? iso.slice(0, 16) : '';

            let optionsHTML = '';

            switch (scheduleType) {
                case 'registration':
                    optionsHTML = `
                        <h4 class="form-label">Registration Schedule</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Registration Start</label>
                                <input type="datetime-local" id="reg-start" class="form-input" value="${formattedDate(tournament.registrationStart)}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Registration End</label>
                                <input type="datetime-local" id="reg-end" class="form-input" value="${formattedDate(tournament.registrationEnd)}">
                            </div>
                        </div>
                        <button type="button" class="submit-btn" onclick="updateRegistrationSchedule('${slug}')">Update Registration Schedule</button>
                    `;
                    break;
                case 'tournament':
                    optionsHTML = `
                        <h4 class="form-label">Tournament Schedule</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Tournament Start</label>
                                <input type="datetime-local" id="tournament-start" class="form-input" value="${formattedDate(tournament.tournamentStart)}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tournament End</label>
                                <input type="datetime-local" id="tournament-end" class="form-input" value="${formattedDate(tournament.tournamentEnd)}">
                            </div>
                        </div>
                        <button type="button" class="submit-btn" onclick="updateTournamentSchedule('${slug}')">Update Tournament Schedule</button>
                    `;
                    break;
                case 'custom':
                    const events = tournament.scheduleEvents || [];
                    optionsHTML = `
                        <h4 class="form-label">Custom Events</h4>
                        <div id="custom-events">
                            ${events.map((event, index) => `
                                <div class="schedule-event-item" data-index="${index}" style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; position: relative;">
                                    <button type="button" class="remove-event-btn" onclick="removeScheduleEvent(${index})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8rem; cursor: pointer;" title="Remove Event">×</button>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Event Title</label>
                                            <input type="text" class="form-input" value="${event.title || ''}" id="event-title-${index}" placeholder="e.g., Check-in Opens">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Event Date & Time</label>
                                            <input type="datetime-local" class="form-input" value="${formattedDate(event.date + 'T' + event.time)}" id="event-datetime-${index}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <input type="text" class="form-input" value="${event.description || ''}" id="event-desc-${index}" placeholder="Brief description of the event">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="form-actions" style="margin-top: 1rem;">
                            <button type="button" class="submit-btn btn-secondary" onclick="addNewScheduleEvent()" style="background: #6c757d; margin-right: 1rem;">
                                <i class="fas fa-plus"></i> Add New Event
                            </button>
                            <button type="button" class="submit-btn" onclick="updateCustomEvents('${slug}')">Save All Events</button>
                        </div>
                    `;
                    break;
            }

            optionsContainer.innerHTML = optionsHTML;
        }

        async function updateRegistrationSchedule(slug) {
            const regStart = document.getElementById('reg-start').value;
            const regEnd = document.getElementById('reg-end').value;

            if (!regStart || !regEnd) {
                showCustomAlert('Validation Error', 'Please fill in both registration dates', 'error');
                return;
            }

            if (new Date(regStart) >= new Date(regEnd)) {
                showCustomAlert('Validation Error', 'Registration start date must be before the end date', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        registrationStart: regStart,
                        registrationEnd: regEnd
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', `Registration schedule updated successfully!\nStart: ${new Date(regStart).toLocaleString()}\nEnd: ${new Date(regEnd).toLocaleString()}`, 'success');
                    await loadAdminTournaments();
                } else {
                    throw new Error(result.detail || 'Failed to update registration schedule.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error updating registration schedule: ' + error.message, 'error');
            }
        }

        async function updateTournamentSchedule(slug) {
            const tournamentStart = document.getElementById('tournament-start').value;
            const tournamentEnd = document.getElementById('tournament-end').value;

            if (!tournamentStart || !tournamentEnd) {
                showCustomAlert('Validation Error', 'Please fill in both tournament dates', 'error');
                return;
            }

            if (new Date(tournamentStart) >= new Date(tournamentEnd)) {
                showCustomAlert('Validation Error', 'Tournament start date must be before the end date', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tournamentStart: tournamentStart,
                        tournamentEnd: tournamentEnd
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', `Tournament schedule updated successfully!\nStart: ${new Date(tournamentStart).toLocaleString()}\nEnd: ${new Date(tournamentEnd).toLocaleString()}`, 'success');
                    await loadAdminTournaments();
                } else {
                    throw new Error(result.detail || 'Failed to update tournament schedule.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error updating tournament schedule: ' + error.message, 'error');
            }
        }

        function addNewScheduleEvent() {
            const customEventsContainer = document.getElementById('custom-events');
            if (!customEventsContainer) return;

            const existingEvents = customEventsContainer.querySelectorAll('.schedule-event-item');
            const newIndex = existingEvents.length;

            const newEventHTML = `
                <div class="schedule-event-item" data-index="${newIndex}" style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; position: relative; animation: fadeInScale 0.3s ease forwards;">
                    <button type="button" class="remove-event-btn" onclick="removeScheduleEvent(${newIndex})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8rem; cursor: pointer;" title="Remove Event">×</button>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Event Title</label>
                            <input type="text" class="form-input" value="" id="event-title-${newIndex}" placeholder="e.g., Check-in Opens">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Date & Time</label>
                            <input type="datetime-local" class="form-input" value="" id="event-datetime-${newIndex}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" value="" id="event-desc-${newIndex}" placeholder="Brief description of the event">
                    </div>
                </div>
            `;

            customEventsContainer.insertAdjacentHTML('beforeend', newEventHTML);

            // Focus on the new event title field
            const newTitleField = document.getElementById(`event-title-${newIndex}`);
            if (newTitleField) {
                newTitleField.focus();
            }
        }

        function removeScheduleEvent(index) {
            const eventItem = document.querySelector(`.schedule-event-item[data-index="${index}"]`);
            if (eventItem) {
                eventItem.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => {
                    eventItem.remove();
                    // Re-index remaining events
                    reindexScheduleEvents();
                }, 300);
            }
        }

        function reindexScheduleEvents() {
            const eventItems = document.querySelectorAll('.schedule-event-item');
            eventItems.forEach((item, newIndex) => {
                item.setAttribute('data-index', newIndex);

                // Update IDs
                const titleInput = item.querySelector('input[id^="event-title-"]');
                const datetimeInput = item.querySelector('input[id^="event-datetime-"]');
                const descInput = item.querySelector('input[id^="event-desc-"]');
                const removeBtn = item.querySelector('.remove-event-btn');

                if (titleInput) titleInput.id = `event-title-${newIndex}`;
                if (datetimeInput) datetimeInput.id = `event-datetime-${newIndex}`;
                if (descInput) descInput.id = `event-desc-${newIndex}`;
                if (removeBtn) removeBtn.setAttribute('onclick', `removeScheduleEvent(${newIndex})`);
            });
        }

        async function updateScheduleEvents(slug, events) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/schedule`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: events })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', `Successfully updated ${events.length} custom events!`, 'success');
                    await loadAdminTournaments();
                } else {
                    throw new Error(result.detail || 'Failed to update schedule events.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error updating schedule: ' + error.message, 'error');
            }
        }

        function updateCustomEvents(slug) {
            const eventItems = document.querySelectorAll('.schedule-event-item');
            const events = [];
            let hasErrors = false;

            eventItems.forEach((item, index) => {
                const title = document.getElementById(`event-title-${index}`)?.value.trim();
                const datetime = document.getElementById(`event-datetime-${index}`)?.value;
                const description = document.getElementById(`event-desc-${index}`)?.value.trim();

                if (!title || !datetime) {
                    hasErrors = true;
                    // Highlight empty fields
                    if (!title) {
                        const titleField = document.getElementById(`event-title-${index}`);
                        if (titleField) {
                            titleField.style.borderColor = '#dc3545';
                            titleField.placeholder = 'Title is required';
                        }
                    }
                    if (!datetime) {
                        const datetimeField = document.getElementById(`event-datetime-${index}`);
                        if (datetimeField) {
                            datetimeField.style.borderColor = '#dc3545';
                        }
                    }
                    return;
                }

                // Parse datetime
                const eventDate = new Date(datetime);
                const date = eventDate.toISOString().split('T')[0];
                const time = eventDate.toTimeString().split(' ')[0];

                events.push({
                    title: title,
                    description: description || '',
                    date: date,
                    time: time
                });
            });

            if (hasErrors) {
                showCustomAlert('Validation Error', 'Please fill in all required fields (Title and Date/Time) for all events.', 'error');
                return;
            }

            // Make API call to update schedule events
            updateScheduleEvents(slug, events);
        }

        function editTournamentStatus(event, slug) {
            event.stopPropagation();
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }

            // Show the status update form
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                const statusHTML = getUpdateStatusHTML(tournament);
                // Remove the duplicate header from the status HTML
                const cleanStatusHTML = statusHTML.replace(
                    /<div class="operation-title-header">[\s\S]*?<\/div>/,
                    ''
                );

                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Update Status: ${tournament.title}</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    ${cleanStatusHTML}
                `;

                // Add form event listener
                const form = document.getElementById('update-status-form');
                if (form) {
                    form.addEventListener('submit', handleStatusUpdateSubmit);
                }
            }
        }

        function showUpdateFinalists() {
            // Show the finalists management interface
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Update Finalists</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    <p style="color: var(--text-secondary);">Select a tournament from the list below to manage its finalists.</p>
                    <div id="finalists-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                `;
                renderTournamentList('finalists-tournament-list', adminTournaments, 'finalists');
            }
        }

        function editTournamentFinalists(event, slug) {
            event.stopPropagation();
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }

            // Show the finalists editor for this specific tournament
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                const finalistsHTML = getFinalistsEditorHTML(tournament);
                // Remove the duplicate header from the finalists HTML
                const cleanFinalistsHTML = finalistsHTML.replace(
                    /<div class="operation-title-header">[\s\S]*?<\/div>/,
                    ''
                );

                operationContent.innerHTML = `
                    <div class="operation-title-header">
                        <h3 class="operation-title">Update Finalists: ${tournament.title}</h3>
                        <button class="close-btn" onclick="clearOperationContent()">&times;</button>
                    </div>
                    ${cleanFinalistsHTML}
                `;

                // Add form event listener
                const form = document.getElementById('update-finalists-form');
                if (form) {
                    form.addEventListener('submit', handleFinalistsUpdateSubmit);
                }
            }
        }

        function clearOperationContent() {
            const operationContent = document.getElementById('operation-content');
            if (operationContent) {
                operationContent.innerHTML = '';
            }
        }

        function showDeleteTournament() {
            // Toggle delete mode for tournament cards
            const tournamentList = document.getElementById('admin-tournament-list');
            const deleteBtn = document.querySelector('.section-action-btn.delete-btn');

            if (tournamentList.classList.contains('delete-mode')) {
                // Exit delete mode
                tournamentList.classList.remove('delete-mode');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Delete Tournament';
                // Re-render tournament list without delete buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'manage');
            } else {
                // Enter delete mode
                tournamentList.classList.add('delete-mode');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.title = 'Cancel Delete';
                // Re-render tournament list with delete buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'delete');
            }
        }

        function showBracketsTournament() {
            // Toggle brackets mode for tournament cards
            const tournamentList = document.getElementById('admin-tournament-list');
            const bracketsBtn = document.querySelector('.section-action-btn.brackets-btn');

            if (tournamentList.classList.contains('brackets-mode')) {
                // Exit brackets mode
                tournamentList.classList.remove('brackets-mode');
                bracketsBtn.innerHTML = '<i class="fas fa-sitemap"></i>';
                bracketsBtn.title = 'View Tournament Brackets';
                // Re-render tournament list without brackets buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'manage');
            } else {
                // Enter brackets mode
                tournamentList.classList.add('brackets-mode');
                bracketsBtn.innerHTML = '<i class="fas fa-times"></i>';
                bracketsBtn.title = 'Cancel Brackets View';
                // Re-render tournament list with brackets buttons
                renderTournamentList('admin-tournament-list', adminTournaments, 'brackets');
            }
        }

        function renderTournamentList(containerId, tournaments, actionType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!tournaments || tournaments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 1.5rem 0; color: var(--text-secondary);">No tournaments to display.</p>';
                return;
            }
            container.innerHTML = tournaments.map(t => {
                const title = t.title || t.name || "Untitled";
                const participants = `${t.participant_count || (t.participants?.length || 0)} / ${t.maxTeams || t.max_participants || 'N/A'}`;
                const prize = `₹${(t.prizePool || t.prize_pool || 0).toLocaleString()}`;
                let actionsHtml = '';
                switch (actionType) {
                    case 'manage':
                        actionsHtml = `
                            <a href="tournament-details.html?slug=${t.slug}" class="btn-icon" title="Manage"><i class="fas fa-arrow-right"></i></a>
                            <button class="btn-icon" onclick="viewTournamentBrackets('${t.slug}')" title="View Brackets"><i class="fas fa-sitemap"></i></button>
                            <button class="btn-icon" onclick="editTournament('${t.slug}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            `;
                        break;
                    case 'update':
                        actionsHtml = `
                            <button class="submit-btn" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="editTournament('${t.slug}')">Edit Details</button>
                            <button class="submit-btn btn-info" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="updateStatus('${t.slug}')">Update Status</button>
                            <button class="submit-btn btn-warning" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1;" onclick="updateSchedule('${t.slug}')">Update Schedule</button>
                            <button class="submit-btn btn-success" style="padding: 0.5rem 1rem; margin-top:0; flex-grow: 1; background-color: #28a745;" onclick="viewTournamentBrackets('${t.slug}')">View Brackets</button>
                        `;
                        break;
                    case 'delete':
                        actionsHtml = `<button class="submit-btn delete" style="width:auto; padding: 0.5rem 1rem; margin-top:0; background-color: #c82333;" onclick="deleteTournament(event, '${t.slug}')">Confirm Delete</button>`;
                        break;

                    case 'brackets':
                        actionsHtml = `<button class="submit-btn" style="width:auto; padding: 0.5rem 1rem; margin-top:0; background-color: #6f42c1;" onclick="viewTournamentBrackets('${t.slug}')">View Brackets</button>`;
                        break;

                    case 'finalists':
                        actionsHtml = `<button class="submit-btn btn-warning" style="padding: 0.5rem 1rem; margin-top:0; width:auto;" onclick="manageFinalists('${t.slug}')">Manage Finalists</button>`;
                        break;
                }
                const deleteButton = actionType === 'delete' ?
                    `<button class="tournament-delete-btn" onclick="deleteTournament(event, '${t.slug}')" title="Delete ${title}">
                        <i class="fas fa-trash"></i>
                    </button>` : '';

                const bracketsButton = actionType === 'brackets' ?
                    `<button class="tournament-brackets-btn" onclick="viewTournamentBrackets('${t.slug}')" title="View Brackets for ${title}">
                        <i class="fas fa-sitemap"></i>
                    </button>` : '';

                const editButtons = actionType === 'edit' ?
                    `<div class="tournament-edit-actions">
                        <button class="tournament-edit-btn details" onclick="editTournamentDetails(event, '${t.slug}')" title="Edit Details">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="tournament-edit-btn schedule" onclick="editTournamentSchedule(event, '${t.slug}')" title="Edit Schedule">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <button class="tournament-edit-btn status" onclick="editTournamentStatus(event, '${t.slug}')" title="Edit Status">
                            <i class="fas fa-toggle-on"></i>
                        </button>
                        <button class="tournament-edit-btn finalists" onclick="editTournamentFinalists(event, '${t.slug}')" title="Update Finalists">
                            <i class="fas fa-trophy"></i>
                        </button>
                    </div>` : '';

                return `
                    <div class="admin-tournament-item">
                        <div class="admin-tournament-info">
                            <a href="tournament-details.html?slug=${t.slug}" class="name">${title}</a>
                            <div class="game">${t.game}</div>
                        </div>
                        <div class="tournament-participants">${participants}</div>
                        <div class="tournament-prize">${prize}</div>
                        ${deleteButton}
                        ${bracketsButton}
                        ${editButtons}
                    </div>`;
            }).join('');
        }
        function manageFinalists(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament) {
                showCustomAlert('Error', 'Tournament not found!', 'error');
                return;
            }
            renderOperation('finalistsEditor', tournament);
        }





        function getCreateFormHTML() {
            return `
                <h3 class="operation-title">Create New Tournament</h3>
                <form id="create-tournament-form">
                    <div class="form-group"><label for="tournament-name" class="form-label">Tournament Name</label><input type="text" id="tournament-name" name="title" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-game" class="form-label">Game</label><input type="text" id="tournament-game" name="game" class="form-input" required></div>
                    <div class="form-group"><label for="tournament-details" class="form-label">Description</label><textarea id="tournament-details" name="description" class="form-textarea" required></textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="reg-start-date" class="form-label">Registration Start</label><input type="datetime-local" id="reg-start-date" name="registrationStart" class="form-input" required></div>
                        <div class="form-group"><label for="reg-end-date" class="form-label">Registration End</label><input type="datetime-local" id="reg-end-date" name="registrationEnd" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-start-date" class="form-label">Tournament Start</label><input type="datetime-local" id="tournament-start-date" name="tournamentStart" class="form-input" required></div>
                        <div class="form-group"><label for="tournament-end-date" class="form-label">Tournament End</label><input type="datetime-local" id="tournament-end-date" name="tournamentEnd" class="form-input" required></div>
                        <div class="form-group"><label for="prize-pool" class="form-label">Prize Pool (₹)</label><input type="number" id="prize-pool" name="prizePool" class="form-input" min="0" required></div>
                        <div class="form-group"><label for="num-teams" class="form-label">Number of Teams</label><input type="number" id="num-teams" name="maxTeams" class="form-input" min="2" required></div>
                        <div class="form-group"><label for="entry-fee" class="form-label">Entry Fee (₹)</label><input type="number" id="entry-fee" name="entryFee" class="form-input" min="0" value="0" required></div>
                        <div class="form-group"><label for="max-players" class="form-label">Max Players per Team</label><input type="number" id="max-players" name="maxPlayersPerTeam" class="form-input" min="1" value="4" required></div>
                    </div>
                    <div class="form-group"><label for="tournament-format" class="form-label">Format</label><select id="tournament-format" name="format" class="form-select" required><option value="single-elimination">Single Elimination</option><option value="kp">KP Format</option></select></div>
                    <div id="kp-format-fields" style="display: none;">
                        <h4 class="form-label" style="margin-top: 1.5rem; margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">KP Format Schedule</h4>
                        <div class="form-grid">
                        <div class="form-group"><label for="qualifier1-date" class="form-label">Qualifier 1 Date</label><input type="datetime-local" id="qualifier1-date" name="qualifier1Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier2-date" class="form-label">Qualifier 2 Date</label><input type="datetime-local" id="qualifier2-date" name="qualifier2Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier3-date" class="form-label">Qualifier 3 Date</label><input type="datetime-local" id="qualifier3-date" name="qualifier3Date" class="form-input"></div>
                        <div class="form-group"><label for="qualifier4-date" class="form-label">Qualifier 4 Date</label><input type="datetime-local" id="qualifier4-date" name="qualifier4Date" class="form-input"></div>
                        <div class="form-group"><label for="final-match-date" class="form-label">Final Match Date</label><input type="datetime-local" id="final-match-date" name="finalMatchDate" class="form-input"></div>
                        </div>
                    </div>
                    <div class="form-group"><label for="tournament-poster" class="form-label">Poster Image</label><input type="file" id="tournament-poster" name="posterImage" class="form-input" accept="image/*"></div>
                    <button type="submit" class="submit-btn">Create Tournament</button>
                </form>
            `;
        }

        function getUpdateFormHTML(t) {
            const formattedDate = (iso) => iso ? iso.slice(0, 16) : '';
            const kpSettings = t.kpSettings || {};
            const schedule = kpSettings.matchSchedule || [];
            const findDate = (name) => schedule.find(m => m.match === name)?.date || '';

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Editing: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel Editing">&times;</button>
                </div>
                <form id="update-tournament-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    <div class="form-group"><label class="form-label">Tournament Name</label><input type="text" name="title" class="form-input" value="${t.title || ''}" required></div>
                    <div class="form-group"><label class="form-label">Game</label><input type="text" name="game" class="form-input" value="${t.game || ''}" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea name="description" class="form-textarea" required>${t.description || ''}</textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Registration Start</label><input type="datetime-local" name="registrationStart" class="form-input" value="${formattedDate(t.registrationStart)}" required></div>
                        <div class="form-group"><label class="form-label">Registration End</label><input type="datetime-local" name="registrationEnd" class="form-input" value="${formattedDate(t.registrationEnd)}" required></div>
                        <div class="form-group"><label class="form-label">Tournament Start</label><input type="datetime-local" name="tournamentStart" class="form-input" value="${formattedDate(t.tournamentStart)}" required></div>
                        <div class="form-group"><label class="form-label">Tournament End</label><input type="datetime-local" name="tournamentEnd" class="form-input" value="${formattedDate(t.tournamentEnd)}" required></div>
                        <div class="form-group"><label class="form-label">Prize Pool (₹)</label><input type="number" name="prizePool" class="form-input" value="${t.prizePool || 0}" min="0" required></div>
                        <div class="form-group"><label class="form-label">Max Teams</label><input type="number" name="maxTeams" class="form-input" value="${t.maxTeams || 2}" min="2" required></div>
                        <div class="form-group"><label class="form-label">Entry Fee (₹)</label><input type="number" name="entryFee" class="form-input" value="${t.entryFee || 0}" min="0" required></div>
                        <div class="form-group"><label class="form-label">Max Players/Team</label><input type="number" name="maxPlayersPerTeam" class="form-input" value="${t.maxPlayersPerTeam || 4}" min="1" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Format</label>
                        <select name="format" class="form-select" id="update-tournament-format" required>
                            <option value="single-elimination" ${t.format === 'single-elimination' ? 'selected' : ''}>Single Elimination</option>
                            <option value="kp" ${t.format === 'kp' ? 'selected' : ''}>KP Format</option>
                        </select>
                    </div>
                    <div id="update-kp-format-fields" style="display: ${t.format === 'kp' ? 'block' : 'none'};">
                        <h4 class="form-label" style="margin-top: 1.5rem; margin-bottom: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">KP Format Schedule</h4>
                        <div class="form-grid">
                        <div class="form-group"><label class="form-label">Qualifier 1</label><input type="datetime-local" name="qualifier1Date" class="form-input" value="${formattedDate(findDate('Qualifier 1'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 2</label><input type="datetime-local" name="qualifier2Date" class="form-input" value="${formattedDate(findDate('Qualifier 2'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 3</label><input type="datetime-local" name="qualifier3Date" class="form-input" value="${formattedDate(findDate('Qualifier 3'))}"></div>
                        <div class="form-group"><label class="form-label">Qualifier 4</label><input type="datetime-local" name="qualifier4Date" class="form-input" value="${formattedDate(findDate('Qualifier 4'))}"></div>
                        <div class="form-group"><label class="form-label">Final Match</label><input type="datetime-local" name="finalMatchDate" class="form-input" value="${formattedDate(findDate('Final Match'))}"></div>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">New Poster Image (Optional)</label><input type="file" name="posterImage" class="form-input" accept="image/*"></div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Save Changes</button>
                    </div>
                </form>
            `;
        }


        function getUpdateStatusHTML(t) {
            const statuses = ['upcoming', 'registration_open', 'registration_closed', 'ongoing', 'ended'];
            const options = statuses.map(s =>
                `<option value="${s}" ${t.status === s ? 'selected' : ''}>
                    ${s.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </option>`
            ).join('');
            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Update Status: ${t.title || t.name}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel">&times;</button>
                </div>
                <form id="update-status-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    <div class="form-group">
                        <label class="form-label">New Status</label>
                        <select name="status" class="form-select">${options}</select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Save Status</button>
                    </div>
                </form>
            `;
        }

        function getUpdateScheduleHTML(t) {

            const scheduleEvents = t.scheduleEvents || [];
            const eventsHtml = scheduleEvents.map((event, index) => {
                let eventDateTime = '';

                if (event.datetime) {
                    // Handle ISO datetime format
                    eventDateTime = event.datetime.slice(0, 16);
                } else if (event.date && event.time) {
                    // Handle separate date and time fields (like your mock data)
                    const timeStr = event.time.slice(0, 5); // "11:00:00" becomes "11:00"
                    eventDateTime = `${event.date}T${timeStr}`; // "2025-10-05T11:00"
                }

                return `
                    <div class="schedule-event" draggable="true" data-index="${index}" style="border:1px solid var(--border-color); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <div class="form-group">
                            <label class="form-label">Event Title</label>
                            <input type="text" name="events[${index}][title]" class="form-input" value="${event.title || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description (1 line)</label>
                            <input type="text" name="events[${index}][description]" class="form-input" value="${event.description || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date & Time</label>
                            <input type="datetime-local" name="events[${index}][datetime]" class="form-input" value="${eventDateTime}" required>
                        </div>
                        <button type="button" class="btn-icon delete" onclick="removeScheduleEvent(this)" style="float: right; color: #ff6b6b;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Update Schedule: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="renderOperation('update')" title="Cancel">&times;</button>
                </div>
                <form id="update-schedule-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    
                    <div id="schedule-events-container">
                        ${eventsHtml || '<p style="text-align:center; color: var(--muted); margin: 1rem 0;">No schedule events yet. Click "Add Event" to create one.</p>'}
                    </div>
                    
                    <button type="button" class="submit-btn btn-info" onclick="addScheduleEvent()">+ Add Event</button>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Confirm Schedule</button>
                    </div>
                </form>
            `;
        }

        function renderOperation(operationName, data = null) {
            const container = document.getElementById('operation-content');
            if (!container) return;
            // Clear any old content before rendering new
            container.innerHTML = ''; 

            let contentHtml = '';
            switch (operationName) {
                case 'create':
                    contentHtml = getCreateFormHTML();
                    break;
                case 'update':
                    contentHtml = `
                        <h3 class="operation-title">Update Tournament</h3>
                        <p style="color: var(--text-secondary);">Select a tournament from the list below to edit its details.</p>
                        <div id="update-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'delete':
                    contentHtml = `
                        <h3 class="operation-title">Delete Tournament</h3>
                        <p style="color: var(--text-secondary);">Click the trash icon on a tournament in the list above to delete it. This action is permanent.</p>
                        <div id="delete-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;

                case 'finalists':
                    contentHtml = `
                        <h3 class="operation-title">Update Finalists Leaderboard</h3>
                        <p style="color: var(--text-secondary);">Select a tournament to manage its finalists leaderboard (Top 16 teams).</p>
                        <div id="finalists-tournament-list" class="admin-tournament-list" style="margin-top: 1.5rem;"></div>
                    `;
                    break;
                case 'edit':
                    if (data) contentHtml = getUpdateFormHTML(data);
                    break;
                case 'statusUpdate':
                    if (data) contentHtml = getUpdateStatusHTML(data);
                    break;
                case 'scheduleUpdate':
                    if (data) contentHtml = getUpdateScheduleHTML(data);
                    break;
                case 'finalistsEditor':
                    if (data) contentHtml = getFinalistsEditorHTML(data);
                    break;
                default:
                    // If no operation is selected, just clear the content
                    container.innerHTML = '';
                    return;
            }
            container.innerHTML = contentHtml;

            // Post-render logic
            if (operationName === 'create') {
                const form = document.getElementById('create-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleCreateFormSubmit);
                    const formatSelector = form.querySelector('#tournament-format');
                    const kpFields = form.querySelector('#kp-format-fields');
                    formatSelector.addEventListener('change', () => { kpFields.style.display = (formatSelector.value === 'kp') ? 'block' : 'none'; });
                }
            } else if (operationName === 'edit') {
                const form = document.getElementById('update-tournament-form');
                if (form) {
                    form.addEventListener('submit', handleUpdateFormSubmit);
                    const formatSelector = form.querySelector('#update-tournament-format');
                    const kpFields = form.querySelector('#update-kp-format-fields');
                    if (formatSelector && kpFields) {
                        formatSelector.addEventListener('change', () => {
                            kpFields.style.display = (formatSelector.value === 'kp') ? 'block' : 'none';
                        });
                    }
                }
            } else if (operationName === 'statusUpdate') {
                const form = document.getElementById('update-status-form');
                if (form) form.addEventListener('submit', handleStatusUpdateSubmit);
            } else if (operationName === 'scheduleUpdate') {
                const form = document.getElementById('update-schedule-form');
                if (form) {
                    form.addEventListener('submit', handleScheduleUpdateSubmit);
                    initDragAndDrop(); // Initialize drag and drop for the schedule editor
                }
            } else if (['update', 'delete', 'download'].includes(operationName)) {
                renderTournamentList(`${operationName}-tournament-list`, adminTournaments, operationName);
            } else if (operationName === 'finalistsEditor') {
                const form = document.getElementById('update-finalists-form');
                if (form) form.addEventListener('submit', handleFinalistsUpdateSubmit);
            } else if (['update', 'delete', 'download', 'finalists'].includes(operationName)) {
                renderTournamentList(`${operationName}-tournament-list`, adminTournaments, operationName);
            }
        }

        async function handleCreateFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Creating...'; btn.disabled = true;
            try {
                const formData = new FormData();

                // Add all form fields, including file only if selected
                const formElements = form.elements;
                for (let element of formElements) {
                    if (element.type === 'file') {
                        // Only include file if user selected one
                        if (element.files && element.files.length > 0 && element.files[0].size > 0) {
                            formData.append(element.name, element.files[0]);
                        }
                    } else if (element.name && element.value !== undefined) {
                        formData.append(element.name, element.value);
                    }
                }

                const response = await fetch(`${API_BASE_URL}/api/tournaments`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${getSessionData()?.token}` }, body: formData
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Creation Success', 'Tournament created successfully!', 'success');
                    form.reset();
                    loadAdminTournaments();
                    clearOperationContent();
                } else {
                    throw new Error(result.detail || 'Failed to create tournament.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error: ' + error.message, 'error');
            } finally {
                btn.textContent = 'Create Tournament'; btn.disabled = false;
            }
        }

        async function handleUpdateFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                showCustomAlert("Mock Tournament", "This is a mock tournament and cannot be updated via API.", 'info');
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const formData = new FormData();

                // Add all form fields except file inputs
                const formElements = form.elements;
                for (let element of formElements) {
                    if (element.type === 'file') {
                        // Only include file if user selected one
                        if (element.files && element.files.length > 0 && element.files[0].size > 0) {
                            formData.append(element.name, element.files[0]);
                        }
                    } else if (element.name && element.value !== undefined) {
                        formData.append(element.name, element.value);
                    }
                }

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`
                    },
                    body: formData
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', 'Tournament updated successfully!', 'success');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update tournament.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error: ' + error.message, 'error');
            } finally {
                btn.textContent = 'Save Changes';
                btn.disabled = false;
            }
        }


        async function handleScheduleUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                showCustomAlert("Mock Tournament", "This is a mock tournament. Schedule cannot be updated.", 'info');
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('button[type="submit"]');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const events = [];
                const container = document.getElementById('schedule-events-container');
                const eventBlocks = container.querySelectorAll('.schedule-event');

                eventBlocks.forEach(block => {
                    const datetimeValue = block.querySelector('input[name*="[datetime]"]').value;
                    const [date, time] = datetimeValue ? datetimeValue.split('T') : [null, null];

                    events.push({
                        title: block.querySelector('input[name*="[title]"]').value,
                        description: block.querySelector('input[name*="[description]"]').value,
                        datetime: datetimeValue,
                        date: date,
                        time: time ? time + ":00" : null
                    });
                });

                // Use the correct endpoint that now exists
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/schedule`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: events })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', 'Schedule updated successfully!', 'success');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update schedule.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error: ' + error.message, 'error');
            } finally {
                btn.textContent = 'Confirm Schedule';
                btn.disabled = false;
            }
        }

        function addScheduleEvent() {
            const container = document.getElementById('schedule-events-container');
            if (!container) return;

            // Remove placeholder if it exists
            const placeholder = container.querySelector('p');
            if (placeholder) placeholder.remove();

            const index = container.children.length;
            const eventHtml = `
                <div class="schedule-event" draggable="true" data-index="${index}" style="border:1px solid var(--border-color); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="events[${index}][title]" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description (1 line)</label>
                        <input type="text" name="events[${index}][description]" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date & Time</label>
                        <input type="datetime-local" name="events[${index}][datetime]" class="form-input" required>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', eventHtml);
        }

        function getFinalistsEditorHTML(t) {
            // Get existing finalists or create empty array for 16 teams
            const finalists = t.finalists || Array.from({ length: 16 }, (_, i) => ({
                position: i + 1,
                teamName: '',
                totalPoints: 0
            }));

            // Ensure we have exactly 16 slots
            while (finalists.length < 16) {
                finalists.push({
                    position: finalists.length + 1,
                    teamName: '',
                    totalPoints: 0
                });
            }
            finalists.splice(16); // Keep only first 16

            const finalistsHtml = finalists.map((finalist, index) => `
                <div class="finalist-entry" style="display: grid; grid-template-columns: 60px 1fr 120px auto; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; background: rgba(0,0,0,0.2);">
                    <div style="font-weight: 700; text-align: center; color: var(--primary-color);">#${index + 1}</div>
                    <div class="form-group" style="margin: 0;">
                        <input type="text" name="finalists[${index}][teamName]" class="form-input" value="${finalist.teamName || ''}" placeholder="Enter team name" style="margin: 0; padding: 0.5rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <input type="number" name="finalists[${index}][totalPoints]" class="form-input" value="${finalist.totalPoints || 0}" placeholder="Points" min="0" style="margin: 0; padding: 0.5rem;">
                    </div>
                    <button type="button" class="btn-icon" onclick="clearFinalistEntry(${index})" title="Clear Entry" style="color: var(--text-secondary);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            return `
                <div class="operation-title-header">
                    <h3 class="operation-title">Finalists Leaderboard: ${t.title}</h3>
                    <button type="button" class="close-btn" onclick="showUpdateFinalists()" title="Back to Finalists List">&times;</button>
                </div>
                <form id="update-finalists-form">
                    <input type="hidden" name="slug" value="${t.slug}">
                    
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 69, 0, 0.1); border-radius: 8px; border: 1px solid var(--border-color);">
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                            Enter the top 16 teams in order of their final ranking. Leave entries blank if fewer than 16 teams made it to finals.
                        </p>
                    </div>
                    
                    <div class="finalists-container">
                        ${finalistsHtml}
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="submit-btn btn-secondary" onclick="autoFillFromParticipants('${t.slug}')">Auto-fill from Participants</button>
                        <button type="submit" class="submit-btn">Save Finalists</button>
                    </div>
                </form>
            `;
        }

        function clearFinalistEntry(index) {
            const container = document.querySelector('.finalists-container');
            const entry = container.children[index];
            if (entry) {
                entry.querySelector('input[name*="[teamName]"]').value = '';
                entry.querySelector('input[name*="[totalPoints]"]').value = '0';
            }
        }

        function autoFillFromParticipants(slug) {
            const tournament = adminTournaments.find(t => t.slug === slug);
            if (!tournament || !tournament.participants) {
                showCustomAlert('Warning', 'No participants found for this tournament.', 'warning');
                return;
            }

            const participants = tournament.participants.slice(0, 16); // Get first 16 teams
            const container = document.querySelector('.finalists-container');

            participants.forEach((participant, index) => {
                const entry = container.children[index];
                if (entry) {
                    entry.querySelector('input[name*="[teamName]"]').value = participant.teamName || '';
                }
            });

            showCustomAlert('Info', `Auto-filled ${participants.length} teams from participants list.`, 'info');
        }

        async function handleFinalistsUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;

            if (slug === 'dev-test-championship') {
                showCustomAlert("Mock Tournament", "This is a mock tournament. Finalists cannot be updated.", 'info');
                showUpdateFinalists();
                return;
            }

            const btn = form.querySelector('button[type="submit"]');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const finalists = [];
                const container = document.querySelector('.finalists-container');
                const entries = container.querySelectorAll('.finalist-entry');

                entries.forEach((entry, index) => {
                    const teamName = entry.querySelector('input[name*="[teamName]"]').value.trim();
                    const totalPoints = parseInt(entry.querySelector('input[name*="[totalPoints]"]').value) || 0;

                    if (teamName) { // Only add non-empty team names
                        finalists.push({
                            position: index + 1,
                            teamName: teamName,
                            totalPoints: totalPoints
                        });
                    }
                });

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/finalists`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ finalists: finalists })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    showCustomAlert('Update Success', `Finalists updated successfully! ${finalists.length} teams saved.`, 'success');
                    await loadAdminTournaments();
                    showUpdateFinalists();
                } else {
                    throw new Error(result.detail || 'Failed to update finalists.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error: ' + error.message, 'error');
            } finally {
                btn.textContent = 'Save Finalists';
                btn.disabled = false;
            }
        }

        async function handleStatusUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const slug = form.querySelector('input[name="slug"]').value;
            const newStatus = form.querySelector('select[name="status"]').value;

            if (slug === 'dev-test-championship') {
                showCustomAlert("Mock Tournament", "This is a mock tournament. Status cannot be saved.", 'info');
                renderOperation('update');
                return;
            }

            const btn = form.querySelector('.submit-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${getSessionData()?.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showCustomAlert('Update Success', 'Tournament status updated successfully!', 'success');
                    await loadAdminTournaments();
                    renderOperation('update');
                } else {
                    throw new Error(result.detail || 'Failed to update status.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Error: ' + error.message, 'error');
            } finally {
                btn.textContent = 'Save Status';
                btn.disabled = false;
            }
        }


        function initDragAndDrop() {
            const container = document.getElementById('schedule-events-container');
            if (!container) return;

            let draggingElement = null;

            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('schedule-event')) {
                    draggingElement = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('schedule-event')) {
                    e.target.classList.remove('dragging');
                    draggingElement = null;
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggingElement) return;

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggingElement);
                } else {
                    container.insertBefore(draggingElement, afterElement);
                }
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.schedule-event:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        // Smart Navbar Scroll Behavior
        function initSmartNavbar() {
            const navbar = document.querySelector('.nav-normal');
            if (!navbar) return;

            let lastScrollY = window.scrollY;
            let ticking = false;

            function updateNavbar() {
                const currentScrollY = window.scrollY;

                // Add scrolled class when user has scrolled down
                if (currentScrollY > 50) {
                    navbar.classList.add('nav-scrolled');
                } else {
                    navbar.classList.remove('nav-scrolled');
                }

                // Hide/show navbar based on scroll direction
                if (currentScrollY > 100) { // Only start hiding after scrolling 100px
                    if (currentScrollY > lastScrollY && currentScrollY > 200) {
                        // Scrolling down - hide navbar
                        navbar.classList.add('nav-hidden');
                    } else {
                        // Scrolling up - show navbar
                        navbar.classList.remove('nav-hidden');
                    }
                } else {
                    // Always show navbar when near top
                    navbar.classList.remove('nav-hidden');
                }

                lastScrollY = currentScrollY;
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateNavbar);
                    ticking = true;
                }
            }

            // Listen for scroll events
            window.addEventListener('scroll', requestTick, { passive: true });

            // Initial call
            updateNavbar();
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Hide loader
            setTimeout(() => {
                document.getElementById('loader-wrapper').classList.add('hidden');
            }, 1000);

            // Check admin authentication first - redirect if not authorized
            if (!checkAdminAuth()) {
                return; // Stop execution if not authorized
            }

            checkUserAuthentication();
            initSmartNavbar(); // Initialize smart scroll behavior
            loadAdminTournaments(); // Load tournaments
            loadRecentActivity();
            renderPayoutsManagement(); // Load payouts on start

            // Operation tabs removed - functionality moved to section action buttons
        });


    </script>
</body>

</html>
