<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tournament Analytics - GamingNexus</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* =========================
       Theme variables (Cyberpunk) - Matching index.html
       ========================= */
    :root {
      --primary-color: #0AFAD9;
      --bg-dark: #0D0A1A;
      --accent-secondary: #5D3FD3;
      --panel: #161329;
      --text-primary: #F0F0F0;
      --text-secondary: rgba(240, 240, 240, 0.7);
      --border-color: rgba(10, 250, 217, 0.2);
      --ease: 0.3s ease;

      --copy: var(--text-primary);
      --muted: var(--text-secondary);
      --accent: var(--accent-secondary);
      --accent-2: var(--primary-color);
      --radius: 12px;
      --container: 1400px;

      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: min(94%, var(--container));
      margin: 0 auto;
    }

    /* Header Styles */
    header.site-header {
      position: fixed;
      inset: 0 0 auto 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      background: rgba(26, 26, 26, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1200;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s var(--ease);
      height: 60px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--copy);
      font-size: 1.2rem;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .brand:hover {
      color: var(--primary-color);
      transform: scale(1.05);
    }

    .back-btn {
      color: var(--muted);
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .back-btn:hover {
      color: var(--primary-color);
    }

    /* Main content */
    main {
      margin-top: 60px;
      min-height: calc(100vh - 60px);
      padding: 2rem 0;
    }

    /* Page Header */
    .page-header {
      padding: 4rem 0 2rem;
      text-align: center;
    }

    .page-title {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 800;
      margin-bottom: 1rem;
      line-height: 1.1;
    }

    .page-subtitle {
      font-size: 1.2rem;
      color: var(--muted);
      max-width: 600px;
      margin: 0 auto 2rem;
      line-height: 1.5;
    }

    /* Analytics Cards */
    .analytics-section {
      padding: 2rem 0;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .analytics-card {
      background: var(--panel);
      border-radius: 16px;
      padding: 2rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: var(--primary-color);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .card-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--bg-dark);
      font-size: 1.2rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .performance-grade {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.2rem;
      margin-top: 1rem;
    }

    .grade-a { background: var(--success-color); color: white; }
    .grade-b { background: var(--info-color); color: white; }
    .grade-c { background: var(--warning-color); color: var(--bg-dark); }
    .grade-d { background: var(--danger-color); color: white; }

    /* Chart Container */
    .chart-container {
      background: var(--panel);
      border-radius: 16px;
      padding: 2rem;
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
    }

    .chart-header {
      margin-bottom: 2rem;
    }

    .chart-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .chart-subtitle {
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* Tournament List */
    .tournament-list {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .tournament-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .tournament-item:last-child {
      border-bottom: none;
    }

    .tournament-item:hover {
      background: rgba(10, 250, 217, 0.05);
    }

    .tournament-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .tournament-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent-secondary), var(--primary-color));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--bg-dark);
      font-size: 1.2rem;
    }

    .tournament-details h4 {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 1.1rem;
    }

    .tournament-meta {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .tournament-stats {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .tournament-stat {
      text-align: center;
    }

    .tournament-stat-value {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.1rem;
    }

    .tournament-stat-label {
      color: var(--muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 4rem 0;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(10, 250, 217, 0.3);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }

      .tournament-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .tournament-stats {
        width: 100%;
        justify-content: space-around;
      }

      .page-title {
        font-size: clamp(2rem, 8vw, 3rem);
      }

      .site-header {
        padding: 0 1rem;
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <a href="user-dashboard.html" class="back-btn">
      <i class="fas fa-arrow-left"></i>
      Back to Dashboard
    </a>

    <a href="index.html" class="brand">
      GamingNexus
    </a>

    <div class="nav-actions">
      <!-- Profile dropdown would go here -->
    </div>
  </header>

  <main>
    <!-- Page Header -->
    <section class="page-header">
      <div class="container">
        <h1 class="page-title">My Tournament Analytics</h1>
        <p class="page-subtitle">
          Detailed insights and performance metrics for your tournaments
        </p>
      </div>
    </section>

    <!-- Analytics Overview -->
    <section class="analytics-section">
      <div class="container">
        <div class="analytics-grid">
          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Total Tournaments</div>
              <div class="card-icon">
                <i class="fas fa-trophy"></i>
              </div>
            </div>
            <div class="stat-value" id="total-tournaments">-</div>
            <div class="stat-label">Tournaments Created</div>
          </div>

          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Total Participants</div>
              <div class="card-icon">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="stat-value" id="total-participants">-</div>
            <div class="stat-label">Teams Registered</div>
          </div>

          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Total Revenue</div>
              <div class="card-icon">
                <i class="fas fa-coins"></i>
              </div>
            </div>
            <div class="stat-value" id="total-revenue">-</div>
            <div class="stat-label">Entry Fees Collected</div>
          </div>

          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Organizer Score</div>
              <div class="card-icon">
                <i class="fas fa-star"></i>
              </div>
            </div>
            <div class="stat-value" id="organizer-score">-</div>
            <div class="stat-label">Performance Rating</div>
            <div class="performance-grade" id="performance-grade" style="display: none;">A</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="analytics-grid">
          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Tournament Performance</h3>
              <p class="chart-subtitle">Participants vs capacity over time</p>
            </div>
            <canvas id="performanceChart" width="400" height="300"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Tournament Status</h3>
              <p class="chart-subtitle">Distribution by status</p>
            </div>
            <canvas id="statusChart" width="400" height="300"></canvas>
          </div>
        </div>

        <!-- My Tournaments -->
        <div class="tournament-list" id="tournament-list">
          <div class="card-header" style="padding: 2rem 2rem 0 2rem;">
            <h3 class="card-title">My Tournaments</h3>
          </div>
          
          <!-- Tournament items will be populated dynamically -->
        </div>
      </div>
    </section>
  </main>

  <script>
    // Global variables
    let performanceChart, statusChart;
    let analyticsData = null;

    // Initialize page when DOM loads
    document.addEventListener('DOMContentLoaded', function () {
      loadOrganizerAnalytics();
    });

    // Load organizer analytics data
    async function loadOrganizerAnalytics() {
      try {
        showLoading();
        
        // Get JWT token from localStorage
        const token = localStorage.getItem('jwt_token');
        if (!token) {
          window.location.href = 'auth.html';
          return;
        }

        // Fetch organizer analytics
        const response = await fetch('/api/users/me/organizer-analytics', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.status === 401) {
          localStorage.removeItem('jwt_token');
          window.location.href = 'auth.html';
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        analyticsData = await response.json();
        
        if (analyticsData.success) {
          updateAnalyticsDisplay(analyticsData);
          initializeCharts(analyticsData);
          await loadMyTournaments(token);
        } else {
          throw new Error(analyticsData.error || 'Failed to load analytics');
        }

        hideLoading();
      } catch (error) {
        console.error('Error loading organizer analytics:', error);
        hideLoading();
        showError('Failed to load analytics data. Please try again.');
      }
    }

    // Update analytics display with real data
    function updateAnalyticsDisplay(data) {
      document.getElementById('total-tournaments').textContent = data.totalTournaments || 0;
      document.getElementById('total-participants').textContent = data.totalParticipants || 0;
      document.getElementById('total-revenue').textContent = `₹${formatCurrency(data.totalRevenue || 0)}`;
      document.getElementById('organizer-score').textContent = Math.round(data.organizerScore || 0);
      
      // Show performance grade
      const grade = getPerformanceGrade(data.organizerScore || 0);
      const gradeElement = document.getElementById('performance-grade');
      gradeElement.textContent = grade;
      gradeElement.className = `performance-grade grade-${grade.toLowerCase()}`;
      gradeElement.style.display = 'inline-block';
    }

    // Get performance grade based on score
    function getPerformanceGrade(score) {
      if (score >= 80) return 'A';
      if (score >= 60) return 'B';
      if (score >= 40) return 'C';
      return 'D';
    }

    // Initialize charts
    function initializeCharts(data) {
      initializePerformanceChart(data);
      initializeStatusChart(data);
    }

    // Initialize performance chart
    function initializePerformanceChart(data) {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      
      // Generate sample performance data
      const performanceData = generatePerformanceData(data);
      
      performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: performanceData.labels,
          datasets: [{
            label: 'Average Fill Rate (%)',
            data: performanceData.fillRates,
            borderColor: '#0AFAD9',
            backgroundColor: 'rgba(10, 250, 217, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'Tournaments Created',
            data: performanceData.tournamentCounts,
            borderColor: '#5D3FD3',
            backgroundColor: 'rgba(93, 63, 211, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#F0F0F0'
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: {
                color: '#F0F0F0'
              },
              grid: {
                color: 'rgba(240, 240, 240, 0.1)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              ticks: {
                color: '#F0F0F0'
              },
              grid: {
                drawOnChartArea: false,
              }
            },
            x: {
              ticks: {
                color: '#F0F0F0'
              },
              grid: {
                color: 'rgba(240, 240, 240, 0.1)'
              }
            }
          }
        }
      });
    }

    // Initialize status chart
    function initializeStatusChart(data) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      
      const statusData = data.statusDistribution || {};
      const labels = Object.keys(statusData);
      const values = Object.values(statusData);
      
      if (labels.length === 0) {
        labels.push('No Data');
        values.push(1);
      }
      
      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(label => label.replace('_', ' ').toUpperCase()),
          datasets: [{
            data: values,
            backgroundColor: [
              '#0AFAD9',
              '#5D3FD3',
              '#28a745',
              '#ffc107',
              '#dc3545',
              '#17a2b8'
            ],
            borderWidth: 2,
            borderColor: '#161329'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#F0F0F0'
              }
            }
          }
        }
      });
    }

    // Generate performance data
    function generatePerformanceData(data) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      const fillRates = [];
      const tournamentCounts = [];
      
      // Generate sample data based on total tournaments
      const totalTournaments = data.totalTournaments || 0;
      const avgTournamentsPerMonth = Math.max(1, Math.floor(totalTournaments / 6));
      
      for (let i = 0; i < months.length; i++) {
        fillRates.push(Math.random() * 30 + 70); // 70-100% fill rate
        tournamentCounts.push(Math.floor(Math.random() * avgTournamentsPerMonth) + 1);
      }
      
      return {
        labels: months,
        fillRates: fillRates,
        tournamentCounts: tournamentCounts
      };
    }

    // Load my tournaments
    async function loadMyTournaments(token) {
      try {
        const response = await fetch('/api/user-tournaments', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const tournamentsData = await response.json();
          if (tournamentsData.success && tournamentsData.data) {
            displayMyTournaments(tournamentsData.data);
          }
        }
      } catch (error) {
        console.error('Error loading tournaments:', error);
      }
    }

    // Display my tournaments
    function displayMyTournaments(tournaments) {
      const tournamentList = document.getElementById('tournament-list');
      
      // Clear existing items except header
      const header = tournamentList.querySelector('.card-header');
      tournamentList.innerHTML = '';
      tournamentList.appendChild(header);
      
      if (!tournaments || tournaments.length === 0) {
        const noTournaments = document.createElement('div');
        noTournaments.className = 'tournament-item';
        noTournaments.style.textAlign = 'center';
        noTournaments.style.color = 'var(--muted)';
        noTournaments.innerHTML = '<p>No tournaments created yet. <a href="tournaments.html" style="color: var(--primary-color);">Create your first tournament</a></p>';
        tournamentList.appendChild(noTournaments);
        return;
      }
      
      tournaments.forEach(tournament => {
        const tournamentItem = createTournamentItem(tournament);
        tournamentList.appendChild(tournamentItem);
      });
    }

    // Create tournament item element
    function createTournamentItem(tournament) {
      const item = document.createElement('div');
      item.className = 'tournament-item';
      
      const participants = tournament.participants || [];
      const maxTeams = tournament.maxTeams || 1;
      const fillRate = Math.round((participants.length / maxTeams) * 100);
      const prizePool = tournament.prizePool || 0;
      
      // Get tournament status display
      const statusInfo = getTournamentStatusInfo(tournament);
      
      // Get game icon
      const gameIcon = getGameIcon(tournament.game);
      
      item.innerHTML = `
        <div class="tournament-info">
          <div class="tournament-icon">
            <i class="${gameIcon}"></i>
          </div>
          <div class="tournament-details">
            <h4>${tournament.title}</h4>
            <div class="tournament-meta">${statusInfo.text}</div>
          </div>
        </div>
        <div class="tournament-stats">
          <div class="tournament-stat">
            <div class="tournament-stat-value">${participants.length}</div>
            <div class="tournament-stat-label">Teams</div>
          </div>
          <div class="tournament-stat">
            <div class="tournament-stat-value">₹${formatCurrency(prizePool)}</div>
            <div class="tournament-stat-label">Prize Pool</div>
          </div>
          <div class="tournament-stat">
            <div class="tournament-stat-value">${fillRate}%</div>
            <div class="tournament-stat-label">Fill Rate</div>
          </div>
        </div>
      `;
      
      // Add click handler to view tournament analytics
      item.addEventListener('click', () => {
        viewTournamentAnalytics(tournament._id);
      });
      
      return item;
    }

    // View individual tournament analytics
    function viewTournamentAnalytics(tournamentId) {
      // This would open a detailed analytics view for the specific tournament
      console.log('View analytics for tournament:', tournamentId);
      // For now, just log - in a real app, this would navigate to a detailed view
    }

    // Get tournament status information
    function getTournamentStatusInfo(tournament) {
      const status = tournament.status;
      const now = new Date();
      const startDate = new Date(tournament.tournamentStart);
      const endDate = new Date(tournament.tournamentEnd);
      
      switch (status) {
        case 'completed':
          const daysAgo = Math.floor((now - endDate) / (1000 * 60 * 60 * 24));
          return { text: `Completed • ${daysAgo} days ago`, class: 'completed' };
        case 'active':
        case 'ongoing':
          if (now >= startDate && now <= endDate) {
            const hoursRemaining = Math.ceil((endDate - now) / (1000 * 60 * 60));
            return { text: `Live • ${hoursRemaining}h remaining`, class: 'live' };
          }
          return { text: 'Active', class: 'active' };
        case 'registration_open':
          const daysUntilStart = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
          return { text: `Upcoming • Starts in ${daysUntilStart} days`, class: 'upcoming' };
        default:
          return { text: status.replace('_', ' ').toUpperCase(), class: 'default' };
      }
    }

    // Get game icon based on game name
    function getGameIcon(game) {
      const gameIcons = {
        'PUBG Mobile': 'fas fa-gamepad',
        'BGMI': 'fas fa-crosshairs',
        'Valorant': 'fas fa-fire',
        'CS:GO': 'fas fa-bullseye',
        'Free Fire': 'fas fa-flame',
        'Call of Duty': 'fas fa-rocket'
      };
      
      return gameIcons[game] || 'fas fa-trophy';
    }

    // Utility functions
    function formatCurrency(amount) {
      if (amount >= 10000000) {
        return (amount / 10000000).toFixed(1) + 'Cr';
      } else if (amount >= 100000) {
        return (amount / 100000).toFixed(1) + 'L';
      } else if (amount >= 1000) {
        return (amount / 1000).toFixed(1) + 'K';
      }
      return amount.toString();
    }

    function showLoading() {
      const main = document.querySelector('main');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading';
      loadingDiv.id = 'loading-spinner';
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading your analytics...</p>
      `;
      main.appendChild(loadingDiv);
    }

    function hideLoading() {
      const loading = document.getElementById('loading-spinner');
      if (loading) {
        loading.remove();
      }
    }

    function showError(message) {
      const main = document.querySelector('main');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.cssText = `
        background: var(--panel);
        border: 1px solid var(--danger-color);
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem auto;
        max-width: 600px;
        text-align: center;
        color: var(--danger-color);
      `;
      errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
        <p>${message}</p>
        <button onclick="loadOrganizerAnalytics()" style="
          background: var(--primary-color);
          color: var(--bg-dark);
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          margin-top: 1rem;
        ">Retry</button>
      `;
      main.appendChild(errorDiv);
    }

    // Refresh data every 5 minutes
    setInterval(loadOrganizerAnalytics, 300000);
  </script>
</body>

</html>