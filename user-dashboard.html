<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | GamingNexus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.1/dist/dotlottie-wc.js" type="module"></script>
    <link rel="stylesheet" href="navbar.css">

    <style>
        /* Theme variables (Cyberpunk) */
        :root {
          --primary-color: #0AFAD9;      /* Electric Cyan */
          --bg-dark: #0D0A1A;            /* Dark Matter Black */
          --accent-secondary: #5D3FD3;   /* Deep Indigo */
          --panel: #161329;              /* Dark Indigo Panel */
          --text-primary: #F0F0F0;       /* Starlight White */
          --text-secondary: rgba(240, 240, 240, 0.7);
          --border-color: rgba(10, 250, 217, 0.2);
          --ease: 0.3s ease;
          --radius: 12px;
          --container: 1200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Loader */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .main-content {
            margin-top: 80px; /* Adjust for fixed header height */
            padding: 2rem;
            max-width: var(--container);
            margin-left: auto;
            margin-right: auto;
        }

        .dashboard-header {
            margin-bottom: 3rem;
        }

        .dashboard-title {
            font-size: clamp(2rem, 4vw, 2.5rem);
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        .dashboard-title .accent { color: var(--primary-color); }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(10, 250, 217, 0.1);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .dashboard-section {
            background: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--bg-dark);
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(10, 250, 217, 0.2);
        }

        .tournament-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tournament-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tournament-item:hover {
            background: rgba(10, 250, 217, 0.1);
        }

        .tournament-info a {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            text-decoration: none;
        }
        .tournament-info a:hover { text-decoration: underline; color: var(--primary-color); }
        .tournament-status {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .tournament-status.ended { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .tournament-status.ongoing { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .tournament-status.registration-open { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            color: var(--primary-color);
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .tournament-card {
            background: var(--panel);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
    
        .tournament-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }
        
        .tournament-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .tournament-content {
            padding: 1rem;
        }
        
        .tournament-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .tournament-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-content { padding: 1.5rem; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div id="loader-wrapper">
      <dotlottie-wc src="https://lottie.host/f3668d34-e871-48f2-89e1-a802d02b8429/2gMMYTNzAd.lottie" style="width: 300px;height: 300px" autoplay loop></dotlottie-wc>
    </div>

    <header class="site-header"></header>

    <div id="mobile-nav" class="mobile-nav"></div>

    <main class="main-content" style="opacity: 0; transition: opacity 0.5s ease;">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Welcome back, <span id="welcome-username" class="accent">User</span>!</h1>
            <p class="dashboard-subtitle">Manage your tournaments and track your gaming progress.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value" id="tournaments-joined">0</span>
                <span class="stat-label">Tournaments Joined</span>
            </div>
        </div>

        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">My Tournaments</h2>
                <a href="index.html#tournaments" class="btn-primary">
                    <i class="fas fa-plus"></i> Join Tournament
                </a>
            </div>
            <div class="tournament-list" id="user-tournaments">
                <div class="empty-state">
                    <i class="fas fa-trophy"></i>
                    <h3>No tournaments yet</h3>
                    <p>Join your first tournament to get started!</p>
                </div>
            </div>
        </div>

        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">Recommended For You</h2>
            </div>
            <div class="recommendations-grid" id="recommendations-grid">
                 <div class="empty-state">
                    <p>Loading recommendations...</p>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- START: CONSOLIDATED SCRIPT (LOGIC FROM NAVBAR.JS + PAGE SCRIPT) ---

        // --- PART 1: LOGIC FROM NAVBAR.JS ---

        // Helper function to redirect to the authentication page
        function redirectToAuth(tab = 'register') {
            const returnUrl = encodeURIComponent(window.location.href);
            window.location.href = `auth.html?tab=${tab}&returnUrl=${returnUrl}`;
        }

        // Helper function to get user session data from localStorage
        function getSessionData() {
            const session = localStorage.getItem('nexus_session');
            try {
                return session ? JSON.parse(session) : null;
            } catch (error) {
                console.error("Error parsing session data:", error);
                return null;
            }
        }

        // Logout function to clear session and reload
        function logout() {
            localStorage.removeItem('nexus_session');
            window.location.reload();
        }

        // Updates the desktop navbar based on login status
        function checkUserAuthentication() {
            const sessionData = getSessionData();
            const guestMenu = document.getElementById('guest-menu');
            const userMenu = document.getElementById('user-menu');
            const user = sessionData?.user;

            if (user) {
                // User is logged in
                const username = user.username || user.email.split('@')[0];
                const modalUsername = document.getElementById('modal-username');
                if (modalUsername) modalUsername.textContent = username;

                if (guestMenu) guestMenu.style.display = 'none';
                if (userMenu) userMenu.style.display = 'flex';
            } else {
                // User is a guest
                if (guestMenu) guestMenu.style.display = 'flex';
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        // Builds and populates the mobile navigation panel
        function setupMobileNav() {
            const sessionData = getSessionData();
            const mobileNavContainer = document.getElementById('mobile-nav');
            if (!mobileNavContainer) return; // Safety check

            const user = sessionData?.user;
            const closeButtonHTML = `<button class="mobile-nav-close" aria-label="Close menu"><i class="fas fa-times"></i></button>`;
            const navLinksHTML = `
                <div class="mobile-nav-links">
                  <a href="index.html#tournaments">Tournaments</a>
                  <a href="index.html#why-us">Why Us</a>
                  <a href="index.html#faq">FAQ</a>
                </div>`;
            
            let userSectionHTML = '';

            if (user) {
                // Logged-in user view for mobile
                const username = user.username || user.email.split('@')[0];
                userSectionHTML = `
                  <div class="profile-header">
                    <div class="profile-photo"><i class="fas fa-user"></i></div>
                    <div class="profile-info"><div class="profile-username">${username}</div></div>
                  </div>
                  <div class="profile-actions">
                    <a href="user-dashboard.html" class="profile-action"><i class="fas fa-user-cog"></i> <span>My Account</span></a>
                    <button class="profile-action" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
                  </div>`;
            } else {
                // Guest view for mobile
                userSectionHTML = `
                  <div class="guest-view">
                    <i class="fas fa-gamepad"></i>
                    <p>Join the arena to compete, win prizes, and track your stats!</p>
                    <button class="header-cta" style="width: 100%; margin-top: 1rem;" onclick="redirectToAuth()">Join Us Now</button>
                  </div>`;
            }

            mobileNavContainer.innerHTML = `${closeButtonHTML}${userSectionHTML}${navLinksHTML}`;
        }

        // --- PART 2: LOGIC FROM USER-DASHBOARD.HTML ---

        const API_BASE_URL = 'https://t2-237c.onrender.com';

        function setLoading(isLoading) {
            const loader = document.getElementById('loader-wrapper');
            const mainContent = document.querySelector('.main-content');
            if (isLoading) {
                loader.classList.remove('hidden');
                mainContent.style.opacity = 0;
            } else {
                loader.classList.add('hidden');
                mainContent.style.opacity = 1;
            }
        }

        function checkAuthAndRedirect() {
            const sessionData = getSessionData();
            if (!sessionData || !sessionData.user) {
                window.location.href = 'auth.html';
                return null;
            }
            return sessionData;
        }

        async function loadUserData() {
            const sessionData = checkAuthAndRedirect();
            if (!sessionData) return;

            const user = sessionData.user;
            const username = user.username || user.email.split('@')[0];

            document.getElementById('welcome-username').textContent = username;

            try {
                await Promise.all([
                    loadUserTournaments(sessionData.token),
                    loadRecommendations()
                ]);
            } catch (error) {
                console.error('Error loading user data:', error);
            } finally {
                setLoading(false);
            }
        }

        async function loadUserTournaments(token) {
            const tournamentsContainer = document.getElementById('user-tournaments');
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/me/tournaments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch tournaments');

                const result = await response.json();
                if (result.success && result.data.length > 0) {
                    tournamentsContainer.innerHTML = result.data.map(t => {
                        const statusClass = t.status.replace('_', '-');
                        return `
                            <div class="tournament-item">
                                <div class="tournament-info">
                                    <a href="tournament-details.html?slug=${t.slug}">${t.title}</a>
                                    <div class="tournament-status ${statusClass}">${t.status.replace('_', ' ')}</div>
                                </div>
                                <div><a href="tournament-details.html?slug=${t.slug}" style="font-size: 0.9rem;">View</a></div>
                            </div>`;
                    }).join('');
                    document.getElementById('tournaments-joined').textContent = result.data.length;
                } else {
                     tournamentsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <h3>No tournaments yet</h3>
                            <p>Join your first tournament to get started!</p>
                        </div>`;
                }
            } catch (error) {
                console.error('Error loading tournaments:', error);
                tournamentsContainer.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Could not load tournaments.</p></div>`;
            }
        }
        
        async function loadRecommendations() {
            const recommendationsContainer = document.getElementById('recommendations-grid');
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments`);
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                const allTournaments = result.data || [];

                const recommendations = allTournaments.filter(t => t.status === 'registration_open').slice(0, 3);
                
                if (recommendations.length > 0) {
                    recommendationsContainer.innerHTML = recommendations.map(t => {
                        const poster = t.posterImage || 'https://placehold.co/600x400/161329/F0F0F0?text=Nexus';
                        return `
                            <a href="tournament-details.html?slug=${t.slug}" class="tournament-card">
                                <img src="${poster}" alt="${t.title}">
                                <div class="tournament-content">
                                    <h3>${t.title}</h3>
                                    <p>ðŸ’° â‚¹${(t.prizePool || 0).toLocaleString('en-IN')} Prize Pool</p>
                                </div>
                            </a>`;
                    }).join('');
                } else {
                    recommendationsContainer.innerHTML = `<div class="empty-state"><p>No open tournaments to recommend right now.</p></div>`;
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                recommendationsContainer.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Could not load recommendations.</p></div>`;
            }
        }

        // --- PART 3: INITIALIZATION LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            setLoading(true);
            const header = document.querySelector('.site-header');
            
            header.innerHTML = `
                <a href="index.html" class="brand">GamingNexus</a>
                <div class="header-right">
                    
                    <nav class="primary">
                        <div class="nav-links">
                            <a href="index.html#tournaments">Tournaments</a>
                            <a href="index.html#why-us">Why Us</a>
                            <a href="index.html#faq">FAQ</a>
                        </div>
                    </nav>
                    
                    <div class="nav-actions">
                        <div id="guest-menu" style="display: none;"><button class="header-cta" onclick="redirectToAuth()">Join Us</button></div>
                        <div id="user-menu" style="display: none;">
                            <div class="profile-dropdown">
                                <div class="profile-icon" id="profile-icon"><i class="fas fa-user-circle"></i></div>
                                <div class="profile-modal" id="profile-modal">
                                    <div class="profile-header">
                                        <div class="profile-photo"><i class="fas fa-user"></i></div>
                                        <div class="profile-info"><div class="profile-username" id="modal-username">User</div></div>
                                    </div>
                                    <div class="profile-actions">
                                        <a href="user-dashboard.html" class="profile-action"><i class="fas fa-user"></i><span>My Account</span></a>
                                        <button class="profile-action logout-action" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="hamburger" aria-label="Toggle menu"><i class="fas fa-bars"></i></button>
                </div>`;

            // Step 2: Now that HTML exists, add event listeners and populate navbar
            const hamburger = document.querySelector('.hamburger');
            const mobileNav = document.getElementById('mobile-nav');

            if (hamburger && mobileNav) {
                const closeMobileNav = () => {
                    mobileNav.classList.remove('is-open');
                    hamburger.setAttribute('aria-expanded', 'false');
                };

                hamburger.addEventListener('click', () => {
                    const isOpen = mobileNav.classList.toggle('is-open');
                    hamburger.setAttribute('aria-expanded', isOpen);
                });

                // Add event listener to the mobile nav container for closing
                mobileNav.addEventListener('click', (event) => {
                    if (event.target.closest('.mobile-nav-close')) {
                        closeMobileNav();
                    }
                });
            }

            // Step 3: Populate the navbar with user/guest data
            checkUserAuthentication();
            setupMobileNav();
            
            // Step 4: Load the main dashboard content
            loadUserData();
        });
    </script>
</body>
</html>