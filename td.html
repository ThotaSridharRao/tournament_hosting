<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tournament | EArena Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg: #0f0f10;
            --panel: #1f1f20;
            --muted: #9aa0a6;
            --copy: #e6e6e6;
            --accent: #FFD700;
            --accent-2: #e0ac10;
            --radius: 12px;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: var(--copy);
            line-height: 1.5;
            min-height: 100vh;
        }

        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(15, 15, 16, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .back-link {
            color: var(--muted);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: var(--accent);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--copy);
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--copy);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            border-color: rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
        }

        /* New Hero Section Styles */
        .tournament-hero {
            margin-top: 64px;
            height: 45vh;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem 24px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            background-color: #1a1a1a;
        }

        .tournament-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(15, 15, 16, 0.2) 0%, rgba(15, 15, 16, 1) 100%);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
        }

        .page-subtitle {
            font-size: 1.25rem;
            color: var(--muted);
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7);
        }

        .main-content {
            padding: 32px 24px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            align-items: start;
        }

        .main-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .sidebar-column {
            position: sticky;
            top: 88px;
            /* 64px header + 24px padding */
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .dashboard-section {
            background: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--copy);
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .info-list .label {
            color: var(--muted);
            font-weight: 500;
        }

        .info-list .value {
            font-weight: 600;
            color: var(--copy);
            text-align: right;
        }

        .tournament-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #000;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-2), var(--accent));
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--copy);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-delete {
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .team-count {
            color: var(--muted);
            font-size: 1rem;
        }

        .team-accordion {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .team-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
        }

        .team-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .team-header i {
            transition: transform 0.3s ease;
        }

        .team-item.open .team-header i {
            transform: rotate(180deg);
        }

        .team-players {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            border-top: 1px solid transparent;
        }

        .team-item.open .team-players {
            max-height: 500px;
            border-top-color: var(--border-color);
        }

        .players-list {
            padding: 0 1rem 1rem;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-radius: 6px;
        }

        .player-item:nth-child(odd) {
            background: rgba(0, 0, 0, 0.2);
        }

        .player-name {
            font-weight: 500;
        }

        .player-id {
            color: var(--muted);
            font-family: monospace;
        }

        .loading-state,
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: var(--muted);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--panel);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-modal-content {
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-modal:hover {
            color: var(--copy);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* Form Styles */
        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width,
        .full-width {
            grid-column: span 2;
        }

        .form-group label {
            font-weight: 600;
            color: var(--copy);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--copy);
            font-family: inherit;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Poster Upload Styles */
        .poster-upload-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .poster-preview {
            width: 200px;
            height: 280px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s ease;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        .poster-preview:hover {
            border-color: var(--accent);
        }

        .poster-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .poster-placeholder {
            text-align: center;
            color: var(--muted);
        }

        .poster-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .poster-placeholder p {
            margin: 0;
            font-size: 0.9rem;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .sidebar-column {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-group.full-width,
            .full-width {
                grid-column: span 1;
            }

            .edit-modal-content {
                max-width: 95%;
                padding: 1.5rem;
            }

            .poster-preview {
                width: 150px;
                height: 210px;
            }

            .page-title {
                font-size: 2.2rem;
            }

            .page-subtitle {
                font-size: 1.1rem;
            }

            .main-content {
                padding: 24px 16px;
            }
        }

        /* Custom Schedule Events */
        .custom-events {
            margin-top: 1rem;
        }

        /* KP Format Styles */
        .kp-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kp-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .kp-label {
            display: block;
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        .kp-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .kp-groups {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .kp-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--accent);
        }

        .kp-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .kp-group-title {
            font-weight: 600;
            color: var(--copy);
        }

        .kp-group-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kp-group-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .kp-group-status.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .kp-group-status.completed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        .kp-group-teams {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .kp-group-qualified {
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .kp-qualified-team {
            display: inline-block;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin: 0.25rem 0.25rem 0 0;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .kp-overview {
                grid-template-columns: 1fr;
            }
            
            .kp-groups {
                grid-template-columns: 1fr;
            }
        }

        .custom-event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            color: var(--copy);
            margin-bottom: 0.25rem;
        }

        .event-datetime {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .btn-edit {
            background: rgba(255, 215, 0, 0.1);
            color: var(--accent);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .btn-edit:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .btn-remove {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-remove:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .empty-schedule {
            text-align: center;
            padding: 1rem;
            color: var(--muted);
            font-style: italic;
        }

        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--copy);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .profile-icon:hover {
            color: var(--accent);
            background: rgba(255, 215, 0, 0.1);
            transform: scale(1.1);
        }

        .profile-modal {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            margin-top: 10px;
        }

        .profile-dropdown:hover .profile-modal {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-photo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), #e0ac10);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-username {
            font-weight: 700;
            color: var(--copy);
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .profile-role {
            background: linear-gradient(135deg, var(--accent), #e0ac10);
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .profile-actions {
            padding: 0.5rem;
        }

        .profile-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--copy);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            width: 100%;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        .profile-action:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
            transform: translateX(4px);
        }

        .logout-action:hover {
            background: rgba(255, 0, 0, 0.1);
            color: #ff6b6b;
        }

        .profile-action i {
            width: 16px;
            text-align: center;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-left">
            <a href="admin-dashboard.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
        </div>
        <div class="profile-dropdown">
            <div class="profile-icon" id="profile-icon">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-modal" id="profile-modal">
                <div class="profile-header">
                    <div class="profile-photo">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="profile-info">
                        <div class="profile-username" id="admin-username">Admin</div>
                        <div class="profile-role">Admin</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="admin-dashboard.html" class="profile-action">
                        <i class="fas fa-shield-alt"></i>
                        <span>Admin Dashboard</span>
                    </a>
                    <button class="profile-action logout-action" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <section class="tournament-hero" id="tournament-hero">
        <div class="hero-content">
            <h1 class="page-title" id="tournament-title">Loading Tournament...</h1>
            <p class="page-subtitle" id="tournament-game">Loading Game...</p>
        </div>
    </section>

    <main class="main-content">
        <div class="content-grid">
            <div class="main-column">
                <div class="dashboard-section" id="teams-section">
                    <div class="section-header">
                        <h2 class="section-title">Registered Teams</h2>
                        <span class="team-count" id="team-count-display">(0/0)</span>
                    </div>
                    <div class="team-accordion" id="teams-list-container">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Loading teams...
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-column">
                <div class="dashboard-section" id="actions-section">
                    <div class="section-header">
                        <h2 class="section-title">Actions</h2>
                    </div>
                    <div class="tournament-actions">
                        <button class="btn btn-primary" id="edit-details-btn">
                            <i class="fas fa-edit"></i> Edit Details
                        </button>
                        <button class="btn btn-secondary" id="manage-brackets-btn">
                            <i class="fas fa-sitemap"></i> <span id="manage-brackets-text">Manage Brackets</span>
                        </button>
                        <button class="btn btn-danger" id="cancel-tournament-btn">
                            <i class="fas fa-ban"></i> Cancel Tournament
                        </button>
                        <button class="btn btn-delete" id="delete-tournament-btn">
                            <i class="fas fa-trash"></i> Delete Tournament
                        </button>
                    </div>
                </div>

                <div class="dashboard-section" id="info-section">
                    <div class="section-header">
                        <h2 class="section-title">Tournament Details</h2>
                    </div>
                    <ul class="info-list">
                        <li><span class="label">Status</span><span class="value" id="info-status">--</span></li>
                        <li><span class="label">Prize Pool</span><span class="value" id="info-prize">--</span></li>
                        <li><span class="label">Entry Fee</span><span class="value" id="info-fee">--</span></li>
                        <li><span class="label">Format</span><span class="value" id="info-format">--</span></li>
                        <li><span class="label">Tournament ID</span><span class="value" id="info-tournament-id"
                                style="font-family: monospace; font-size: 0.9rem;">--</span></li>
                    </ul>
                </div>

                <div class="dashboard-section" id="schedule-section">
                    <div class="section-header">
                        <h2 class="section-title">Schedule</h2>
                        <button class="btn btn-secondary" id="manage-schedule-btn"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-calendar-plus"></i> Manage
                        </button>
                    </div>
                    <ul class="info-list">
                        <li><span class="label">Registration Start</span><span class="value"
                                id="info-reg-start">--</span></li>
                        <li><span class="label">Registration End</span><span class="value" id="info-reg-end">--</span>
                        </li>
                        <li><span class="label">Tournament Start</span><span class="value"
                                id="info-start-date">--</span></li>
                        <li><span class="label">Tournament End</span><span class="value" id="info-end-date">--</span>
                        </li>
                    </ul>
                    <div id="custom-schedule-events" class="custom-events">
                        <!-- Custom schedule events will be loaded here -->
                    </div>
                </div>

                <!-- KP Format Section (hidden by default) -->
                <div class="dashboard-section" id="kp-format-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">KP Tournament Structure</h2>
                        <button class="btn btn-secondary" id="manage-groups-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-users"></i> Manage Groups
                        </button>
                    </div>
                    
                    <div class="kp-overview">
                        <div class="kp-stat">
                            <span class="kp-label">Groups</span>
                            <span class="kp-value" id="kp-groups-count">4</span>
                        </div>
                        <div class="kp-stat">
                            <span class="kp-label">Teams per Group</span>
                            <span class="kp-value" id="kp-group-size">25</span>
                        </div>
                        <div class="kp-stat">
                            <span class="kp-label">Qualifiers per Group</span>
                            <span class="kp-value" id="kp-qualifiers">4</span>
                        </div>
                        <div class="kp-stat">
                            <span class="kp-label">Final Teams</span>
                            <span class="kp-value" id="kp-final-teams">16</span>
                        </div>
                    </div>

                    <div class="kp-groups" id="kp-groups-container">
                        <!-- KP groups will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="edit-modal" class="modal">
        <div class="modal-content edit-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Tournament Details</h3>
                <button class="close-modal" id="close-edit-modal">&times;</button>
            </div>
            <form id="edit-tournament-form" class="edit-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-title">Tournament Title</label>
                        <input type="text" id="edit-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-game">Game</label>
                        <input type="text" id="edit-game" name="game" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-prize-pool">Prize Pool (₹)</label>
                        <input type="number" id="edit-prize-pool" name="prizePool" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-entry-fee">Entry Fee (₹)</label>
                        <input type="number" id="edit-entry-fee" name="entryFee" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-reg-start">Registration Start</label>
                        <input type="datetime-local" id="edit-reg-start" name="registrationStart" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-reg-end">Registration End</label>
                        <input type="datetime-local" id="edit-reg-end" name="registrationEnd" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-start-date">Tournament Start</label>
                        <input type="datetime-local" id="edit-start-date" name="tournamentStart" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-end-date">Tournament End</label>
                        <input type="datetime-local" id="edit-end-date" name="tournamentEnd" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-format">Tournament Format</label>
                        <select id="edit-format" name="format">
                            <option value="">Select Format</option>
                            <option value="single-elimination">Single Elimination</option>
                            <option value="double-elimination">Double Elimination</option>
                            <option value="round-robin">Round Robin</option>
                            <option value="swiss">Swiss System</option>
                            <option value="group-stage">Group Stage</option>
                            <option value="kp">KP Format (4 Qualifiers → Final)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-max-teams">Max Teams</label>
                        <input type="number" id="edit-max-teams" name="maxTeams" min="2" max="128">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" name="description" rows="4"
                        placeholder="Tournament description..."></textarea>
                </div>

                <!-- KP Format Settings (hidden by default) -->
                <div id="edit-kp-settings" style="display: none;">
                    <h4 style="color: var(--accent); margin: 1.5rem 0 1rem 0;">KP Match Schedule</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-qualifier1-date">Qualifier 1 Date & Time</label>
                            <input type="datetime-local" id="edit-qualifier1-date" name="qualifier1Date">
                        </div>
                        <div class="form-group">
                            <label for="edit-qualifier2-date">Qualifier 2 Date & Time</label>
                            <input type="datetime-local" id="edit-qualifier2-date" name="qualifier2Date">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-qualifier3-date">Qualifier 3 Date & Time</label>
                            <input type="datetime-local" id="edit-qualifier3-date" name="qualifier3Date">
                        </div>
                        <div class="form-group">
                            <label for="edit-qualifier4-date">Qualifier 4 Date & Time</label>
                            <input type="datetime-local" id="edit-qualifier4-date" name="qualifier4Date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-final-match-date">Final Match Date & Time</label>
                        <input type="datetime-local" id="edit-final-match-date" name="finalMatchDate">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="edit-poster">Tournament Poster</label>
                    <div class="poster-upload-area">
                        <input type="file" id="edit-poster" name="posterImage" accept="image/*" style="display: none;">
                        <div class="poster-preview" id="poster-preview">
                            <div class="poster-placeholder">
                                <i class="fas fa-image"></i>
                                <p>Click to upload poster</p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="upload-poster-btn">
                            <i class="fas fa-upload"></i> Choose Image
                        </button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-tournament-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="cancel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cancel Tournament</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Are you sure you want to cancel this tournament? This action cannot be undone and all registered teams
                will be notified.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary close-modal">Keep Tournament</button>
                <button class="btn btn-danger" id="confirm-cancel-btn">Yes, Cancel Tournament</button>
            </div>
        </div>
    </div>

    <div id="schedule-modal" class="modal">
        <div class="modal-content edit-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Tournament Schedule</h3>
                <button class="close-modal" id="close-schedule-modal">&times;</button>
            </div>

            <div class="schedule-management">
                <div class="section-header" style="margin-bottom: 1rem;">
                    <h4 style="font-size: 1.1rem; margin: 0;">Custom Events</h4>
                    <button class="btn btn-primary btn-small" id="add-event-btn">
                        <i class="fas fa-plus"></i> Add Event
                    </button>
                </div>

                <div id="schedule-events-list" class="schedule-events-list">
                    <!-- Schedule events will be loaded here -->
                </div>

                <div id="add-event-form" class="add-event-form" style="display: none;">
                    <form id="event-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="event-title">Event Title</label>
                                <input type="text" id="event-title" name="title" required
                                    placeholder="e.g., Registration Opens">
                            </div>
                            <div class="form-group">
                                <label for="event-type">Event Type</label>
                                <select id="event-type" name="type">
                                    <option value="registration">Registration</option>
                                    <option value="match">Match</option>
                                    <option value="announcement">Announcement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="event-date">Event Date</label>
                                <input type="date" id="event-date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="event-time">Event Time</label>
                                <input type="time" id="event-time" name="time" required>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="event-description">Description (Optional)</label>
                            <textarea id="event-description" name="description" rows="2"
                                placeholder="Additional details about this event..."></textarea>
                        </div>

                        <div class="modal-buttons">
                            <button type="button" class="btn btn-secondary" id="cancel-event-btn">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Event
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to redirect to auth with return URL
        function redirectToAuth(tab = 'register') {
          const currentUrl = window.location.href;
          const returnUrl = encodeURIComponent(currentUrl);
          window.location.href = `auth.html?tab=${tab}&returnUrl=${returnUrl}`;
        }

        // Auto-detect API URL based on environment
        const isLocal = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' || 
                       window.location.protocol === 'file:';
        
        const API_BASE_URL = isLocal ? 'http://localhost:8000' : 'https://t2-237c.onrender.com';
        let currentTournament = null;

        // Function to get proper image URL with CORS support
        function getImageUrl(imagePath) {
            if (!imagePath) return null;
            if (imagePath.startsWith('http')) return imagePath;
            const filename = imagePath.split('/').pop();
            return `${API_BASE_URL}/api/static/images/${filename}`;
        }

        // --- AUTHENTICATION & USER INFO ---
        function getSessionData() {
            const session = localStorage.getItem('earena_session') || sessionStorage.getItem('earena_session');
            try {
                return JSON.parse(session);
            } catch (error) {
                return null;
            }
        }

        function logout() {
            localStorage.removeItem('earena_session');
            sessionStorage.removeItem('earena_session');
            redirectToAuth();
        }

        // --- TOURNAMENT ACTIONS ---
        function editTournamentDetails() {
            if (currentTournament) {
                populateEditForm();
                document.getElementById('edit-modal').classList.add('active');
            } else {
                alert('Tournament data not loaded yet. Please wait and try again.');
            }
        }

        function populateEditForm() {
            if (!currentTournament) return;

            document.getElementById('edit-title').value = currentTournament.title || '';
            document.getElementById('edit-game').value = currentTournament.game || '';
            document.getElementById('edit-prize-pool').value = currentTournament.prizePool || '';
            document.getElementById('edit-entry-fee').value = currentTournament.entryFee || '';
            document.getElementById('edit-max-teams').value = currentTournament.maxTeams || '';
            document.getElementById('edit-description').value = currentTournament.description || '';

            // Format dates
            const toLocalISOString = date => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

            if (currentTournament.registrationStart) document.getElementById('edit-reg-start').value = toLocalISOString(new Date(currentTournament.registrationStart));
            if (currentTournament.registrationEnd) document.getElementById('edit-reg-end').value = toLocalISOString(new Date(currentTournament.registrationEnd));
            if (currentTournament.tournamentStart) document.getElementById('edit-start-date').value = toLocalISOString(new Date(currentTournament.tournamentStart));
            if (currentTournament.tournamentEnd) document.getElementById('edit-end-date').value = toLocalISOString(new Date(currentTournament.tournamentEnd));

            const format = currentTournament.format || currentTournament.tournamentFormat || currentTournament.gameFormat || '';
            document.getElementById('edit-format').value = format;
            
            // Handle KP format settings
            const kpSettings = document.getElementById('edit-kp-settings');
            if (format === 'kp' && currentTournament.kpSettings) {
                kpSettings.style.display = 'block';
                
                // Populate KP match schedule if available
                const schedule = currentTournament.kpSettings.matchSchedule || [];
                schedule.forEach(match => {
                    const matchDate = new Date(match.date);
                    const dateString = toLocalISOString(matchDate);
                    
                    switch(match.match) {
                        case 'Qualifier 1':
                            document.getElementById('edit-qualifier1-date').value = dateString;
                            break;
                        case 'Qualifier 2':
                            document.getElementById('edit-qualifier2-date').value = dateString;
                            break;
                        case 'Qualifier 3':
                            document.getElementById('edit-qualifier3-date').value = dateString;
                            break;
                        case 'Qualifier 4':
                            document.getElementById('edit-qualifier4-date').value = dateString;
                            break;
                        case 'Final Match':
                            document.getElementById('edit-final-match-date').value = dateString;
                            break;
                    }
                });
            } else {
                kpSettings.style.display = 'none';
            }

            const posterPreview = document.getElementById('poster-preview');
            const posterPath = currentTournament.posterImage || currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl;
            const placeholder = `<div class="poster-placeholder"><i class="fas fa-image"></i><p>Click to upload poster</p></div>`;

            if (posterPath) {
                const imageUrl = getImageUrl(posterPath);
                posterPreview.innerHTML = imageUrl ? `<img src="${imageUrl}" alt="Tournament Poster" onerror="this.parentElement.innerHTML='${placeholder}'">` : placeholder;
            } else {
                posterPreview.innerHTML = placeholder;
            }
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function saveTournamentChanges(formData, slug, token) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${slug}`, {
                    method: "PATCH",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || errorData.error || "Unknown error.");
                }

                alert("Tournament updated successfully!");
                hideEditModal();
                loadTournamentDetails(slug, token);
            } catch (error) {
                console.error("Update tournament error:", error);
                alert(`Failed to update tournament: ${error.message}`);
            }
        }

        function manageBrackets() {
            if (currentTournament) {
                if (currentTournament.format === 'kp') {
                    // For KP tournaments, show groups management
                    alert('KP Tournament Groups Management - Coming Soon!');
                    // TODO: Implement KP groups management
                } else {
                    // For other tournaments, show brackets
                    window.location.href = `tournament-brackets.html?slug=${currentTournament.slug}`;
                }
            } else {
                alert('Tournament data not loaded yet.');
            }
        }

        // Handle KP format tournament display
        function handleKPFormat(tournament) {
            const kpSection = document.getElementById('kp-format-section');
            const manageBracketsText = document.getElementById('manage-brackets-text');
            
            if (tournament.format === 'kp') {
                // Show KP section
                kpSection.style.display = 'block';
                
                // Update button text
                manageBracketsText.textContent = 'Manage Groups';
                
                // Load KP settings
                if (tournament.kpSettings) {
                    document.getElementById('kp-groups-count').textContent = tournament.kpSettings.numberOfGroups || 4;
                    document.getElementById('kp-group-size').textContent = tournament.kpSettings.groupSize || 25;
                    document.getElementById('kp-qualifiers').textContent = tournament.kpSettings.qualifiersPerGroup || 4;
                    document.getElementById('kp-final-teams').textContent = (tournament.kpSettings.numberOfGroups || 4) * (tournament.kpSettings.qualifiersPerGroup || 4);
                }
                
                // Load KP groups
                loadKPGroups(tournament);
            } else {
                // Hide KP section for non-KP tournaments
                kpSection.style.display = 'none';
                manageBracketsText.textContent = 'Manage Brackets';
            }
        }

        // Load KP groups display
        function loadKPGroups(tournament) {
            const container = document.getElementById('kp-groups-container');
            const numberOfGroups = tournament.kpSettings?.numberOfGroups || 4;
            const groupSize = tournament.kpSettings?.groupSize || 25;
            const teams = tournament.participants || [];
            
            // Divide teams into groups
            const groups = [];
            for (let i = 0; i < numberOfGroups; i++) {
                const groupTeams = teams.slice(i * groupSize, (i + 1) * groupSize);
                groups.push({
                    id: i + 1,
                    name: `Group ${i + 1}`,
                    teams: groupTeams,
                    status: groupTeams.length > 0 ? 'pending' : 'empty',
                    qualified: [] // TODO: Load qualified teams from backend
                });
            }
            
            container.innerHTML = groups.map(group => `
                <div class="kp-group">
                    <div class="kp-group-header">
                        <span class="kp-group-title">${group.name}</span>
                        <span class="kp-group-status ${group.status}">${group.status}</span>
                    </div>
                    <div class="kp-group-teams">
                        ${group.teams.length}/${groupSize} teams registered
                    </div>
                    ${group.qualified.length > 0 ? `
                        <div class="kp-group-qualified">
                            <strong>Qualified:</strong><br>
                            ${group.qualified.map(team => `<span class="kp-qualified-team">${team.name}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function showCancelModal() {
            document.getElementById('cancel-modal').classList.add('active');
        }

        function hideCancelModal() {
            document.getElementById('cancel-modal').classList.remove('active');
        }

        async function cancelTournament() {
            if (!currentTournament) { alert('Tournament data not loaded.'); return; }

            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) { alert('Authentication required.'); return; }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament.slug}/cancel`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${sessionData.token}`, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || errorData.error || 'Failed to cancel.');
                }

                alert('Tournament has been cancelled successfully.');
                hideCancelModal();
                window.location.reload();
            } catch (error) {
                alert('Failed to cancel tournament: ' + error.message);
            }
        }

        async function deleteTournament() {
            if (!currentTournament) { alert('Tournament data not loaded.'); return; }

            if (!confirm('Are you sure you want to DELETE this tournament? This is permanent!')) return;

            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) { alert('Authentication required.'); return; }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament.slug}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionData.token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || errorData.error || 'Failed to delete.');
                }

                alert('Tournament has been deleted successfully.');
                window.location.href = 'admin-dashboard.html';
            } catch (error) {
                alert('Failed to delete tournament: ' + error.message);
            }
        }

        // --- DATA LOADING ---
        async function loadTournamentDetails(tournamentSlug, token) {
            try {
                console.log('Loading tournament details for slug:', tournamentSlug);
                const response = await fetch(`${API_BASE_URL}/api/tournaments/slug/${tournamentSlug}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('Failed to fetch tournament:', response.status, response.statusText);
                    throw new Error(response.status === 404 ? 'Tournament not found.' : 'Failed to fetch data.');
                }

                const responseData = await response.json();
                console.log('Tournament data received:', responseData);
                const t = responseData.data;
                currentTournament = t;

                // Hero and Titles
                document.getElementById('tournament-title').textContent = t.title;
                document.getElementById('tournament-game').textContent = t.game;

                const posterPath = t.posterImage || t.poster || t.thumbnailUrl || t.imageUrl;
                const heroElement = document.getElementById('tournament-hero');
                if (posterPath) {
                    const imageUrl = getImageUrl(posterPath);
                    heroElement.style.backgroundImage = `url(${imageUrl})`;
                }

                // Details Card
                document.getElementById('info-status').textContent = t.status.charAt(0).toUpperCase() + t.status.slice(1);
                document.getElementById('info-prize').textContent = `₹${(t.prizePool || 0).toLocaleString()}`;
                document.getElementById('info-fee').textContent = `₹${(t.entryFee || 0).toLocaleString()} per team`;
                // Display format with KP details if applicable
                let formatText = t.format || t.tournamentFormat || 'Not specified';
                if (t.format === 'kp' && t.kpSettings) {
                    formatText = `KP Format (${t.kpSettings.numberOfGroups} groups → ${t.kpSettings.qualifiersPerGroup} each → Final)`;
                }
                document.getElementById('info-format').textContent = formatText;
                document.getElementById('info-tournament-id').textContent = t._id;

                // Schedule Card
                const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';
                document.getElementById('info-reg-start').textContent = formatDate(t.registrationStart);
                document.getElementById('info-reg-end').textContent = formatDate(t.registrationEnd);
                document.getElementById('info-start-date').textContent = formatDate(t.tournamentStart);
                document.getElementById('info-end-date').textContent = formatDate(t.tournamentEnd);

                // Teams Section
                document.getElementById('team-count-display').textContent = `(${(t.participants?.length || 0)}/${t.maxTeams})`;

                // Load custom schedule events
                loadCustomScheduleEvents();

                // Handle KP format tournaments
                handleKPFormat(t);

                const teamsContainer = document.getElementById('teams-list-container');
                const teams = t.participants || [];

                if (teams.length === 0) {
                    teamsContainer.innerHTML = `<div class="empty-state">No teams have registered yet.</div>`;
                    return;
                }

                teamsContainer.innerHTML = teams.map(team => `
<div class="team-item" data-team-id="${team._id}">
<div class="team-header">
<span class="team-name">${team.name || 'Unnamed Team'}</span>
<div style="display: flex; align-items: center; gap: 1rem;">
<span style="color: var(--muted); font-size: 0.9rem;">${team.players?.length || 0} players</span>
<i class="fas fa-chevron-down"></i>
</div>
</div>
<div class="team-players">
<div class="players-list">
${(team.players || []).map(player => `
<div class="player-item">
<div>
<span class="player-name">${player.name || 'Unknown'} ${player.isCaptain ? '(C)' : ''}</span>
<div style="font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem;">
In-Game ID: ${player.inGameId || 'N/A'}
</div>
</div>
<span class="player-id">${player.email || 'No email'}</span>
</div>
`).join('')}
</div>
</div>
</div>
`).join('');

            } catch (error) {
                console.error('Error loading tournament details:', error);
                document.getElementById('tournament-title').textContent = 'Error Loading Tournament';
                document.getElementById('tournament-game').textContent = error.message;
                document.getElementById('teams-list-container').innerHTML = `<div class="empty-state">Could not load tournament data.</div>`;
            }
        }

        // --- SCHEDULE MANAGEMENT ---
        let currentScheduleEvents = [];
        let editingEventIndex = -1;

        function showScheduleModal() {
            loadScheduleEvents();
            document.getElementById('schedule-modal').classList.add('active');
        }

        function hideScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('active');
            hideEventForm();
        }

        function showEventForm(eventData = null) {
            const form = document.getElementById('add-event-form');
            const formTitle = form.querySelector('.modal-title');

            if (eventData) {
                // Editing existing event
                editingEventIndex = currentScheduleEvents.findIndex(e => e.id === eventData.id);
                document.getElementById('event-title').value = eventData.title || '';
                document.getElementById('event-type').value = eventData.type || 'other';
                document.getElementById('event-date').value = eventData.date || '';
                document.getElementById('event-time').value = eventData.time || '';
                document.getElementById('event-description').value = eventData.description || '';
            } else {
                // Adding new event
                editingEventIndex = -1;
                document.getElementById('event-form').reset();
            }

            form.style.display = 'block';
        }

        function hideEventForm() {
            document.getElementById('add-event-form').style.display = 'none';
            document.getElementById('event-form').reset();
            editingEventIndex = -1;
        }

        async function saveScheduleEvent(eventData) {
            if (!currentTournament) return;

            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                alert('Authentication required.');
                return;
            }

            try {
                const scheduleEvents = currentTournament.scheduleEvents || [];

                if (editingEventIndex >= 0) {
                    // Update existing event
                    scheduleEvents[editingEventIndex] = { ...scheduleEvents[editingEventIndex], ...eventData };
                } else {
                    // Add new event
                    eventData.id = Date.now().toString();
                    scheduleEvents.push(eventData);
                }

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament.slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${sessionData.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ scheduleEvents })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || errorData.error || 'Failed to save event.');
                }

                currentTournament.scheduleEvents = scheduleEvents;
                loadScheduleEvents();
                loadCustomScheduleEvents(); // Update the sidebar display
                hideEventForm();

                alert('Schedule event saved successfully!');
            } catch (error) {
                console.error('Save schedule event error:', error);
                alert(`Failed to save event: ${error.message}`);
            }
        }

        async function deleteScheduleEvent(eventId) {
            if (!currentTournament || !confirm('Are you sure you want to delete this event?')) return;

            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                alert('Authentication required.');
                return;
            }

            try {
                const scheduleEvents = (currentTournament.scheduleEvents || []).filter(e => e.id !== eventId);

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament.slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${sessionData.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ scheduleEvents })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || errorData.error || 'Failed to delete event.');
                }

                currentTournament.scheduleEvents = scheduleEvents;
                loadScheduleEvents();
                loadCustomScheduleEvents(); // Update the sidebar display

                alert('Event deleted successfully!');
            } catch (error) {
                console.error('Delete schedule event error:', error);
                alert(`Failed to delete event: ${error.message}`);
            }
        }

        function loadScheduleEvents() {
            const container = document.getElementById('schedule-events-list');
            const events = currentTournament?.scheduleEvents || [];
            currentScheduleEvents = events;

            if (events.length === 0) {
                container.innerHTML = '<div class="empty-schedule">No custom events added yet.</div>';
                return;
            }

            // Sort events by date and time
            const sortedEvents = [...events].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateA - dateB;
            });

            container.innerHTML = sortedEvents.map(event => `
        <div class="custom-event-item">
            <div class="event-info">
                <div class="event-title">${event.title}</div>
                <div class="event-datetime">
                    ${new Date(`${event.date} ${event.time}`).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            })} at ${event.time}
                    ${event.type ? `• ${event.type.charAt(0).toUpperCase() + event.type.slice(1)}` : ''}
                </div>
                ${event.description ? `<div style="font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem;">${event.description}</div>` : ''}
            </div>
            <div class="event-actions">
                <button class="btn btn-edit btn-small" onclick="showEventForm(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-remove btn-small" onclick="deleteScheduleEvent('${event.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
        }

        function loadCustomScheduleEvents() {
            const container = document.getElementById('custom-schedule-events');
            const events = currentTournament?.scheduleEvents || [];

            if (events.length === 0) {
                container.innerHTML = '';
                return;
            }

            // Sort events by date and time
            const sortedEvents = [...events].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateA - dateB;
            });

            // Show only next 3 upcoming events in sidebar
            const upcomingEvents = sortedEvents.slice(0, 3);

            container.innerHTML = upcomingEvents.map(event => `
        <div class="info-list" style="margin-top: 0.5rem;">
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                <span class="label">${event.title}</span>
                <span class="value" style="font-size: 0.85rem;">
                    ${new Date(`${event.date} ${event.time}`).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short'
            })}
                </span>
            </li>
        </div>
    `).join('');
        }

        // --- PAGE INITIALIZATION AND EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                redirectToAuth();
                return;
            }

            if (sessionData.user) {
                document.getElementById('admin-username').textContent = sessionData.user.username;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const tournamentSlug = urlParams.get('slug');

            if (tournamentSlug) {
                loadTournamentDetails(tournamentSlug, sessionData.token);
            } else {
                document.getElementById('tournament-title').textContent = 'No Tournament Specified';
                document.getElementById('tournament-game').textContent = 'Please provide a slug in the URL.';
            }

            // --- Main Button Event Listeners ---
            document.getElementById('edit-details-btn').addEventListener('click', editTournamentDetails);
            document.getElementById('manage-brackets-btn').addEventListener('click', manageBrackets);
            document.getElementById('cancel-tournament-btn').addEventListener('click', showCancelModal);
            document.getElementById('delete-tournament-btn').addEventListener('click', deleteTournament);
            document.getElementById('confirm-cancel-btn').addEventListener('click', cancelTournament);
            document.getElementById('manage-schedule-btn').addEventListener('click', showScheduleModal);

            // --- Modal Close Listeners ---
            document.querySelectorAll('.close-modal, .modal').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target === el) {
                        el.closest('.modal')?.classList.remove('active');
                    }
                });
            });

            // --- Edit Form Poster Upload ---
            const posterInput = document.getElementById('edit-poster');
            document.getElementById('upload-poster-btn').addEventListener('click', () => posterInput.click());
            document.getElementById('poster-preview').addEventListener('click', () => posterInput.click());

            posterInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/') || file.size > 5 * 1024 * 1024) {
                        alert('Please select an image file under 5MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('poster-preview').innerHTML =
                            `<img src="${e.target.result}" alt="Poster Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Format Change Handler ---
            document.getElementById('edit-format').addEventListener('change', (e) => {
                const kpSettings = document.getElementById('edit-kp-settings');
                if (e.target.value === 'kp') {
                    kpSettings.style.display = 'block';
                } else {
                    kpSettings.style.display = 'none';
                }
            });

            // --- Form Submission ---
            document.getElementById('edit-tournament-form').addEventListener('submit', (e) => {
                e.preventDefault();

                const authToken = getSessionData()?.token;
                if (!tournamentSlug || !authToken) {
                    alert("Could not save. Missing tournament slug or auth token.");
                    return;
                }

                saveTournamentChanges(new FormData(e.target), tournamentSlug, authToken);
            });

            // --- Schedule Management Event Listeners ---
            document.getElementById('add-event-btn').addEventListener('click', () => showEventForm());
            document.getElementById('cancel-event-btn').addEventListener('click', hideEventForm);
            document.getElementById('close-schedule-modal').addEventListener('click', hideScheduleModal);

            document.getElementById('event-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const eventData = {
                    title: formData.get('title'),
                    type: formData.get('type'),
                    date: formData.get('date'),
                    time: formData.get('time'),
                    description: formData.get('description')
                };
                saveScheduleEvent(eventData);
            });

            // --- Team Accordion (Event Delegation) ---
            document.getElementById('teams-list-container').addEventListener('click', (event) => {
                const header = event.target.closest('.team-header');
                if (header) header.parentElement.classList.toggle('open');
            });
        });
    </script>
</body>

</html>