<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tournament | EArena Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* All CSS styles remain the same as before */
        :root {
            --bg: #0f0f10; --panel: #1f1f20; --muted: #9aa0a6; --copy: #e6e6e6; --accent: #FFD700; --accent-2: #e0ac10; --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, var(--bg), #070707 140%); color: var(--copy); line-height: 1.5; min-height: 100vh; }
        .site-header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .header-left { display: flex; align-items: center; gap: 24px; }
        .back-link { color: var(--muted); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: color 0.2s ease; }
        .back-link:hover { color: var(--accent); }
        .brand { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: var(--copy); font-size: 22px; text-decoration: none; }
        .brand .accent { color: var(--accent); }
        .user-menu { display: flex; align-items: center; gap: 1rem; }
        .user-info { display: flex; align-items: center; gap: 0.5rem; color: var(--copy); font-weight: 500; }
        .admin-badge { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .logout-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--copy); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; font-size: 14px; }
        .logout-btn:hover { background: rgba(255, 0, 0, 0.1); border-color: rgba(255, 0, 0, 0.3); color: #ff6b6b; }
        .main-content { margin-top: 64px; padding: 32px 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .breadcrumb { margin-bottom: 16px; color: var(--muted); font-size: 14px; }
        .breadcrumb a { color: var(--accent); text-decoration: none; }
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 28px; font-weight: 700; }
        .page-subtitle { color: var(--muted); }
        .dashboard-section { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius); padding: 2rem; margin-bottom: 2rem; }
        .section-header { margin-bottom: 1.5rem; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--copy); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #000; }
        .btn-danger { background: #ef4444; color: white; }
        .details-grid { display: grid; grid-template-columns: 1fr 380px; gap: 2rem; align-items: start; }
        .tournament-info-card ul { list-style: none; padding: 0; }
        .tournament-info-card li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tournament-info-card li:last-child { border-bottom: none; }
        .tournament-info-card .label { color: var(--muted); font-weight: 500; }
        .tournament-info-card .value { font-weight: 600; color: var(--copy); }
        .tournament-actions { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .team-count { color: var(--muted); margin-left: 1rem; font-size: 1rem; }
        .team-accordion { display: flex; flex-direction: column; gap: 1rem; }
        .team-item { background: rgba(0, 0, 0, 0.2); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .team-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; }
        .team-name { font-size: 1.1rem; font-weight: 600; }
        .team-header i { transition: transform 0.3s ease; }
        .team-item.open .team-header i { transform: rotate(180deg); }
        .team-players { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .team-item.open .team-players { max-height: 500px; }
        .players-list { padding: 0 1rem 1rem; }
        .player-item { display: flex; justify-content: space-between; padding: 0.75rem; border-radius: 6px; }
        .player-item:nth-child(odd) { background: rgba(0, 0, 0, 0.2); }
        .player-name { font-weight: 500; }
        .player-id { color: var(--muted); font-family: monospace; }
        .loading-state, .empty-state { padding: 2rem; text-align: center; color: var(--muted); }
        @media (max-width: 1024px) { .details-grid { grid-template-columns: 1fr; } .main-content { padding: 24px 16px; } }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-left">
            <a href="admin-dashboard.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                <span>Dashboard</span>
            </a>
            <a href="index.html" class="brand">
                <span class="accent">E</span>Arena
            </a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <span id="admin-username">Admin</span>
                <span class="admin-badge">Admin</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="breadcrumb">
            <a href="admin-dashboard.html">Dashboard</a> &gt; <span id="breadcrumb-tournament-name">Tournament</span>
        </div>

        <div class="page-header">
            <h1 class="page-title" id="tournament-title">Loading Tournament...</h1>
            <p class="page-subtitle" id="tournament-game">Manage teams, brackets, and settings for this event.</p>
        </div>

        <div class="details-grid">
            <div class="dashboard-section" id="teams-section">
                <div class="section-header">
                    <h2 class="section-title">
                        Registered Teams
                        <span class="team-count" id="team-count-display">(0/0)</span>
                    </h2>
                </div>
                <div class="team-accordion" id="teams-list-container">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i> Loading teams...
                    </div>
                </div>
            </div>

            <div class="dashboard-section" id="info-section">
                <div class="tournament-info-card">
                    <div class="section-header">
                        <h2 class="section-title">Tournament Info</h2>
                    </div>
                    <ul>
                        <li><span class="label">Status</span><span class="value" id="info-status">--</span></li>
                        <li><span class="label">Prize Pool</span><span class="value" id="info-prize">--</span></li>
                        <li><span class="label">Entry Fee</span><span class="value" id="info-fee">--</span></li>
                        <li><span class="label">Start Date</span><span class="value" id="info-start-date">--</span></li>
                        <li><span class="label">End Date</span><span class="value" id="info-end-date">--</span></li>
                        <li><span class="label">Format</span><span class="value" id="info-format">--</span></li>
                    </ul>
                </div>
                <div class="tournament-actions">
                    <button class="btn btn-primary"><i class="fas fa-edit"></i> Edit Details</button>
                    <button class="btn btn-secondary"><i class="fas fa-sitemap"></i> Manage Brackets</button>
                    <button class="btn btn-danger"><i class="fas fa-ban"></i> Cancel Tournament</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'https://tournament-hosting-backend.onrender.com';

        // --- AUTHENTICATION & USER INFO ---
        function getSessionData() {
            const session = localStorage.getItem('earena_session') || sessionStorage.getItem('earena_session');
            try {
                return JSON.parse(session);
            } catch (error) {
                return null;
            }
        }
        
        function logout() {
            localStorage.removeItem('earena_session');
            sessionStorage.removeItem('earena_session');
            window.location.href = 'auth.html';
        }

        // --- DATA LOADING ---
        // === MODIFIED: Now takes a tournament SLUG and auth token ===
        async function loadTournamentDetails(tournamentSlug, token) {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            try {
                // === MODIFIED: Fetching from a new backend endpoint for slugs ===
                const tournamentResponse = await fetch(`${API_BASE_URL}/api/tournaments/slug/${tournamentSlug}`, { headers });
                
                if (!tournamentResponse.ok) {
                     if (tournamentResponse.status === 404) {
                        throw new Error('Tournament not found. Please check the slug.');
                    }
                    throw new Error('Failed to fetch tournament data.');
                }
                
                const t = (await tournamentResponse.json()).data;

                // Populate UI with tournament details (this logic remains the same)
                document.getElementById('tournament-title').textContent = t.title;
                document.getElementById('breadcrumb-tournament-name').textContent = t.title;
                document.getElementById('tournament-game').textContent = t.game;
                document.getElementById('info-status').textContent = t.status.charAt(0).toUpperCase() + t.status.slice(1);
                document.getElementById('info-prize').textContent = `₹${(t.prizePool || 0).toLocaleString()}`;
                document.getElementById('info-fee').textContent = `₹${(t.entryFee || 0).toLocaleString()} per team`;
                document.getElementById('info-start-date').textContent = new Date(t.tournamentStart).toLocaleDateString();
                document.getElementById('info-end-date').textContent = new Date(t.tournamentEnd).toLocaleDateString();
                document.getElementById('info-format').textContent = t.format || 'Not specified';
                document.getElementById('team-count-display').textContent = `(${(t.participants?.length || 0)}/${t.maxTeams})`;

                const teamsContainer = document.getElementById('teams-list-container');
                const teams = t.participants || [];

                if (teams.length === 0) {
                    teamsContainer.innerHTML = `<div class="empty-state">No teams have registered for this tournament yet.</div>`;
                    return;
                }

                teamsContainer.innerHTML = teams.map(team => `
                    <div class="team-item" data-team-id="${team._id}">
                        <div class="team-header">
                            <span class="team-name">${team.name || 'Unnamed Team'}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="team-players">
                            <div class="players-list">
                                ${team.players.map(player => `
                                    <div class="player-item">
                                        <span class="player-name">${player.username || 'Unknown Player'}</span>
                                        <span class="player-id">${player._id}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load tournament details:', error);
                document.getElementById('tournament-title').textContent = 'Error';
                document.getElementById('tournament-game').textContent = error.message;
            }
        }

        // --- PAGE INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const sessionData = getSessionData();
            if (sessionData && sessionData.user) {
                 document.getElementById('admin-username').textContent = sessionData.user.username;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            // === MODIFIED: Looking for 'slug' instead of 'id' ===
            const tournamentSlug = urlParams.get('slug'); 
            const authToken = sessionData ? sessionData.token : null;

            if (tournamentSlug) {
                loadTournamentDetails(tournamentSlug, authToken);
            } else {
                document.getElementById('tournament-title').textContent = 'No Tournament Specified';
                document.getElementById('tournament-game').textContent = 'Please provide a tournament slug in the URL (e.g., td.html?slug=your-tournament-name).';
            }
        });

        // --- EVENT LISTENERS for accordion ---
        document.getElementById('teams-list-container').addEventListener('click', function(event) {
            const header = event.target.closest('.team-header');
            if (header) {
                const item = header.parentElement;
                item.classList.toggle('open');
            }
        });

    </script>
</body>

</html>