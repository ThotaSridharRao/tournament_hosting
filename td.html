<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Tournament | EArena Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --bg: #0f0f10; --panel: #1f1f20; --muted: #9aa0a6; --copy: #e6e6e6; --accent: #FFD700; --accent-2: #e0ac10; --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, var(--bg), #070707 140%); color: var(--copy); line-height: 1.5; min-height: 100vh; }
        .site-header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .header-left { display: flex; align-items: center; gap: 24px; }
        .back-link { color: var(--muted); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: color 0.2s ease; }
        .back-link:hover { color: var(--accent); }
        .user-menu { display: flex; align-items: center; gap: 1rem; }
        .user-info { display: flex; align-items: center; gap: 0.5rem; color: var(--copy); font-weight: 500; }
        .logout-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--copy); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; font-size: 14px; }
        .logout-btn:hover { background: rgba(255, 0, 0, 0.1); border-color: rgba(255, 0, 0, 0.3); color: #ff6b6b; }
        .main-content { margin-top: 64px; padding: 32px 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .breadcrumb { margin-bottom: 16px; color: var(--muted); font-size: 14px; }
        .breadcrumb a { color: var(--accent); text-decoration: none; }
        .page-header { margin-bottom: 32px; display: flex; gap: 24px; align-items: flex-start; }
        .page-content { flex: 1; }
        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .page-subtitle { color: var(--muted); }
        .tournament-poster { width: 200px; height: 280px; border-radius: var(--radius); overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; }
        .tournament-poster img { width: 100%; height: 100%; object-fit: cover; }
        .poster-placeholder { color: var(--muted); text-align: center; font-size: 14px; }
        .dashboard-section { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius); padding: 2rem; margin-bottom: 2rem; }
        .section-header { margin-bottom: 1.5rem; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--copy); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; text-decoration: none; display: inline-block; text-align: center; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #000; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--accent-2), var(--accent)); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--copy); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .details-grid { display: grid; grid-template-columns: 1fr 380px; gap: 2rem; align-items: start; }
        .tournament-info-card ul { list-style: none; padding: 0; }
        .tournament-info-card li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tournament-info-card li:last-child { border-bottom: none; }
        .tournament-info-card .label { color: var(--muted); font-weight: 500; }
        .tournament-info-card .value { font-weight: 600; color: var(--copy); }
        .tournament-actions { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .team-count { color: var(--muted); margin-left: 1rem; font-size: 1rem; }
        .team-accordion { display: flex; flex-direction: column; gap: 1rem; }
        .team-item { background: rgba(0, 0, 0, 0.2); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .team-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; }
        .team-name { font-size: 1.1rem; font-weight: 600; }
        .team-header i { transition: transform 0.3s ease; }
        .team-item.open .team-header i { transform: rotate(180deg); }
        .team-players { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .team-item.open .team-players { max-height: 500px; }
        .players-list { padding: 0 1rem 1rem; }
        .player-item { display: flex; justify-content: space-between; padding: 0.75rem; border-radius: 6px; }
        .player-item:nth-child(odd) { background: rgba(0, 0, 0, 0.2); }
        .player-name { font-weight: 500; }
        .player-id { color: var(--muted); font-family: monospace; }
        .loading-state, .empty-state { padding: 2rem; text-align: center; color: var(--muted); }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); border-radius: var(--radius); padding: 2rem; max-width: 500px; width: 90%; border: 1px solid rgba(255, 255, 255, 0.1); max-height: 90vh; overflow-y: auto; }
        .edit-modal-content { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .close-modal { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
        .close-modal:hover { color: var(--copy); }
        .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .modal-buttons .btn { flex: 1; }

        /* Form Styles */
        .edit-form { display: flex; flex-direction: column; gap: 1.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width, .full-width { grid-column: span 2; }
        .form-group label { font-weight: 600; color: var(--copy); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 6px; 
            padding: 0.75rem; 
            color: var(--copy); 
            font-family: inherit; 
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: var(--accent); 
            background: rgba(255, 255, 255, 0.15); 
        }
        .form-group textarea { resize: vertical; min-height: 100px; }

        /* Poster Upload Styles */
        .poster-upload-area { display: flex; flex-direction: column; gap: 1rem; }
        .poster-preview { 
            width: 200px; 
            height: 280px; 
            border: 2px dashed rgba(255, 255, 255, 0.3); 
            border-radius: var(--radius); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: border-color 0.2s ease;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }
        .poster-preview:hover { border-color: var(--accent); }
        .poster-preview img { width: 100%; height: 100%; object-fit: cover; }
        .poster-placeholder { text-align: center; color: var(--muted); }
        .poster-placeholder i { font-size: 2rem; margin-bottom: 0.5rem; }
        .poster-placeholder p { margin: 0; font-size: 0.9rem; }
        
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; }
            .form-group.full-width, .full-width { grid-column: span 1; }
            .edit-modal-content { max-width: 95%; padding: 1.5rem; }
            .poster-preview { width: 150px; height: 210px; }
        }
        
        @media (max-width: 1024px) { 
            .details-grid { grid-template-columns: 1fr; } 
            .main-content { padding: 24px 16px; } 
            .page-header { flex-direction: column; align-items: flex-start; }
            .tournament-poster { width: 150px; height: 210px; }
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-left">
            <a href="admin-dashboard.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <span id="admin-username">Admin</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="breadcrumb">
            <a href="admin-dashboard.html">Dashboard</a> &gt; <span id="breadcrumb-tournament-name">Tournament</span>
        </div>

        <div class="page-header">
            <div class="page-content">
                <h1 class="page-title" id="tournament-title">Loading Tournament...</h1>
                <p class="page-subtitle" id="tournament-game">Manage teams, brackets, and settings for this event.</p>
            </div>
            <div class="tournament-poster" id="tournament-poster">
                <div class="poster-placeholder">
                    <i class="fas fa-image"></i><br>
                    No poster available
                </div>
            </div>
        </div>

        <div class="details-grid">
            <div class="dashboard-section" id="teams-section">
                <div class="section-header">
                    <h2 class="section-title">
                        Registered Teams
                        <span class="team-count" id="team-count-display">(0/0)</span>
                    </h2>
                </div>
                <div class="team-accordion" id="teams-list-container">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i> Loading teams...
                    </div>
                </div>
            </div>

            <div class="dashboard-section" id="info-section">
                <div class="tournament-info-card">
                    <div class="section-header">
                        <h2 class="section-title">Tournament Info</h2>
                    </div>
                    <ul>
                        <li><span class="label">Status</span><span class="value" id="info-status">--</span></li>
                        <li><span class="label">Prize Pool</span><span class="value" id="info-prize">--</span></li>
                        <li><span class="label">Entry Fee</span><span class="value" id="info-fee">--</span></li>
                        <li><span class="label">Start Date</span><span class="value" id="info-start-date">--</span></li>
                        <li><span class="label">End Date</span><span class="value" id="info-end-date">--</span></li>
                        <li><span class="label">Format</span><span class="value" id="info-format">--</span></li>
                        <li><span class="label">Tournament ID</span><span class="value" id="info-tournament-id">--</span></li>
                    </ul>
                </div>
                <div class="tournament-actions">
                    <button class="btn btn-primary" id="edit-details-btn">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                    <button class="btn btn-secondary" id="manage-brackets-btn">
                        <i class="fas fa-sitemap"></i> Manage Brackets
                    </button>
                    <button class="btn btn-danger" id="cancel-tournament-btn">
                        <i class="fas fa-ban"></i> Cancel Tournament
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Tournament Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content edit-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Tournament Details</h3>
                <button class="close-modal" id="close-edit-modal">&times;</button>
            </div>
            <form id="edit-tournament-form" class="edit-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-title">Tournament Title</label>
                        <input type="text" id="edit-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-game">Game</label>
                        <input type="text" id="edit-game" name="game" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-prize-pool">Prize Pool (₹)</label>
                        <input type="number" id="edit-prize-pool" name="prizePool" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-entry-fee">Entry Fee (₹)</label>
                        <input type="number" id="edit-entry-fee" name="entryFee" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-start-date">Start Date</label>
                        <input type="datetime-local" id="edit-start-date" name="tournamentStart" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-end-date">End Date</label>
                        <input type="datetime-local" id="edit-end-date" name="tournamentEnd" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-format">Tournament Format</label>
                        <select id="edit-format" name="format">
                            <option value="">Select Format</option>
                            <option value="single-elimination">Single Elimination</option>
                            <option value="double-elimination">Double Elimination</option>
                            <option value="round-robin">Round Robin</option>
                            <option value="swiss">Swiss System</option>
                            <option value="group-stage">Group Stage</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-max-teams">Max Teams</label>
                        <input type="number" id="edit-max-teams" name="maxTeams" min="2" max="128">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" name="description" rows="4" placeholder="Tournament description..."></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="edit-poster">Tournament Poster</label>
                    <div class="poster-upload-area">
                        <input type="file" id="edit-poster" name="poster" accept="image/*" style="display: none;">
                        <div class="poster-preview" id="poster-preview">
                            <div class="poster-placeholder">
                                <i class="fas fa-image"></i>
                                <p>Click to upload poster</p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="upload-poster-btn">
                            <i class="fas fa-upload"></i> Choose Image
                        </button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-tournament-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cancel Tournament Modal -->
    <div id="cancel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cancel Tournament</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Are you sure you want to cancel this tournament? This action cannot be undone and all registered teams will be notified.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary close-modal">Keep Tournament</button>
                <button class="btn btn-danger" id="confirm-cancel-btn">Yes, Cancel Tournament</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://tournament-hosting-backend.onrender.com';
        let currentTournament = null;

        // --- AUTHENTICATION & USER INFO ---
        function getSessionData() {
            const session = localStorage.getItem('earena_session') || sessionStorage.getItem('earena_session');
            try {
                return JSON.parse(session);
            } catch (error) {
                return null;
            }
        }
        
        function logout() {
            localStorage.removeItem('earena_session');
            sessionStorage.removeItem('earena_session');
            window.location.href = 'auth.html';
        }

        // --- TOURNAMENT ACTIONS ---
        function editTournamentDetails() {
            if (currentTournament) {
                populateEditForm();
                document.getElementById('edit-modal').classList.add('active');
            } else {
                alert('Tournament data not loaded yet. Please wait and try again.');
            }
        }

        function populateEditForm() {
            if (!currentTournament) return;

            document.getElementById('edit-title').value = currentTournament.title || '';
            document.getElementById('edit-game').value = currentTournament.game || '';
            document.getElementById('edit-prize-pool').value = currentTournament.prizePool || '';
            document.getElementById('edit-entry-fee').value = currentTournament.entryFee || '';
            document.getElementById('edit-max-teams').value = currentTournament.maxTeams || '';
            document.getElementById('edit-description').value = currentTournament.description || '';
            
            // Format dates for datetime-local input
            if (currentTournament.tournamentStart) {
                const startDate = new Date(currentTournament.tournamentStart);
                document.getElementById('edit-start-date').value = startDate.toISOString().slice(0, 16);
            }
            if (currentTournament.tournamentEnd) {
                const endDate = new Date(currentTournament.tournamentEnd);
                document.getElementById('edit-end-date').value = endDate.toISOString().slice(0, 16);
            }

            // Set format
            const format = currentTournament.format || currentTournament.tournamentFormat || currentTournament.gameFormat || '';
            document.getElementById('edit-format').value = format;

            // Show current poster if available
            const posterPreview = document.getElementById('poster-preview');
            if (currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl) {
                const posterUrl = currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl;
                posterPreview.innerHTML = `<img src="${posterUrl}" alt="Tournament Poster">`;
            } else {
                posterPreview.innerHTML = `<div class="poster-placeholder"><i class="fas fa-image"></i><p>Click to upload poster</p></div>`;
            }
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function saveTournamentChanges(formData) {
            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                alert('Authentication required. Please login again.');
                return false;
            }

            try {
                // Disable save button
                const saveBtn = document.getElementById('save-tournament-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionData.token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const updatedTournament = await response.json();
                    currentTournament = updatedTournament.data || updatedTournament;
                    
                    // Update the UI with new data
                    updateUIWithTournamentData();
                    hideEditModal();
                    alert('Tournament updated successfully!');
                    return true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update tournament.');
                }
            } catch (error) {
                console.error('Update tournament error:', error);
                alert('Failed to update tournament: ' + error.message);
                return false;
            } finally {
                // Re-enable save button
                const saveBtn = document.getElementById('save-tournament-btn');
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                saveBtn.disabled = false;
            }
        }

        function updateUIWithTournamentData() {
            if (!currentTournament) return;

            // Update page content
            document.getElementById('tournament-title').textContent = currentTournament.title;
            document.getElementById('breadcrumb-tournament-name').textContent = currentTournament.title;
            document.getElementById('tournament-game').textContent = currentTournament.game;
            document.getElementById('info-status').textContent = currentTournament.status.charAt(0).toUpperCase() + currentTournament.status.slice(1);
            document.getElementById('info-prize').textContent = `₹${(currentTournament.prizePool || 0).toLocaleString()}`;
            document.getElementById('info-fee').textContent = `₹${(currentTournament.entryFee || 0).toLocaleString()} per team`;
            document.getElementById('info-start-date').textContent = new Date(currentTournament.tournamentStart).toLocaleDateString();
            document.getElementById('info-end-date').textContent = new Date(currentTournament.tournamentEnd).toLocaleDateString();
            
            const format = currentTournament.format || currentTournament.tournamentFormat || currentTournament.gameFormat || 'Not specified';
            document.getElementById('info-format').textContent = format;

            // Update poster
            const posterElement = document.getElementById('tournament-poster');
            if (currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl) {
                const posterUrl = currentTournament.poster || currentTournament.thumbnailUrl || currentTournament.imageUrl;
                posterElement.innerHTML = `<img src="${posterUrl}" alt="Tournament Poster" onerror="this.parentElement.innerHTML='<div class=\\'poster-placeholder\\'><i class=\\'fas fa-image\\'></i><br>Failed to load poster</div>'">`;
            }
        }

        function manageBrackets() {
            if (currentTournament) {
                // Redirect to brackets management page
                window.location.href = `tournament-brackets.html?id=${currentTournament._id}`;
            } else {
                alert('Tournament data not loaded yet. Please wait and try again.');
            }
        }

        function showCancelModal() {
            document.getElementById('cancel-modal').classList.add('active');
        }

        function hideCancelModal() {
            document.getElementById('cancel-modal').classList.remove('active');
        }

        async function cancelTournament() {
            if (!currentTournament) {
                alert('Tournament data not loaded yet. Please wait and try again.');
                return;
            }

            const sessionData = getSessionData();
            if (!sessionData || !sessionData.token) {
                alert('Authentication required. Please login again.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/tournaments/${currentTournament._id}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionData.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Tournament has been cancelled successfully.');
                    hideCancelModal();
                    // Reload the page to reflect changes
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to cancel tournament.');
                }
            } catch (error) {
                console.error('Cancel tournament error:', error);
                alert('Failed to cancel tournament: ' + error.message);
            }
        }

        // --- DATA LOADING ---
        async function loadTournamentDetails(tournamentSlug, token) {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            try {
                const tournamentResponse = await fetch(`${API_BASE_URL}/api/tournaments/slug/${tournamentSlug}`, { headers });
                
                if (!tournamentResponse.ok) {
                    if (tournamentResponse.status === 404) {
                        throw new Error('Tournament not found. Please check the slug.');
                    }
                    throw new Error('Failed to fetch tournament data.');
                }
                
                const t = (await tournamentResponse.json()).data;
                currentTournament = t; // Store tournament data globally

                // Populate UI with tournament details
                document.getElementById('tournament-title').textContent = t.title;
                document.getElementById('breadcrumb-tournament-name').textContent = t.title;
                document.getElementById('tournament-game').textContent = t.game;
                document.getElementById('info-status').textContent = t.status.charAt(0).toUpperCase() + t.status.slice(1);
                document.getElementById('info-prize').textContent = `₹${(t.prizePool || 0).toLocaleString()}`;
                document.getElementById('info-fee').textContent = `₹${(t.entryFee || 0).toLocaleString()} per team`;
                document.getElementById('info-start-date').textContent = new Date(t.tournamentStart).toLocaleDateString();
                document.getElementById('info-end-date').textContent = new Date(t.tournamentEnd).toLocaleDateString();
                document.getElementById('info-tournament-id').textContent = t._id;
                
                // Handle format - try multiple possible field names
                const format = t.format || t.tournamentFormat || t.gameFormat || 'Not specified';
                document.getElementById('info-format').textContent = format;

                // Handle tournament poster
                const posterElement = document.getElementById('tournament-poster');
                if (t.poster || t.thumbnailUrl || t.imageUrl) {
                    const posterUrl = t.poster || t.thumbnailUrl || t.imageUrl;
                    posterElement.innerHTML = `<img src="${posterUrl}" alt="Tournament Poster" onerror="this.parentElement.innerHTML='<div class=\\'poster-placeholder\\'><i class=\\'fas fa-image\\'></i><br>Failed to load poster</div>'">`;
                } else {
                    posterElement.innerHTML = `<div class="poster-placeholder"><i class="fas fa-image"></i><br>No poster available</div>`;
                }

                // Handle team count
                document.getElementById('team-count-display').textContent = `(${(t.participants?.length || 0)}/${t.maxTeams})`;

                const teamsContainer = document.getElementById('teams-list-container');
                const teams = t.participants || [];

                if (teams.length === 0) {
                    teamsContainer.innerHTML = `<div class="empty-state">No teams have registered for this tournament yet.</div>`;
                    return;
                }

                teamsContainer.innerHTML = teams.map(team => `
                    <div class="team-item" data-team-id="${team._id}">
                        <div class="team-header">
                            <span class="team-name">${team.name || 'Unnamed Team'}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="team-players">
                            <div class="players-list">
                                ${team.players.map(player => `
                                    <div class="player-item">
                                        <span class="player-name">${player.username || 'Unknown Player'}</span>
                                        <span class="player-id">${player._id}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load tournament details:', error);
                document.getElementById('tournament-title').textContent = 'Error';
                document.getElementById('tournament-game').textContent = error.message;
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const sessionData = getSessionData();
            if (sessionData && sessionData.user) {
                document.getElementById('admin-username').textContent = sessionData.user.username;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const tournamentSlug = urlParams.get('slug'); 
            const authToken = sessionData ? sessionData.token : null;

            if (tournamentSlug) {
                loadTournamentDetails(tournamentSlug, authToken);
            } else {
                document.getElementById('tournament-title').textContent = 'No Tournament Specified';
                document.getElementById('tournament-game').textContent = 'Please provide a tournament slug in the URL (e.g., td.html?slug=your-tournament-name).';
            }

            // Button event listeners
            document.getElementById('edit-details-btn').addEventListener('click', editTournamentDetails);
            document.getElementById('manage-brackets-btn').addEventListener('click', manageBrackets);
            document.getElementById('cancel-tournament-btn').addEventListener('click', showCancelModal);
            document.getElementById('confirm-cancel-btn').addEventListener('click', cancelTournament);

            // Modal close event listeners
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.target.id === 'close-edit-modal') {
                        hideEditModal();
                    } else {
                        hideCancelModal();
                    }
                });
            });

            // Close modals when clicking outside
            document.getElementById('cancel-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    hideCancelModal();
                }
            });

            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    hideEditModal();
                }
            });

            // Poster upload functionality
            document.getElementById('upload-poster-btn').addEventListener('click', () => {
                document.getElementById('edit-poster').click();
            });

            document.getElementById('poster-preview').addEventListener('click', () => {
                document.getElementById('edit-poster').click();
            });

            document.getElementById('edit-poster').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select a valid image file.');
                        return;
                    }

                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB.');
                        return;
                    }

                    // Preview the image
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('poster-preview').innerHTML = 
                            `<img src="${e.target.result}" alt="Tournament Poster Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submission
            document.getElementById('edit-tournament-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData();
                const form = e.target;
                
                // Add all form fields to FormData
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'file') {
                        if (input.files[0]) {
                            formData.append(input.name, input.files[0]);
                        }
                    } else {
                        formData.append(input.name, input.value);
                    }
                });

                await saveTournamentChanges(formData);
            });
        });

        // Team accordion functionality
        document.getElementById('teams-list-container').addEventListener('click', function(event) {
            const header = event.target.closest('.team-header');
            if (header) {
                const item = header.parentElement;
                item.classList.toggle('open');
            }
        });

    </script>
</body>

</html>